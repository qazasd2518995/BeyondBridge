<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeyondBridge Admin | 管理後台</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Noto+Serif+TC:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 品牌主色 - 橄欖綠系列 */
            --olive-deep: #3D4A2D;
            --olive: #4A5D23;
            --olive-light: #6B7F3A;
            --olive-muted: rgba(74, 93, 35, 0.1);

            /* 輔助色 - 赤土系列 */
            --terracotta: #C17A5E;
            --terracotta-light: #D4967D;
            --terracotta-muted: rgba(193, 122, 94, 0.1);

            /* 中性色 - 奶油/沙色系列 */
            --cream: #F7F3EB;
            --cream-dark: #EDE6D6;
            --sand: #D4C5A9;
            --sage: #A8B89A;

            /* 文字色 */
            --charcoal: #2C2C2C;
            --gray-50: #fafafa;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #6c757d;
            --gray-600: #4A5568;
            --gray-800: #343a40;

            /* 語義色 */
            --success: #48BB78;
            --warning: #ECC94B;
            --danger: #F56565;
            --info: #4299E1;

            /* 圓角規範 */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;

            /* 陰影規範 */
            --shadow-sm: 0 2px 8px rgba(61, 74, 45, 0.06);
            --shadow-md: 0 8px 25px rgba(61, 74, 45, 0.08);
            --shadow-lg: 0 16px 40px rgba(61, 74, 45, 0.12);
            --shadow-hover: 0 12px 30px rgba(74, 93, 35, 0.15);
            --shadow-card: 0 4px 20px rgba(61, 74, 45, 0.08);

            /* 動畫規範 */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);

            /* 字體規範 */
            --font-display: 'Cormorant Garamond', 'Noto Serif TC', serif;
            --font-heading: 'Noto Serif TC', serif;
            --font-body: 'Noto Sans TC', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--cream) 0%, var(--cream-dark) 100%);
            color: var(--charcoal);
            min-height: 100vh;
        }

        /* Layout */
        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - 精緻漸層設計 */
        .admin-sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--olive-deep) 0%, #2D3A1F 50%, #1F2815 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .admin-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .admin-logo {
            padding: 1.75rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            position: relative;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 100%);
        }

        .admin-logo h1 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            background: linear-gradient(135deg, #fff 0%, var(--sage) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-logo span {
            font-size: 0.75rem;
            opacity: 0.6;
            display: block;
            margin-top: 0.35rem;
            letter-spacing: 0.05em;
        }

        .admin-nav {
            padding: 1.25rem 0;
            position: relative;
        }

        .nav-section {
            padding: 0.75rem 1.5rem 0.5rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            opacity: 0.4;
            margin-top: 1.25rem;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.875rem 1.5rem;
            color: rgba(255,255,255,0.75);
            text-decoration: none;
            transition: var(--transition-base);
            cursor: pointer;
            position: relative;
            margin: 0.125rem 0.75rem;
            border-radius: var(--radius-md);
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%) scaleY(0);
            width: 3px;
            height: 60%;
            background: linear-gradient(180deg, var(--terracotta) 0%, var(--terracotta-light) 100%);
            border-radius: 0 2px 2px 0;
            transition: var(--transition-base);
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.08);
            color: white;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(193, 122, 94, 0.2) 0%, rgba(193, 122, 94, 0.1) 100%);
            color: white;
        }

        .nav-item.active::before {
            transform: translateY(-50%) scaleY(1);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            opacity: 0.85;
            transition: var(--transition-fast);
        }

        .nav-item:hover svg {
            opacity: 1;
            transform: scale(1.1);
        }

        .nav-badge {
            margin-left: auto;
            background: linear-gradient(135deg, var(--terracotta) 0%, var(--terracotta-light) 100%);
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(193, 122, 94, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* 側邊欄底部裝飾 */
        .admin-sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            background: linear-gradient(0deg, rgba(0,0,0,0.3) 0%, transparent 100%);
        }

        .admin-sidebar-footer svg {
            width: 100%;
            height: 40px;
            opacity: 0.1;
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 280px;
            padding: 2rem 2.5rem;
            min-height: 100vh;
        }

        /* Header */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            animation: fadeSlideDown 0.5s ease;
        }

        @keyframes fadeSlideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .admin-header h2 {
            font-family: var(--font-heading);
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--olive-deep);
            position: relative;
        }

        .admin-header h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, var(--terracotta) 0%, var(--terracotta-light) 100%);
            border-radius: 2px;
        }

        .admin-header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Stats Cards - 統計卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(212, 197, 169, 0.3);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
            animation: cardReveal 0.6s ease backwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        @keyframes cardReveal {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--olive) 0%, var(--olive-light) 100%);
            opacity: 0;
            transition: var(--transition-base);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--sand);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
        }

        .stat-icon {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .stat-icon.users {
            background: linear-gradient(135deg, var(--olive-muted) 0%, rgba(107, 127, 58, 0.15) 100%);
            color: var(--olive);
        }
        .stat-icon.resources {
            background: linear-gradient(135deg, var(--terracotta-muted) 0%, rgba(212, 150, 125, 0.15) 100%);
            color: var(--terracotta);
        }
        .stat-icon.licenses {
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.1) 0%, rgba(66, 153, 225, 0.15) 100%);
            color: var(--info);
        }
        .stat-icon.pending {
            background: linear-gradient(135deg, rgba(236, 201, 75, 0.1) 0%, rgba(236, 201, 75, 0.15) 100%);
            color: var(--warning);
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--charcoal);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-500);
            margin-top: 0.35rem;
        }

        .stat-trend {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        .stat-trend.up {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success);
        }
        .stat-trend.down {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(212, 197, 169, 0.2);
            transition: var(--transition-base);
            overflow: hidden;
            animation: cardReveal 0.6s ease backwards;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--sand);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--cream-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--cream) 0%, rgba(247, 243, 235, 0.5) 100%);
        }

        .card-header h3 {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--olive-deep);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Table - 表格優化 */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th, .data-table td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid var(--cream-dark);
        }

        .data-table th {
            font-weight: 600;
            color: var(--olive-deep);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--cream) 0%, var(--cream-dark) 100%);
        }

        .data-table th:first-child {
            border-radius: var(--radius-md) 0 0 0;
        }

        .data-table th:last-child {
            border-radius: 0 var(--radius-md) 0 0;
        }

        .data-table tbody tr {
            transition: var(--transition-fast);
        }

        .data-table tbody tr:hover {
            background: linear-gradient(90deg, var(--olive-muted) 0%, transparent 100%);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Buttons - 按鈕優化 */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--olive) 0%, var(--olive-deep) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 93, 35, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 93, 35, 0.35);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--cream-dark) 0%, var(--sand) 100%);
            color: var(--olive-deep);
            border: 1px solid var(--sand);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--sand) 0%, var(--cream-dark) 100%);
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.4rem 0.875rem;
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
        }

        /* Status Badge - 狀態標籤優化 */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.875rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-badge.active, .status-badge.published {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.15) 0%, rgba(72, 187, 120, 0.1) 100%);
            color: var(--success);
        }
        .status-badge.pending, .status-badge.draft {
            background: linear-gradient(135deg, rgba(236, 201, 75, 0.15) 0%, rgba(236, 201, 75, 0.1) 100%);
            color: #B7791F;
        }
        .status-badge.expired, .status-badge.rejected, .status-badge.archived {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.15) 0%, rgba(245, 101, 101, 0.1) 100%);
            color: var(--danger);
        }

        /* User Avatar */
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--sage);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--olive-deep);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-name { font-weight: 500; }
        .user-email { font-size: 0.8rem; color: var(--gray-500); }

        /* Activity List */
        .activity-list { list-style: none; }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .activity-item:last-child { border-bottom: none; }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.new-user { background: rgba(40,167,69,0.1); color: var(--success); }
        .activity-icon.license { background: rgba(23,162,184,0.1); color: var(--info); }
        .activity-icon.resource { background: rgba(193,122,94,0.1); color: var(--terracotta); }

        .activity-content { flex: 1; }
        .activity-text { font-size: 0.9rem; }
        .activity-time { font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem; }

        /* Views */
        .admin-view { display: none; }
        .admin-view.active { display: block; }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        /* Login - 登入頁面優化 */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--cream) 0%, var(--cream-dark) 50%, var(--sage) 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%234A5D23' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            animation: float 60s linear infinite;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-50px, -50px) rotate(360deg); }
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            position: relative;
            animation: loginSlideUp 0.6s ease;
            border: 1px solid rgba(212, 197, 169, 0.3);
        }

        @keyframes loginSlideUp {
            from { opacity: 0; transform: translateY(40px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--olive) 0%, var(--terracotta) 50%, var(--olive-light) 100%);
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
        }

        .login-box h2 {
            font-family: var(--font-display);
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--olive-deep);
            font-size: 1.75rem;
        }

        .login-box p {
            text-align: center;
            color: var(--gray-500);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--olive-deep);
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--sand);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: var(--font-body);
            transition: var(--transition-fast);
            background: var(--cream);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--olive);
            background: white;
            box-shadow: 0 0 0 4px var(--olive-muted);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--olive) 0%, var(--olive-deep) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-base);
            box-shadow: 0 4px 15px rgba(74, 93, 35, 0.3);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 93, 35, 0.4);
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .error-message {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(245, 101, 101, 0.05) 100%);
            color: var(--danger);
            padding: 0.875rem 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            display: none;
            border-left: 3px solid var(--danger);
            font-size: 0.9rem;
        }

        /* Quick Actions - 快捷操作優化 */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .quick-action-btn {
            padding: 1.25rem 1rem;
            background: linear-gradient(135deg, var(--cream) 0%, white 100%);
            border: 2px solid var(--sand);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--olive) 0%, var(--olive-light) 100%);
            transform: scaleX(0);
            transition: var(--transition-base);
        }

        .quick-action-btn:hover {
            background: white;
            border-color: var(--olive);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .quick-action-btn:hover::before {
            transform: scaleX(1);
        }

        .quick-action-btn svg {
            width: 28px;
            height: 28px;
            margin-bottom: 0.75rem;
            color: var(--olive);
            transition: var(--transition-base);
        }

        .quick-action-btn:hover svg {
            transform: scale(1.15);
            color: var(--terracotta);
        }

        .quick-action-btn span {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--olive-deep);
        }

        /* Modal - Modal 優化 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(61, 74, 45, 0.4);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(212, 197, 169, 0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 1.5rem 1.75rem;
            border-bottom: 1px solid var(--cream-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--cream) 0%, rgba(247, 243, 235, 0.5) 100%);
            position: relative;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--olive) 0%, var(--terracotta) 50%, var(--olive-light) 100%);
        }

        .modal-header h3 {
            font-family: var(--font-heading);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--olive-deep);
        }

        .modal-close {
            background: var(--cream-dark);
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            font-size: 1.25rem;
            color: var(--gray-500);
        }

        .modal-close:hover {
            background: var(--sand);
            color: var(--olive-deep);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 1.75rem;
        }

        .modal-footer {
            padding: 1.25rem 1.75rem;
            border-top: 1px solid var(--cream-dark);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background: linear-gradient(0deg, var(--cream) 0%, transparent 100%);
        }

        /* Chat Styles */
        @keyframes typing { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Admin Panel Chat Styles - 管理員視角：管理員在右邊，用戶在左邊 */
        .chat-message { display: flex; margin-bottom: 1rem; animation: slideIn 0.2s ease; }
        .chat-message.admin { justify-content: flex-end; }
        .chat-message.user, .chat-message.system { justify-content: flex-start; }
        .chat-message > div { max-width: 70%; display: inline-block; }
        .chat-bubble { display: inline-block; padding: 0.75rem 1rem; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; word-break: break-word; white-space: pre-wrap; }
        .chat-message.admin .chat-bubble { background: var(--olive); color: white; border-bottom-right-radius: 4px; }
        .chat-message.user .chat-bubble { background: var(--gray-100); color: var(--gray-800); border-bottom-left-radius: 4px; }
        .chat-message.system .chat-bubble { background: var(--gray-100); color: var(--gray-500); font-size: 0.85rem; text-align: center; margin: 0 auto; }
        .chat-time { font-size: 0.75rem; color: var(--gray-400); margin-top: 0.25rem; }
        .chat-message.admin .chat-time { text-align: right; }
        .chat-sender { font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.25rem; font-weight: 500; }

        .queue-item { padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--gray-100); }
        .queue-item:hover { background: var(--gray-50); }
        .queue-item.active { background: var(--olive-light); border-left: 3px solid var(--olive); }
        .queue-item .queue-user { font-weight: 500; font-size: 0.9rem; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .queue-item .queue-preview { font-size: 0.8rem; color: var(--gray-500); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .queue-item .queue-time { font-size: 0.75rem; color: var(--gray-400); }
        .queue-item .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .queue-item .status-dot.waiting { background: var(--warning); }
        .queue-item .status-dot.active { background: var(--success); }
        .queue-item .status-dot.closed { background: var(--gray-400); }

        /* Analytics Dashboard Styles */
        .analytics-metrics {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        .metric-card .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--olive-deep);
            margin-bottom: 0.25rem;
        }
        .metric-card .metric-label {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }
        .metric-card .metric-trend {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            display: inline-block;
        }
        .metric-card .metric-trend.up {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }
        .metric-card .metric-trend.down {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        .metric-card .metric-trend.neutral {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }
        .analytics-charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .chart-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--charcoal);
        }
        .chart-container {
            position: relative;
            height: 250px;
        }
        .analytics-bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .top-resources-table {
            width: 100%;
            border-collapse: collapse;
        }
        .top-resources-table th,
        .top-resources-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        .top-resources-table th {
            font-weight: 500;
            color: var(--gray-500);
            font-size: 0.8rem;
        }
        .top-resources-table tr:hover {
            background: var(--gray-100);
        }
        .support-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .support-stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--gray-100);
            border-radius: 8px;
        }
        .support-stat-item .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--olive-deep);
        }
        .support-stat-item .stat-label {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }
        @media (max-width: 1200px) {
            .analytics-metrics { grid-template-columns: repeat(3, 1fr); }
            .analytics-charts { grid-template-columns: 1fr; }
            .analytics-bottom { grid-template-columns: 1fr; }
        }

        /* ==================== 確認對話框組件 ==================== */
        .confirm-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(44, 44, 44, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .confirm-dialog-overlay.active {
            display: flex;
            opacity: 1;
        }

        .confirm-dialog {
            background: white;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: confirmDialogIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        @keyframes confirmDialogIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .confirm-dialog-header {
            padding: 1.5rem 1.5rem 0;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .confirm-dialog-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .confirm-dialog-icon svg {
            width: 24px;
            height: 24px;
        }

        .confirm-dialog.warning .confirm-dialog-icon {
            background: rgba(236, 201, 75, 0.15);
            color: #B7791F;
        }

        .confirm-dialog.danger .confirm-dialog-icon {
            background: rgba(245, 101, 101, 0.15);
            color: var(--danger);
        }

        .confirm-dialog.info .confirm-dialog-icon {
            background: rgba(66, 153, 225, 0.15);
            color: var(--info);
        }

        .confirm-dialog-content {
            flex: 1;
        }

        .confirm-dialog-title {
            font-family: var(--font-heading);
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
        }

        .confirm-dialog-message {
            font-size: 0.9rem;
            color: var(--gray-600);
            line-height: 1.6;
        }

        .confirm-dialog-body {
            padding: 1.25rem 1.5rem;
        }

        .confirm-dialog-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            transition: var(--transition-fast);
            font-family: var(--font-body);
        }

        .confirm-dialog-input:focus {
            outline: none;
            border-color: var(--olive);
            box-shadow: 0 0 0 3px var(--olive-muted);
        }

        .confirm-dialog-input.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(245, 101, 101, 0.1);
        }

        .confirm-dialog-hint {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
        }

        .confirm-dialog-footer {
            padding: 1rem 1.5rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .confirm-dialog-btn {
            padding: 0.6rem 1.25rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            border: none;
            font-family: var(--font-body);
        }

        .confirm-dialog-btn-cancel {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .confirm-dialog-btn-cancel:hover {
            background: var(--gray-200);
            color: var(--charcoal);
        }

        .confirm-dialog-btn-confirm {
            background: var(--olive);
            color: white;
        }

        .confirm-dialog-btn-confirm:hover {
            background: var(--olive-deep);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .confirm-dialog.danger .confirm-dialog-btn-confirm {
            background: var(--danger);
        }

        .confirm-dialog.danger .confirm-dialog-btn-confirm:hover {
            background: #E53E3E;
        }

        .confirm-dialog.warning .confirm-dialog-btn-confirm {
            background: #D69E2E;
        }

        .confirm-dialog.warning .confirm-dialog-btn-confirm:hover {
            background: #B7791F;
        }

        .confirm-dialog-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ==================== 麵包屑導航 ==================== */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 0;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-500);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .breadcrumb-item:hover {
            color: var(--olive);
        }

        .breadcrumb-item.active {
            color: var(--charcoal);
            font-weight: 500;
            cursor: default;
        }

        .breadcrumb-item.active:hover {
            color: var(--charcoal);
        }

        .breadcrumb-separator {
            color: var(--gray-300);
            font-size: 0.75rem;
        }

        .breadcrumb-home-icon {
            width: 16px;
            height: 16px;
        }

        /* 頁面標題區域優化 */
        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .view-header-left {
            flex: 1;
        }

        .view-header-title {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--charcoal);
            margin: 0;
        }

        .view-header-subtitle {
            font-size: 0.9rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .view-header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* ==================== 表格批量操作 ==================== */
        .batch-toolbar {
            display: none;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--olive-muted) 0%, rgba(74, 93, 35, 0.05) 100%);
            border: 1px solid var(--olive-light);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            animation: slideDown 0.2s ease;
        }

        .batch-toolbar.active {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .batch-toolbar-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--olive-deep);
        }

        .batch-toolbar-info .count {
            font-weight: 600;
            color: var(--olive);
        }

        .batch-toolbar-actions {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .batch-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.875rem;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            font-family: var(--font-body);
        }

        .batch-btn svg {
            width: 14px;
            height: 14px;
        }

        .batch-btn-primary {
            background: var(--olive);
            color: white;
        }

        .batch-btn-primary:hover {
            background: var(--olive-deep);
            transform: translateY(-1px);
        }

        .batch-btn-secondary {
            background: white;
            color: var(--gray-600);
            border: 1px solid var(--gray-300);
        }

        .batch-btn-secondary:hover {
            background: var(--gray-100);
            border-color: var(--gray-400);
        }

        .batch-btn-danger {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
            border: 1px solid rgba(245, 101, 101, 0.3);
        }

        .batch-btn-danger:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .batch-btn-clear {
            background: transparent;
            color: var(--gray-500);
            padding: 0.4rem 0.6rem;
        }

        .batch-btn-clear:hover {
            color: var(--charcoal);
            background: rgba(0, 0, 0, 0.05);
        }

        /* 表格選擇框樣式 */
        .table-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--olive);
        }

        .table-checkbox-cell {
            width: 40px;
            text-align: center;
        }

        /* 選中行樣式 */
        tr.selected {
            background: var(--olive-muted) !important;
        }

        tr.selected:hover {
            background: rgba(74, 93, 35, 0.15) !important;
        }

        /* 全選框容器 */
        .select-all-container {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ==================== 可排序表頭 ==================== */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: var(--transition-fast);
        }

        .sortable-header:hover {
            color: var(--olive);
        }

        .sortable-header .sort-wrapper {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .sortable-header .sort-icon {
            width: 14px;
            height: 14px;
            opacity: 0.3;
            transition: var(--transition-fast);
        }

        .sortable-header:hover .sort-icon {
            opacity: 0.6;
        }

        .sortable-header.sort-asc .sort-icon,
        .sortable-header.sort-desc .sort-icon {
            opacity: 1;
            color: var(--olive);
        }

        .sortable-header.sort-desc .sort-icon {
            transform: rotate(180deg);
        }

        /* ==================== 進階篩選面板 ==================== */
        .filter-panel {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin-bottom: 1rem;
            display: none;
            animation: slideDown 0.2s ease;
        }

        .filter-panel.active {
            display: block;
        }

        .filter-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-100);
        }

        .filter-panel-title {
            font-weight: 600;
            color: var(--charcoal);
            font-size: 0.95rem;
        }

        .filter-panel-actions {
            display: flex;
            gap: 0.5rem;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .filter-group label {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-600);
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            transition: var(--transition-fast);
            font-family: var(--font-body);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--olive);
            box-shadow: 0 0 0 2px var(--olive-muted);
        }

        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-100);
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.6rem;
            background: var(--olive-muted);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--olive-deep);
        }

        .filter-tag-remove {
            cursor: pointer;
            opacity: 0.6;
            transition: var(--transition-fast);
        }

        .filter-tag-remove:hover {
            opacity: 1;
        }

        .filter-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.875rem;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition-fast);
            font-family: var(--font-body);
        }

        .filter-toggle-btn:hover {
            border-color: var(--olive);
            color: var(--olive);
        }

        .filter-toggle-btn.active {
            background: var(--olive-muted);
            border-color: var(--olive);
            color: var(--olive);
        }

        .filter-toggle-btn svg {
            width: 16px;
            height: 16px;
        }

        .active-filter-count {
            background: var(--olive);
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            margin-left: 0.25rem;
        }

        /* ==================== 實時表單驗證 ==================== */
        .form-input-wrapper {
            position: relative;
        }

        .form-input.validating {
            padding-right: 2.5rem;
        }

        .form-input.valid {
            border-color: var(--success);
        }

        .form-input.valid:focus {
            box-shadow: 0 0 0 3px rgba(72, 187, 120, 0.1);
        }

        .form-input.invalid {
            border-color: var(--danger);
        }

        .form-input.invalid:focus {
            box-shadow: 0 0 0 3px rgba(245, 101, 101, 0.1);
        }

        .validation-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            display: none;
        }

        .form-input.valid + .validation-icon.success,
        .form-input.invalid + .validation-icon.error {
            display: block;
        }

        .validation-icon.success {
            color: var(--success);
        }

        .validation-icon.error {
            color: var(--danger);
        }

        .validation-message {
            font-size: 0.8rem;
            margin-top: 0.35rem;
            display: none;
        }

        .validation-message.error {
            color: var(--danger);
            display: block;
        }

        .validation-message.hint {
            color: var(--gray-500);
            display: block;
        }

        /* 密碼強度指示器 */
        .password-strength {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .password-strength-bar {
            flex: 1;
            height: 4px;
            background: var(--gray-200);
            border-radius: 2px;
            transition: var(--transition-fast);
        }

        .password-strength.weak .password-strength-bar:nth-child(1) {
            background: var(--danger);
        }

        .password-strength.medium .password-strength-bar:nth-child(1),
        .password-strength.medium .password-strength-bar:nth-child(2) {
            background: var(--warning);
        }

        .password-strength.strong .password-strength-bar:nth-child(1),
        .password-strength.strong .password-strength-bar:nth-child(2),
        .password-strength.strong .password-strength-bar:nth-child(3) {
            background: var(--success);
        }

        .password-strength-text {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .password-strength.weak .password-strength-text {
            color: var(--danger);
        }

        .password-strength.medium .password-strength-text {
            color: var(--warning);
        }

        .password-strength.strong .password-strength-text {
            color: var(--success);
        }

        /* ==================== 增強統計卡片 ==================== */
        .stat-card-enhanced {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(212, 197, 169, 0.2);
            box-shadow: var(--shadow-card);
            transition: var(--transition-base);
        }

        .stat-card-enhanced:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card-enhanced .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-card-enhanced .stat-icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
        }

        .stat-card-enhanced:hover .stat-icon-wrapper {
            transform: scale(1.1);
        }

        .stat-card-enhanced .stat-icon-wrapper.users { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .stat-card-enhanced .stat-icon-wrapper.courses { background: rgba(168, 184, 154, 0.2); color: var(--olive); }
        .stat-card-enhanced .stat-icon-wrapper.resources { background: rgba(193, 122, 94, 0.1); color: var(--terracotta); }
        .stat-card-enhanced .stat-icon-wrapper.active { background: rgba(72, 187, 120, 0.1); color: var(--success); }

        .stat-card-enhanced .stat-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
        }

        .stat-card-enhanced .stat-trend.up {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success);
        }

        .stat-card-enhanced .stat-trend.down {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        .stat-card-enhanced .stat-trend svg {
            width: 12px;
            height: 12px;
        }

        .stat-card-enhanced .stat-content {
            margin-bottom: 0.75rem;
        }

        .stat-card-enhanced .stat-value {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 600;
            color: var(--charcoal);
            line-height: 1.2;
        }

        .stat-card-enhanced .stat-label {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .stat-card-enhanced .stat-sparkline {
            height: 40px;
            margin-top: 0.5rem;
        }

        .stat-card-enhanced .stat-sparkline svg {
            width: 100%;
            height: 100%;
        }

        .stat-card-enhanced .stat-sparkline path {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .stat-card-enhanced .stat-sparkline .sparkline-area {
            opacity: 0.1;
        }

        .stat-card-enhanced.users .stat-sparkline path { stroke: #3b82f6; }
        .stat-card-enhanced.users .stat-sparkline .sparkline-area { fill: #3b82f6; }
        .stat-card-enhanced.courses .stat-sparkline path { stroke: var(--olive); }
        .stat-card-enhanced.courses .stat-sparkline .sparkline-area { fill: var(--olive); }
        .stat-card-enhanced.resources .stat-sparkline path { stroke: var(--terracotta); }
        .stat-card-enhanced.resources .stat-sparkline .sparkline-area { fill: var(--terracotta); }
        .stat-card-enhanced.active .stat-sparkline path { stroke: var(--success); }
        .stat-card-enhanced.active .stat-sparkline .sparkline-area { fill: var(--success); }

        /* 快速操作區域優化 */
        .dashboard-quick-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .quick-action-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
            border: 1px solid var(--gray-100);
        }

        .quick-action-card:hover {
            background: var(--olive-muted);
            border-color: var(--olive-light);
            transform: translateY(-2px);
        }

        .quick-action-card svg {
            width: 32px;
            height: 32px;
            color: var(--olive);
            margin-bottom: 0.75rem;
        }

        .quick-action-card span {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--charcoal);
        }

        /* 即時狀態指示器 */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            background: rgba(72, 187, 120, 0.1);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--success);
            font-weight: 500;
        }

        .live-indicator .pulse {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: livePulse 2s ease-in-out infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        /* ========================================
           系統監控視圖樣式
           ======================================== */
        .system-status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .system-status-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid var(--gray-100);
            transition: var(--transition-base);
        }

        .system-status-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .status-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .status-icon.healthy {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success);
        }

        .status-icon.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-icon.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-info {
            flex: 1;
        }

        .status-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .status-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .status-value.healthy { color: var(--success); }
        .status-value.warning { color: var(--warning); }
        .status-value.error { color: var(--danger); }

        .system-metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .resource-meter {
            margin-bottom: 1.5rem;
        }

        .resource-meter:last-child {
            margin-bottom: 0;
        }

        .meter-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .meter-bar {
            height: 8px;
            background: var(--gray-100);
            border-radius: 4px;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--olive), var(--olive-light));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .meter-fill.warning {
            background: linear-gradient(90deg, var(--warning), #fbbf24);
        }

        .meter-fill.danger {
            background: linear-gradient(90deg, var(--danger), #f87171);
        }

        .meter-detail {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .uptime-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .error-log-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .error-log-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
            border-left: 3px solid;
        }

        .error-log-item.error { border-left-color: var(--danger); }
        .error-log-item.warning { border-left-color: var(--warning); }
        .error-log-item.info { border-left-color: #3b82f6; }

        .error-log-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .error-log-item.error .error-log-icon { color: var(--danger); }
        .error-log-item.warning .error-log-icon { color: var(--warning); }
        .error-log-item.info .error-log-icon { color: #3b82f6; }

        .error-log-content {
            flex: 1;
            min-width: 0;
        }

        .error-log-message {
            font-size: 0.875rem;
            color: var(--charcoal);
            margin-bottom: 0.25rem;
        }

        .error-log-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .toggle-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--gray-200);
            border-radius: 12px;
            transition: var(--transition-base);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: var(--transition-base);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--olive);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }

        /* ========================================
           數據匯出視圖樣式
           ======================================== */
        .export-options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .export-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
            border: 2px solid var(--gray-100);
        }

        .export-card:hover {
            border-color: var(--olive);
            background: var(--olive-muted);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }

        .export-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background: var(--olive-muted);
            color: var(--olive);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            transition: var(--transition-base);
        }

        .export-card:hover .export-icon {
            background: var(--olive);
            color: white;
        }

        .export-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
        }

        .export-card p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .export-formats {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .format-badge {
            padding: 0.25rem 0.75rem;
            background: var(--gray-100);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .export-card:hover .format-badge {
            background: rgba(168, 184, 154, 0.3);
            color: var(--olive);
        }

        /* ========================================
           自動化規則視圖樣式
           ======================================== */
        .rule-status-toggle {
            position: relative;
            width: 40px;
            height: 22px;
        }

        .rule-status-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .rule-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gray-200);
            border-radius: 11px;
            transition: var(--transition-base);
        }

        .rule-toggle-slider::before {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            top: 3px;
            left: 3px;
            transition: var(--transition-base);
        }

        .rule-status-toggle input:checked + .rule-toggle-slider {
            background: var(--success);
        }

        .rule-status-toggle input:checked + .rule-toggle-slider::before {
            transform: translateX(18px);
        }

        .rule-type-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .rule-type-badge.auto-approve { background: rgba(72, 187, 120, 0.1); color: var(--success); }
        .rule-type-badge.auto-notify { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .rule-type-badge.auto-suspend { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .rule-type-badge.auto-archive { background: rgba(107, 114, 128, 0.1); color: var(--gray-500); }
        .rule-type-badge.scheduled { background: rgba(168, 184, 154, 0.2); color: var(--olive); }

        /* ========================================
           用戶活動分析視圖樣式
           ======================================== */
        .activity-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .activity-metric-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            border: 1px solid var(--gray-100);
        }

        .activity-metric-card .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .activity-metric-card .metric-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .activity-metric-card .metric-trend {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
        }

        .activity-metric-card .metric-trend.positive {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success);
        }

        .activity-metric-card .metric-trend.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .activity-metric-card .metric-trend.neutral {
            background: var(--gray-100);
            color: var(--text-secondary);
        }

        .activity-metric-card .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
        }

        .activity-metric-card .metric-sparkline {
            height: 40px;
        }

        .activity-charts-grid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .activity-bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .heatmap-container {
            display: grid;
            grid-template-columns: auto repeat(24, 1fr);
            gap: 2px;
            font-size: 0.7rem;
        }

        .heatmap-row-label {
            padding: 0.25rem;
            text-align: right;
            color: var(--text-secondary);
            font-size: 0.7rem;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            background: var(--gray-100);
            transition: background-color 0.2s;
        }

        .heatmap-cell:hover {
            outline: 2px solid var(--olive);
            outline-offset: 1px;
        }

        .heatmap-cell.level-0 { background: #f0f4f0; }
        .heatmap-cell.level-1 { background: #c5d5c0; }
        .heatmap-cell.level-2 { background: #9ab88f; }
        .heatmap-cell.level-3 { background: #6f9b5e; }
        .heatmap-cell.level-4 { background: var(--olive); }

        .heatmap-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-scale {
            display: flex;
            gap: 2px;
        }

        .legend-item {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* 響應式調整 */
        @media (max-width: 1200px) {
            .system-status-grid,
            .export-options-grid,
            .activity-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .system-metrics-grid,
            .activity-charts-grid,
            .activity-bottom-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .system-status-grid,
            .export-options-grid,
            .activity-metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Login View -->
    <div id="loginView" class="login-container">
        <div class="login-box">
            <h2>BeyondBridge</h2>
            <p>管理員後台登入</p>
            <div id="loginError" class="error-message"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>密碼</label>
                    <input type="password" id="loginPassword" class="form-input" required>
                </div>
                <button type="submit" class="login-btn">登入</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h1>BeyondBridge</h1>
                <span>管理後台 Admin Panel</span>
            </div>
            <nav class="admin-nav">
                <div class="nav-section">主要功能</div>
                <a class="nav-item active" data-view="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
                    </svg>
                    儀表板
                </a>
                <a class="nav-item" data-view="users">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    用戶管理
                </a>
                <a class="nav-item" data-view="resources">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                    </svg>
                    教材管理
                </a>
                <a class="nav-item" data-view="licenses">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    授權管理
                    <span class="nav-badge" id="pendingLicensesBadge">0</span>
                </a>
                <a class="nav-item" data-view="announcements">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    公告管理
                </a>
                <a class="nav-item" data-view="support">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    客服中心
                    <span class="nav-badge" id="waitingChatsBadge" style="background: var(--terracotta);">0</span>
                </a>

                <div class="nav-section">課程與學習</div>
                <a class="nav-item" data-view="courses">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                    </svg>
                    課程管理
                </a>
                <a class="nav-item" data-view="courseCategories">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    課程類別
                </a>
                <a class="nav-item" data-view="questionbank">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    題庫管理
                </a>
                <a class="nav-item" data-view="badges">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="8" r="7"/>
                        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                    </svg>
                    徽章系統
                </a>
                <a class="nav-item" data-view="learningPaths">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                    學習路徑
                </a>

                <div class="nav-section">外部整合</div>
                <a class="nav-item" data-view="scorm">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                    </svg>
                    SCORM 學習包
                </a>
                <a class="nav-item" data-view="lti">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    LTI 外部工具
                </a>
                <a class="nav-item" data-view="h5p">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 2 7 12 12 22 7 12 2"/>
                        <polyline points="2 17 12 22 22 17"/>
                        <polyline points="2 12 12 17 22 12"/>
                    </svg>
                    H5P 互動內容
                </a>

                <div class="nav-section">系統管理</div>
                <a class="nav-item" data-view="roles">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                    </svg>
                    角色權限
                </a>
                <a class="nav-item" data-view="rubrics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"/>
                        <line x1="8" y1="12" x2="21" y2="12"/>
                        <line x1="8" y1="18" x2="21" y2="18"/>
                        <line x1="3" y1="6" x2="3.01" y2="6"/>
                        <line x1="3" y1="12" x2="3.01" y2="12"/>
                        <line x1="3" y1="18" x2="3.01" y2="18"/>
                    </svg>
                    評分標準
                </a>
                <a class="nav-item" data-view="auditLogs">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <line x1="10" y1="9" x2="8" y2="9"/>
                    </svg>
                    審計日誌
                </a>

                <div class="nav-section">分析</div>
                <a class="nav-item" data-view="analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    數據分析
                </a>

                <div class="nav-section">系統工具</div>
                <a class="nav-item" data-view="systemMonitor">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line x1="8" y1="21" x2="16" y2="21"/>
                        <line x1="12" y1="17" x2="12" y2="21"/>
                        <path d="M6 10l3-3 2 2 4-4 3 3"/>
                    </svg>
                    系統監控
                </a>
                <a class="nav-item" data-view="dataExport">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    數據匯出
                </a>
                <a class="nav-item" data-view="automation">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    自動化規則
                </a>
                <a class="nav-item" data-view="userActivity">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    用戶活動分析
                </a>

                <div class="nav-section">帳戶</div>
                <a class="nav-item" id="logoutBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    登出
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Dashboard View -->
            <div id="dashboardView" class="admin-view active">
                <div class="admin-header">
                    <h2>管理員儀表板</h2>
                    <div class="admin-header-actions">
                        <span id="adminName">管理員</span>
                    </div>
                </div>

                <!-- Pending Tasks Alert -->
                <div class="admin-pending-alert" style="background: linear-gradient(135deg, var(--olive-light) 0%, #E8EAD6 100%); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border-left: 4px solid var(--olive);">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 48px; height: 48px; background: var(--olive); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--olive); margin-bottom: 2px;">待處理事項</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    <span id="pendingLicensesCount">0</span> 筆授權申請、<span id="pendingChatsCount">0</span> 則客服訊息、<span id="pendingReportsCount">0</span> 件檢舉待審
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showView('licenses')" style="white-space: nowrap;">立即處理</button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon users">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                            <span class="stat-trend up" id="userTrend">+0%</span>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">總用戶數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon resources">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12,2 2,7 12,12 22,7"/>
                                    <polyline points="2,17 12,22 22,17"/>
                                    <polyline points="2,12 12,17 22,12"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-value" id="totalCourses">0</div>
                        <div class="stat-label">開設課程</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon licenses">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-value" id="totalResources">0</div>
                        <div class="stat-label">教材資源</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon pending">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-value" id="activeUsersToday">0</div>
                        <div class="stat-label">今日活躍用戶</div>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="content-grid">
                    <!-- Left Column -->
                    <div>
                        <!-- System Overview -->
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--olive)" stroke-width="2">
                                        <line x1="18" y1="20" x2="18" y2="10"/>
                                        <line x1="12" y1="20" x2="12" y2="4"/>
                                        <line x1="6" y1="20" x2="6" y2="14"/>
                                    </svg>
                                    系統概覽
                                </h3>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                                    <div style="background: #E3F2FD; padding: 1rem; border-radius: 8px;">
                                        <div style="font-size: 0.8rem; color: #1976D2; margin-bottom: 4px;">本週新註冊</div>
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #1976D2;" id="weeklyNewUsers">0</div>
                                    </div>
                                    <div style="background: var(--olive-light); padding: 1rem; border-radius: 8px;">
                                        <div style="font-size: 0.8rem; color: var(--olive); margin-bottom: 4px;">本週新課程</div>
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--olive);" id="weeklyNewCourses">0</div>
                                    </div>
                                    <div style="background: var(--terracotta-light); padding: 1rem; border-radius: 8px;">
                                        <div style="font-size: 0.8rem; color: var(--terracotta); margin-bottom: 4px;">有效授權</div>
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--terracotta);" id="activeLicenses">0</div>
                                    </div>
                                    <div style="background: var(--sand-light); padding: 1rem; border-radius: 8px;">
                                        <div style="font-size: 0.8rem; color: var(--sand); margin-bottom: 4px;">待處理請求</div>
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--sand);" id="pendingRequests">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Users -->
                        <div class="card">
                            <div class="card-header">
                                <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--blue, #1976D2)" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                    </svg>
                                    最近註冊用戶
                                </h3>
                                <button class="btn btn-sm btn-secondary" onclick="showView('users')">查看全部</button>
                            </div>
                            <div class="card-body">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>用戶</th>
                                            <th>角色</th>
                                            <th>註冊時間</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentUsersTable">
                                        <tr><td colspan="3" class="loading">載入中...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div>
                        <!-- Quick Actions -->
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <h3>快速操作</h3>
                            </div>
                            <div class="card-body">
                                <div class="quick-actions">
                                    <div class="quick-action-btn" onclick="showView('users'); openCreateUserModal()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                            <circle cx="8.5" cy="7" r="4"/>
                                            <line x1="20" y1="8" x2="20" y2="14"/>
                                            <line x1="23" y1="11" x2="17" y2="11"/>
                                        </svg>
                                        <span>新增用戶</span>
                                    </div>
                                    <div class="quick-action-btn" onclick="showView('courses')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="12,2 2,7 12,12 22,7"/>
                                            <line x1="12" y1="12" x2="12" y2="22"/>
                                        </svg>
                                        <span>課程管理</span>
                                    </div>
                                    <div class="quick-action-btn" onclick="showView('announcements'); openCreateAnnouncementModal()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                        </svg>
                                        <span>發布公告</span>
                                    </div>
                                    <div class="quick-action-btn" onclick="showView('auditLogs')">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14 2 14 8 20 8"/>
                                            <line x1="16" y1="13" x2="8" y2="13"/>
                                            <line x1="16" y1="17" x2="8" y2="17"/>
                                        </svg>
                                        <span>審計日誌</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Alerts -->
                        <div class="card">
                            <div class="card-header">
                                <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--terracotta)" stroke-width="2">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                    系統警示
                                </h3>
                                <span id="alertCount" style="background: var(--terracotta); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">0</span>
                            </div>
                            <div class="card-body">
                                <div id="systemAlertsList">
                                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5; margin-bottom: 0.5rem;">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                            <polyline points="22 4 12 14.01 9 11.01"/>
                                        </svg>
                                        <p>系統運作正常，暫無警示</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users View -->
            <div id="usersView" class="admin-view">
                <div class="admin-header">
                    <h2>用戶管理</h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="search-box" style="position: relative;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5;">
                                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                            <input type="text" id="userSearchInput" placeholder="搜尋用戶..." style="padding: 0.5rem 1rem 0.5rem 2.5rem; border: 1px solid var(--gray-200); border-radius: 8px; width: 250px;" oninput="filterUsers()">
                        </div>
                        <button class="btn btn-primary" onclick="openCreateUserModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            新增用戶
                        </button>
                    </div>
                </div>

                <!-- 角色分類統計 -->
                <div class="role-stats" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="stat-card" onclick="filterUsersByRole('all')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid var(--olive); transition: all 0.2s;" id="roleCardAll">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">全部用戶</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: var(--olive);" id="countAll">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(74,93,35,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--olive)" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="filterUsersByRole('educator')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleCardEducator">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">建橋者</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #3b82f6;" id="countEducator">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(59,130,246,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                                    <path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="filterUsersByRole('trainer')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleCardTrainer">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">橋樑工匠</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;" id="countTrainer">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(245,158,11,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="filterUsersByRole('creator')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleCardCreator">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">知識建築師</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #8b5cf6;" id="countCreator">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(139,92,246,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="filterUsersByRole('student')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleCardStudent">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">探橋者</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;" id="countStudent">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(16,185,129,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body table-container">
                        <table class="data-table" id="usersTable">
                            <thead id="usersTableHead">
                                <tr>
                                    <th>用戶</th>
                                    <th>角色</th>
                                    <th>訂閱方案</th>
                                    <th>狀態</th>
                                    <th>註冊時間</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="6" class="loading">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Resources View -->
            <div id="resourcesView" class="admin-view">
                <div class="admin-header">
                    <h2>教材管理</h2>
                    <button class="btn btn-primary" onclick="openCreateResourceModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        新增教材
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>標題</th>
                                    <th>類型</th>
                                    <th>分類</th>
                                    <th>狀態</th>
                                    <th>瀏覽次數</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="resourcesTableBody">
                                <tr><td colspan="6" class="loading">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Licenses View -->
            <div id="licensesView" class="admin-view">
                <div class="admin-header">
                    <h2>授權管理</h2>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>資源</th>
                                    <th>用戶</th>
                                    <th>類型</th>
                                    <th>狀態</th>
                                    <th>到期日</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="licensesTableBody">
                                <tr><td colspan="6" class="loading">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Announcements View -->
            <div id="announcementsView" class="admin-view">
                <div class="admin-header">
                    <h2>公告管理</h2>
                    <button class="btn btn-primary" onclick="openCreateAnnouncementModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        新增公告
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>標題</th>
                                    <th>優先級</th>
                                    <th>狀態</th>
                                    <th>發布時間</th>
                                    <th>瀏覽次數</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="announcementsTableBody">
                                <tr><td colspan="6" class="loading">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analyticsView" class="admin-view">
                <div class="admin-header">
                    <h2>數據分析</h2>
                </div>

                <!-- Key Metrics -->
                <div class="analytics-metrics">
                    <div class="metric-card">
                        <div class="metric-value" id="metricTotalUsers">0</div>
                        <div class="metric-label">總用戶數</div>
                        <span class="metric-trend neutral" id="metricUsersTrend">--</span>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metricNewUsers">0</div>
                        <div class="metric-label">本月新增</div>
                        <span class="metric-trend neutral" id="metricNewUsersTrend">--</span>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metricResources">0</div>
                        <div class="metric-label">已發布教材</div>
                        <span class="metric-trend neutral" id="metricResourcesTrend">--</span>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metricLicenses">0</div>
                        <div class="metric-label">活躍授權</div>
                        <span class="metric-trend neutral" id="metricLicensesTrend">--</span>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metricRating">-</div>
                        <div class="metric-label">客服滿意度</div>
                        <span class="metric-trend neutral" id="metricRatingTrend">--</span>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="analytics-charts">
                    <div class="chart-card">
                        <h3>用戶成長趨勢</h3>
                        <div class="chart-container">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>用戶角色分布</h3>
                        <div class="chart-container">
                            <canvas id="userRolesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="analytics-charts">
                    <div class="chart-card">
                        <h3>教材分類分布</h3>
                        <div class="chart-container">
                            <canvas id="resourceCategoriesChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>授權狀態分布</h3>
                        <div class="chart-container">
                            <canvas id="licenseStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section -->
                <div class="analytics-bottom">
                    <div class="chart-card">
                        <h3>熱門教材 Top 5</h3>
                        <table class="top-resources-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>教材名稱</th>
                                    <th>瀏覽次數</th>
                                    <th>評分</th>
                                    <th>授權數</th>
                                </tr>
                            </thead>
                            <tbody id="topResourcesBody">
                                <tr><td colspan="5" style="text-align:center; color: var(--gray-400);">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="chart-card">
                        <h3>客服統計</h3>
                        <div class="support-stat-grid">
                            <div class="support-stat-item">
                                <div class="stat-value" id="supportTotalChats">0</div>
                                <div class="stat-label">總對話數</div>
                            </div>
                            <div class="support-stat-item">
                                <div class="stat-value" id="supportClosedChats">0</div>
                                <div class="stat-label">已結束</div>
                            </div>
                            <div class="support-stat-item">
                                <div class="stat-value" id="supportAvgRating">-</div>
                                <div class="stat-label">平均評分</div>
                            </div>
                            <div class="support-stat-item">
                                <div class="stat-value" id="supportSatisfaction">0%</div>
                                <div class="stat-label">滿意度</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support View - 客服中心 -->
            <div id="supportView" class="admin-view">
                <div class="admin-header">
                    <h2>客服中心</h2>
                    <div class="admin-header-actions">
                        <div id="adminOnlineStatus" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--success); color: white; border-radius: 20px; font-size: 0.85rem;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: white;"></span>
                            在線服務中
                        </div>
                    </div>
                </div>

                <!-- Support Stats -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="waitingChatsCount">0</div>
                        <div class="stat-label">需處理</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeChatsCount">0</div>
                        <div class="stat-label">進行中</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="closedChatsCount">0</div>
                        <div class="stat-label">已結束</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgChatRating">-</div>
                        <div class="stat-label">平均評分</div>
                    </div>
                </div>

                <!-- Support Tabs -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="support-tab active" onclick="switchSupportTab(this, 'waiting')" style="padding: 0.5rem 1.25rem; border: none; background: var(--terracotta); color: white; border-radius: 20px; cursor: pointer; font-weight: 500;">
                        需處理 <span id="waitingTabCount">(0)</span>
                    </button>
                    <button class="support-tab" onclick="switchSupportTab(this, 'active')" style="padding: 0.5rem 1.25rem; border: none; background: var(--gray-100); color: var(--gray-600); border-radius: 20px; cursor: pointer;">
                        進行中 <span id="activeTabCount">(0)</span>
                    </button>
                    <button class="support-tab" onclick="switchSupportTab(this, 'closed')" style="padding: 0.5rem 1.25rem; border: none; background: var(--gray-100); color: var(--gray-600); border-radius: 20px; cursor: pointer;">
                        已結束
                    </button>
                </div>

                <!-- Support Container -->
                <div style="display: grid; grid-template-columns: 350px 1fr; gap: 1rem; height: calc(100vh - 340px); min-height: 400px;">
                    <!-- Chat Queue -->
                    <div class="card" style="overflow: hidden; display: flex; flex-direction: column;">
                        <div class="card-header" style="padding: 1rem; border-bottom: 1px solid var(--gray-200);">
                            <h3 style="font-size: 0.95rem; font-weight: 600;">客服隊列</h3>
                        </div>
                        <div id="adminChatQueue" style="flex: 1; overflow-y: auto; padding: 0.5rem;">
                            <div style="text-align: center; padding: 2rem 1rem; color: var(--gray-400);">
                                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 0.5rem; opacity: 0.5;">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                                <p style="font-size: 0.85rem;">目前沒有等待中的對話</p>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Chat Window -->
                    <div class="card" style="overflow: hidden; display: flex; flex-direction: column;">
                        <!-- Chat Header -->
                        <div id="adminChatHeader" style="padding: 1rem; border-bottom: 1px solid var(--gray-200); display: none;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div id="adminChatUserAvatar" style="width: 40px; height: 40px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">U</div>
                                    <div>
                                        <h4 id="adminChatUserName" style="font-size: 0.95rem; font-weight: 600;">用戶</h4>
                                        <p id="adminChatUserEmail" style="font-size: 0.8rem; color: var(--gray-500);">user@example.com</p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="adminClaimChat()" id="claimChatBtn" style="padding: 0.5rem 1rem; background: var(--olive); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">接手對話</button>
                                    <button onclick="adminCloseChat()" style="padding: 0.5rem 1rem; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">結束對話</button>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div id="adminChatMessages" style="flex: 1; overflow-y: auto; padding: 1rem; background: var(--gray-50);">
                            <div id="adminChatWelcome" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: var(--gray-400);">
                                <svg viewBox="0 0 24 24" width="80" height="80" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 1rem; opacity: 0.3;">
                                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                                </svg>
                                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--gray-600);">客服工作台</h3>
                                <p style="font-size: 0.9rem; max-width: 300px;">選擇左側隊列中的對話開始服務用戶</p>
                            </div>
                        </div>

                        <!-- Admin Typing Indicator -->
                        <div id="adminTypingIndicator" style="display: none; padding: 0.5rem 1rem; background: var(--gray-50); border-top: 1px solid var(--gray-100);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--gray-500); font-size: 0.85rem;">
                                <div style="display: flex; gap: 3px;">
                                    <span style="width: 6px; height: 6px; background: var(--gray-400); border-radius: 50%; animation: typing 1s infinite;"></span>
                                    <span style="width: 6px; height: 6px; background: var(--gray-400); border-radius: 50%; animation: typing 1s infinite 0.2s;"></span>
                                    <span style="width: 6px; height: 6px; background: var(--gray-400); border-radius: 50%; animation: typing 1s infinite 0.4s;"></span>
                                </div>
                                <span id="adminTypingUser">用戶正在輸入...</span>
                            </div>
                        </div>

                        <!-- Admin Chat Input -->
                        <div id="adminChatInput" style="display: none; padding: 1rem; border-top: 1px solid var(--gray-200); background: white;">
                            <div style="display: flex; gap: 0.75rem; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <textarea id="adminMessageInput" placeholder="輸入回覆訊息..." rows="1" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--gray-300); border-radius: 20px; font-size: 0.95rem; resize: none; max-height: 120px; line-height: 1.4;" onkeydown="handleAdminChatKeyDown(event)" oninput="handleAdminChatInput(this)"></textarea>
                                </div>
                                <button onclick="sendAdminMessage()" style="padding: 0.75rem 1.25rem; background: var(--olive); color: white; border: none; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-weight: 500;">
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                    發送
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Courses View -->
            <div id="coursesView" class="admin-view">
                <div class="admin-header">
                    <h2>課程管理</h2>
                    <div class="admin-header-actions">
                        <button class="btn-primary" onclick="openCreateCourseModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            新增課程
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>所有課程</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" placeholder="搜尋課程..." class="form-input" style="width: 200px;" id="searchCoursesInput">
                            <select class="form-select" style="width: 150px;" id="filterCourseStatus">
                                <option value="">所有狀態</option>
                                <option value="published">已發布</option>
                                <option value="draft">草稿</option>
                                <option value="archived">已封存</option>
                            </select>
                        </div>
                    </div>
                    <div id="coursesTableContainer">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>課程名稱</th>
                                    <th>類別</th>
                                    <th>教師</th>
                                    <th>學生數</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="coursesTableBody">
                                <tr><td colspan="6" style="text-align: center; padding: 2rem;">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Course Categories View -->
            <div id="courseCategoriesView" class="admin-view">
                <div class="admin-header">
                    <h2>課程類別</h2>
                    <div class="admin-header-actions">
                        <button class="btn-primary" onclick="openCreateCategoryModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            新增類別
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>類別樹狀結構</h3></div>
                    <div id="categoriesTreeContainer" style="padding: 1rem;">
                        <p style="text-align: center; color: var(--gray-400);">載入中...</p>
                    </div>
                </div>
            </div>

            <!-- Question Bank View -->
            <div id="questionbankView" class="admin-view">
                <div class="admin-header">
                    <h2>題庫管理</h2>
                    <div class="admin-header-actions">
                        <button class="btn-secondary" onclick="importQuestions()">匯入題目</button>
                        <button class="btn-primary" onclick="openCreateQuestionModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            新增題目
                        </button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 280px 1fr; gap: 1rem;">
                    <div class="card">
                        <div class="card-header"><h3>題目類別</h3></div>
                        <div id="questionCategoriesTree" style="padding: 0.5rem;">
                            <p style="text-align: center; color: var(--gray-400); padding: 1rem;">載入中...</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>題目列表</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" placeholder="搜尋題目..." class="form-input" style="width: 200px;" id="searchQuestionsInput">
                                <select class="form-select" style="width: 150px;" id="filterQuestionType">
                                    <option value="">所有題型</option>
                                    <option value="multiple_choice">單選題</option>
                                    <option value="multiple_select">多選題</option>
                                    <option value="true_false">是非題</option>
                                    <option value="short_answer">簡答題</option>
                                    <option value="essay">申論題</option>
                                </select>
                            </div>
                        </div>
                        <div id="questionsListContainer">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllQuestions"></th>
                                        <th>題目內容</th>
                                        <th>題型</th>
                                        <th>難度</th>
                                        <th>使用次數</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="questionsTableBody">
                                    <tr><td colspan="6" style="text-align: center; padding: 2rem;">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Badges View -->
            <div id="badgesView" class="admin-view">
                <div class="admin-header">
                    <h2>徽章系統</h2>
                    <div class="admin-header-actions">
                        <button class="btn-primary" onclick="openCreateBadgeModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            新增徽章
                        </button>
                    </div>
                </div>
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card"><div class="stat-value" id="totalBadgesCount">0</div><div class="stat-label">徽章總數</div></div>
                    <div class="stat-card"><div class="stat-value" id="activeBadgesCount">0</div><div class="stat-label">啟用中</div></div>
                    <div class="stat-card"><div class="stat-value" id="awardedBadgesCount">0</div><div class="stat-label">已頒發</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>徽章列表</h3></div>
                    <div id="badgesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; padding: 1rem;">
                        <p style="text-align: center; color: var(--gray-400); grid-column: 1/-1;">載入中...</p>
                    </div>
                </div>
            </div>

            <!-- Learning Paths View -->
            <div id="learningPathsView" class="admin-view">
                <div class="admin-header">
                    <h2>學習路徑</h2>
                    <div class="admin-header-actions">
                        <button class="btn-primary" onclick="openCreatePathModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            新增路徑
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>學習路徑列表</h3></div>
                    <div id="learningPathsContainer" style="padding: 1rem;">
                        <p style="text-align: center; color: var(--gray-400);">載入中...</p>
                    </div>
                </div>
            </div>

            <!-- SCORM View -->
            <div id="scormView" class="admin-view">
                <div class="admin-header">
                    <h2>SCORM 學習包</h2>
                    <div class="admin-header-actions">
                        <button class="btn-primary" onclick="openUploadScormModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            上傳 SCORM 包
                        </button>
                    </div>
                </div>
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card"><div class="stat-value" id="totalScormCount">0</div><div class="stat-label">SCORM 包總數</div></div>
                    <div class="stat-card"><div class="stat-value" id="scorm12Count">0</div><div class="stat-label">SCORM 1.2</div></div>
                    <div class="stat-card"><div class="stat-value" id="scorm2004Count">0</div><div class="stat-label">SCORM 2004</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>SCORM 學習包列表</h3></div>
                    <table class="data-table">
                        <thead><tr><th>名稱</th><th>版本</th><th>課程</th><th>完成次數</th><th>上傳日期</th><th>操作</th></tr></thead>
                        <tbody id="scormTableBody"><tr><td colspan="6" style="text-align: center; padding: 2rem;">載入中...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- LTI View -->
            <div id="ltiView" class="admin-view">
                <div class="admin-header">
                    <h2>LTI 外部工具</h2>
                    <div class="admin-header-actions">
                        <button class="btn-primary" onclick="openCreateLtiModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            新增 LTI 工具
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>已設定的 LTI 工具</h3>
                        <span style="font-size: 0.85rem; color: var(--gray-500);">支援 LTI 1.1 / 1.3</span>
                    </div>
                    <table class="data-table">
                        <thead><tr><th>工具名稱</th><th>供應商</th><th>版本</th><th>狀態</th><th>使用次數</th><th>操作</th></tr></thead>
                        <tbody id="ltiTableBody"><tr><td colspan="6" style="text-align: center; padding: 2rem;">載入中...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- H5P View -->
            <div id="h5pView" class="admin-view">
                <div class="admin-header">
                    <h2>H5P 互動內容</h2>
                    <div class="admin-header-actions">
                        <button class="btn-secondary" onclick="updateH5pLibraries()">更新函式庫</button>
                        <button class="btn-primary" onclick="openCreateH5pModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            新增 H5P 內容
                        </button>
                    </div>
                </div>
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card"><div class="stat-value" id="totalH5pCount">0</div><div class="stat-label">H5P 內容總數</div></div>
                    <div class="stat-card"><div class="stat-value" id="h5pLibrariesCount">0</div><div class="stat-label">已安裝函式庫</div></div>
                    <div class="stat-card"><div class="stat-value" id="h5pInteractionsCount">0</div><div class="stat-label">互動次數</div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>H5P 內容列表</h3>
                        <select class="form-select" style="width: 180px;" id="filterH5pType">
                            <option value="">所有類型</option>
                            <option value="InteractiveVideo">互動影片</option>
                            <option value="CoursePresentation">課程簡報</option>
                            <option value="QuestionSet">題目集</option>
                        </select>
                    </div>
                    <div id="h5pGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; padding: 1rem;">
                        <p style="text-align: center; color: var(--gray-400); grid-column: 1/-1;">載入中...</p>
                    </div>
                </div>
            </div>

            <!-- Roles View -->
            <div id="rolesView" class="admin-view">
                <div class="admin-header">
                    <h2>角色權限管理</h2>
                    <div class="admin-header-actions">
                        <button class="btn-primary" onclick="openCreateRoleModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            新增角色
                        </button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 300px 1fr; gap: 1rem;">
                    <div class="card">
                        <div class="card-header"><h3>角色列表</h3></div>
                        <div id="rolesListContainer" style="padding: 0.5rem;">
                            <p style="text-align: center; color: var(--gray-400); padding: 1rem;">載入中...</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>權限設定</h3></div>
                        <div id="permissionsContainer" style="padding: 1rem;">
                            <p style="text-align: center; color: var(--gray-400);">請選擇角色以查看權限</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rubrics View -->
            <div id="rubricsView" class="admin-view">
                <div class="admin-header">
                    <h2>評分標準 (Rubrics)</h2>
                    <div class="admin-header-actions">
                        <button class="btn-primary" onclick="openCreateRubricModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            新增評分標準
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>評分標準列表</h3></div>
                    <table class="data-table">
                        <thead><tr><th>名稱</th><th>評分項目數</th><th>總分</th><th>使用課程數</th><th>建立日期</th><th>操作</th></tr></thead>
                        <tbody id="rubricsTableBody"><tr><td colspan="6" style="text-align: center; padding: 2rem;">載入中...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <!-- Audit Logs View -->
            <div id="auditLogsView" class="admin-view">
                <div class="admin-header">
                    <h2>審計日誌</h2>
                    <div class="admin-header-actions">
                        <button class="btn-secondary" onclick="exportAuditLogs()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            匯出日誌
                        </button>
                    </div>
                </div>
                <div class="card" style="margin-bottom: 1rem;">
                    <div style="padding: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <input type="date" class="form-input" id="auditDateFrom" style="width: 150px;">
                        <span style="line-height: 38px;">至</span>
                        <input type="date" class="form-input" id="auditDateTo" style="width: 150px;">
                        <select class="form-select" id="auditActionType" style="width: 150px;">
                            <option value="">所有操作</option>
                            <option value="login">登入</option>
                            <option value="logout">登出</option>
                            <option value="create">新增</option>
                            <option value="update">更新</option>
                            <option value="delete">刪除</option>
                        </select>
                        <input type="text" class="form-input" placeholder="搜尋用戶..." id="auditUserSearch" style="width: 200px;">
                        <button class="btn-primary" onclick="filterAuditLogs()">篩選</button>
                    </div>
                </div>
                <div class="card">
                    <table class="data-table">
                        <thead><tr><th>時間</th><th>用戶</th><th>操作類型</th><th>目標</th><th>IP 位址</th><th>詳細</th></tr></thead>
                        <tbody id="auditLogsTableBody"><tr><td colspan="6" style="text-align: center; padding: 2rem;">載入中...</td></tr></tbody>
                    </table>
                    <div style="padding: 1rem; display: flex; justify-content: center;">
                        <div id="auditLogsPagination"></div>
                    </div>
                </div>
            </div>

            <!-- System Monitor View - 系統監控 -->
            <div id="systemMonitorView" class="admin-view">
                <div class="admin-header">
                    <h2>系統監控</h2>
                    <div class="admin-header-actions">
                        <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh(this.checked)">
                            <span class="toggle-slider"></span>
                            <span style="font-size: 0.875rem; color: var(--text-secondary);">自動更新 (30秒)</span>
                        </label>
                        <button class="btn-secondary" onclick="loadSystemHealth()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6"/><path d="M1 20v-6h6"/>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                            </svg>
                            立即刷新
                        </button>
                    </div>
                </div>

                <!-- System Status Cards -->
                <div class="system-status-grid">
                    <div class="system-status-card" id="statusCardAPI">
                        <div class="status-icon healthy">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                        </div>
                        <div class="status-info">
                            <div class="status-label">API 服務</div>
                            <div class="status-value healthy" id="apiStatus">正常運行</div>
                        </div>
                    </div>
                    <div class="system-status-card" id="statusCardDB">
                        <div class="status-icon healthy">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <ellipse cx="12" cy="5" rx="9" ry="3"/>
                                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
                                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                            </svg>
                        </div>
                        <div class="status-info">
                            <div class="status-label">資料庫</div>
                            <div class="status-value healthy" id="dbStatus">正常連接</div>
                        </div>
                    </div>
                    <div class="system-status-card" id="statusCardStorage">
                        <div class="status-icon healthy">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                            </svg>
                        </div>
                        <div class="status-info">
                            <div class="status-label">儲存空間</div>
                            <div class="status-value healthy" id="storageStatus">充足</div>
                        </div>
                    </div>
                    <div class="system-status-card" id="statusCardMemory">
                        <div class="status-icon healthy">
                            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="4" y="4" width="16" height="16" rx="2" ry="2"/>
                                <rect x="9" y="9" width="6" height="6"/>
                                <line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/>
                                <line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/>
                                <line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/>
                                <line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/>
                            </svg>
                        </div>
                        <div class="status-info">
                            <div class="status-label">記憶體使用</div>
                            <div class="status-value" id="memoryStatus">-</div>
                        </div>
                    </div>
                </div>

                <!-- System Metrics -->
                <div class="system-metrics-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>系統資源使用</h3>
                        </div>
                        <div class="card-body">
                            <div class="resource-meter">
                                <div class="meter-label">
                                    <span>記憶體</span>
                                    <span id="memoryPercent">0%</span>
                                </div>
                                <div class="meter-bar">
                                    <div class="meter-fill" id="memoryBar" style="width: 0%"></div>
                                </div>
                                <div class="meter-detail" id="memoryDetail">已使用 0 MB / 總共 0 MB</div>
                            </div>
                            <div class="resource-meter">
                                <div class="meter-label">
                                    <span>運行時間</span>
                                    <span id="uptimeValue">-</span>
                                </div>
                                <div class="uptime-info">
                                    <span>Node.js 版本：</span>
                                    <span id="nodeVersion">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>最近錯誤日誌</h3>
                            <select class="form-select" id="errorSeverityFilter" onchange="filterErrors()" style="width: 120px;">
                                <option value="">全部等級</option>
                                <option value="error">錯誤</option>
                                <option value="warning">警告</option>
                                <option value="info">資訊</option>
                            </select>
                        </div>
                        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                            <div class="error-log-list" id="errorLogList">
                                <div class="empty-state">
                                    <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                    <p>系統運行正常，無錯誤記錄</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Export View - 數據匯出 -->
            <div id="dataExportView" class="admin-view">
                <div class="admin-header">
                    <h2>數據匯出</h2>
                </div>

                <!-- Export Options -->
                <div class="export-options-grid">
                    <div class="export-card" onclick="showExportModal('users')">
                        <div class="export-icon">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <h3>用戶數據</h3>
                        <p>匯出所有用戶資料，包含基本資訊、角色、狀態等</p>
                        <div class="export-formats">
                            <span class="format-badge">CSV</span>
                            <span class="format-badge">JSON</span>
                            <span class="format-badge">PDF</span>
                        </div>
                    </div>
                    <div class="export-card" onclick="showExportModal('courses')">
                        <div class="export-icon">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                            </svg>
                        </div>
                        <h3>課程數據</h3>
                        <p>匯出課程資訊，包含名稱、講師、學生數、進度等</p>
                        <div class="export-formats">
                            <span class="format-badge">CSV</span>
                            <span class="format-badge">JSON</span>
                            <span class="format-badge">PDF</span>
                        </div>
                    </div>
                    <div class="export-card" onclick="showExportModal('licenses')">
                        <div class="export-icon">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                        </div>
                        <h3>授權數據</h3>
                        <p>匯出授權記錄，包含申請、核准、到期日等資訊</p>
                        <div class="export-formats">
                            <span class="format-badge">CSV</span>
                            <span class="format-badge">JSON</span>
                            <span class="format-badge">PDF</span>
                        </div>
                    </div>
                    <div class="export-card" onclick="showExportModal('analytics')">
                        <div class="export-icon">
                            <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="20" x2="18" y2="10"/>
                                <line x1="12" y1="20" x2="12" y2="4"/>
                                <line x1="6" y1="20" x2="6" y2="14"/>
                            </svg>
                        </div>
                        <h3>分析報表</h3>
                        <p>生成自訂日期範圍的綜合分析報表</p>
                        <div class="export-formats">
                            <span class="format-badge">PDF</span>
                            <span class="format-badge">Excel</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Exports -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h3>最近匯出記錄</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>類型</th>
                                <th>格式</th>
                                <th>日期範圍</th>
                                <th>匯出時間</th>
                                <th>狀態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="recentExportsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    尚無匯出記錄
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Automation View - 自動化規則 -->
            <div id="automationView" class="admin-view">
                <div class="admin-header">
                    <h2>自動化規則</h2>
                    <div class="admin-header-actions">
                        <button class="btn-primary" onclick="openAutomationModal()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            新增規則
                        </button>
                    </div>
                </div>

                <!-- Automation Stats -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRulesCount">0</div>
                        <div class="stat-label">總規則數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeRulesCount">0</div>
                        <div class="stat-label">啟用中</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayTriggersCount">0</div>
                        <div class="stat-label">今日觸發</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalTriggersCount">0</div>
                        <div class="stat-label">累計觸發</div>
                    </div>
                </div>

                <!-- Rules List -->
                <div class="card">
                    <div class="card-header">
                        <h3>規則列表</h3>
                        <div style="display: flex; gap: 0.5rem;">
                            <select class="form-select" id="ruleTypeFilter" onchange="filterRules()" style="width: 150px;">
                                <option value="">全部類型</option>
                                <option value="AUTO_APPROVE_LICENSE">自動核准授權</option>
                                <option value="AUTO_SEND_NOTIFICATION">自動發送通知</option>
                                <option value="AUTO_SUSPEND_USER">自動停用用戶</option>
                                <option value="AUTO_ARCHIVE_COURSE">自動封存課程</option>
                                <option value="SCHEDULED_REPORT">定期報表</option>
                            </select>
                            <select class="form-select" id="ruleStatusFilter" onchange="filterRules()" style="width: 120px;">
                                <option value="">全部狀態</option>
                                <option value="active">啟用</option>
                                <option value="inactive">停用</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>狀態</th>
                                <th>規則名稱</th>
                                <th>類型</th>
                                <th>條件</th>
                                <th>動作</th>
                                <th>上次觸發</th>
                                <th>觸發次數</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="automationRulesTable">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                    尚無自動化規則，點擊「新增規則」開始設定
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- User Activity View - 用戶活動分析 -->
            <div id="userActivityView" class="admin-view">
                <div class="admin-header">
                    <h2>用戶活動分析</h2>
                    <div class="admin-header-actions">
                        <select class="form-select" id="activityDateRange" onchange="loadUserActivity()" style="width: 150px;">
                            <option value="7d">最近 7 天</option>
                            <option value="30d" selected>最近 30 天</option>
                            <option value="90d">最近 90 天</option>
                            <option value="custom">自訂範圍</option>
                        </select>
                        <button class="btn-secondary" onclick="exportActivityReport()">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            匯出報表
                        </button>
                    </div>
                </div>

                <!-- Activity Metrics -->
                <div class="activity-metrics-grid">
                    <div class="activity-metric-card">
                        <div class="metric-header">
                            <span class="metric-title">日活躍用戶 (DAU)</span>
                            <span class="metric-trend positive" id="dauTrend">+0%</span>
                        </div>
                        <div class="metric-value" id="dauValue">0</div>
                        <div class="metric-sparkline" id="dauSparkline"></div>
                    </div>
                    <div class="activity-metric-card">
                        <div class="metric-header">
                            <span class="metric-title">週活躍用戶 (WAU)</span>
                            <span class="metric-trend positive" id="wauTrend">+0%</span>
                        </div>
                        <div class="metric-value" id="wauValue">0</div>
                        <div class="metric-sparkline" id="wauSparkline"></div>
                    </div>
                    <div class="activity-metric-card">
                        <div class="metric-header">
                            <span class="metric-title">月活躍用戶 (MAU)</span>
                            <span class="metric-trend positive" id="mauTrend">+0%</span>
                        </div>
                        <div class="metric-value" id="mauValue">0</div>
                        <div class="metric-sparkline" id="mauSparkline"></div>
                    </div>
                    <div class="activity-metric-card">
                        <div class="metric-header">
                            <span class="metric-title">用戶留存率</span>
                            <span class="metric-trend neutral" id="retentionTrend">-</span>
                        </div>
                        <div class="metric-value" id="retentionValue">0%</div>
                        <div class="metric-sparkline" id="retentionSparkline"></div>
                    </div>
                </div>

                <!-- Activity Charts -->
                <div class="activity-charts-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>活躍用戶趨勢</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="activityTrendChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>行為分布</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="behaviorDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Activity Heatmap and Top Users -->
                <div class="activity-bottom-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>活動時段熱力圖</h3>
                        </div>
                        <div class="card-body">
                            <div class="heatmap-container" id="activityHeatmap">
                                <!-- Heatmap will be rendered here -->
                            </div>
                            <div class="heatmap-legend">
                                <span>較少</span>
                                <div class="legend-scale">
                                    <div class="legend-item" style="background: #f0f4f0;"></div>
                                    <div class="legend-item" style="background: #c5d5c0;"></div>
                                    <div class="legend-item" style="background: #9ab88f;"></div>
                                    <div class="legend-item" style="background: #6f9b5e;"></div>
                                    <div class="legend-item" style="background: var(--olive);"></div>
                                </div>
                                <span>較多</span>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3>高活躍用戶 Top 10</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>用戶</th>
                                    <th>角色</th>
                                    <th>活動次數</th>
                                    <th>最後活動</th>
                                </tr>
                            </thead>
                            <tbody id="topActiveUsersTable">
                                <tr>
                                    <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                        載入中...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="createResourceModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="resourceModalTitle">新增教材</h3>
                <button class="modal-close" onclick="closeModal('createResourceModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="createResourceForm">
                    <input type="hidden" name="resourceId" value="">

                    <!-- 基本資訊 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">基本資訊</h4>
                        <div class="form-group">
                            <label>標題 *</label>
                            <input type="text" name="title" class="form-input" required placeholder="請輸入教材標題">
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea name="description" class="form-input" rows="3" placeholder="教材簡介說明"></textarea>
                        </div>
                    </div>

                    <!-- 分類設定 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">分類設定</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>類型 *</label>
                                <select name="type" class="form-input" required>
                                    <option value="video">影音教材</option>
                                    <option value="interactive">互動教材</option>
                                    <option value="document">文件講義</option>
                                    <option value="quiz">測驗題庫</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>分類 *</label>
                                <select name="category" class="form-input" required>
                                    <option value="math">數學</option>
                                    <option value="chinese">國文</option>
                                    <option value="english">英文</option>
                                    <option value="science">自然科學</option>
                                    <option value="social">社會科學</option>
                                    <option value="business">商業管理</option>
                                    <option value="technology">資訊科技</option>
                                    <option value="arts">藝術人文</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>適用年級 *</label>
                                <select name="gradeLevel" class="form-input" required>
                                    <option value="elementary">國小</option>
                                    <option value="junior">國中</option>
                                    <option value="senior">高中</option>
                                    <option value="university">大學</option>
                                    <option value="corporate">企業培訓</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 內容資訊 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">內容資訊</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>時長（分鐘）</label>
                                <input type="number" name="duration" class="form-input" min="0" placeholder="例：60">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>單元數</label>
                                <input type="number" name="unitCount" class="form-input" min="0" placeholder="例：12">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
                            <label>標籤 <span style="color: #94a3b8; font-weight: normal;">（用逗號分隔）</span></label>
                            <input type="text" name="tags" class="form-input" placeholder="例：代數, 方程式, 基礎數學">
                        </div>
                    </div>

                    <!-- 定價設定 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">定價設定</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>定價模式</label>
                                <select name="pricingModel" class="form-input" onchange="togglePriceField(this.value)">
                                    <option value="license">授權制</option>
                                    <option value="free">免費</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;" id="priceFieldGroup">
                                <label>價格（NT$）</label>
                                <input type="number" name="price" class="form-input" min="0" placeholder="例：1200">
                            </div>
                        </div>
                    </div>

                    <!-- 目標受眾 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">目標受眾</h4>
                        <div style="display: flex; gap: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" name="targetAudience" value="educator" checked>
                                <span>教師</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" name="targetAudience" value="student" checked>
                                <span>學生</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" name="targetAudience" value="trainer">
                                <span>培訓師</span>
                            </label>
                        </div>
                    </div>

                    <!-- 發布狀態 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">發布狀態</h4>
                        <div class="form-group" style="margin-bottom: 0;">
                            <select name="status" class="form-input">
                                <option value="draft">草稿</option>
                                <option value="published">已發布</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createResourceModal')">取消</button>
                <button class="btn btn-primary" onclick="submitResourceForm()">儲存</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createAnnouncementModal">
        <div class="modal">
            <div class="modal-header">
                <h3>新增公告</h3>
                <button class="modal-close" onclick="closeModal('createAnnouncementModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createAnnouncementForm">
                    <div class="form-group">
                        <label>標題 *</label>
                        <input type="text" name="title" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>內容 *</label>
                        <textarea name="content" class="form-input" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>優先級</label>
                        <select name="priority" class="form-input">
                            <option value="normal">一般</option>
                            <option value="high">重要</option>
                            <option value="urgent">緊急</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createAnnouncementModal')">取消</button>
                <button class="btn btn-primary" onclick="submitCreateAnnouncement()">發布</button>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal-overlay" id="createUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3>新增用戶</h3>
                <button class="modal-close" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label>姓名 *</label>
                        <input type="text" name="displayName" class="form-input" required placeholder="用戶姓名">
                    </div>
                    <div class="form-group">
                        <label>電子郵件 *</label>
                        <input type="email" name="email" class="form-input" required placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label>密碼 *</label>
                        <input type="password" name="password" class="form-input" required placeholder="至少 6 個字元" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>角色 *</label>
                        <select name="role" class="form-input" required>
                            <option value="educator">教育工作者</option>
                            <option value="trainer">企業培訓主管</option>
                            <option value="creator">內容創作者</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>學校/機構</label>
                        <input type="text" name="organization" class="form-input" placeholder="選填">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')">取消</button>
                <button class="btn btn-primary" onclick="submitCreateUser()">建立用戶</button>
            </div>
        </div>
    </div>

    <!-- 確認對話框組件 -->
    <div class="confirm-dialog-overlay" id="confirmDialogOverlay">
        <div class="confirm-dialog" id="confirmDialog">
            <div class="confirm-dialog-header">
                <div class="confirm-dialog-icon" id="confirmDialogIcon">
                    <!-- 圖示會由 JS 動態插入 -->
                </div>
                <div class="confirm-dialog-content">
                    <h4 class="confirm-dialog-title" id="confirmDialogTitle">確認操作</h4>
                    <p class="confirm-dialog-message" id="confirmDialogMessage">您確定要執行此操作嗎？</p>
                </div>
            </div>
            <div class="confirm-dialog-body" id="confirmDialogBody" style="display: none;">
                <!-- 可選的輸入欄位區域 -->
            </div>
            <div class="confirm-dialog-footer">
                <button class="confirm-dialog-btn confirm-dialog-btn-cancel" id="confirmDialogCancel">取消</button>
                <button class="confirm-dialog-btn confirm-dialog-btn-confirm" id="confirmDialogConfirm">確認</button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========== 確認對話框組件 ==========
        const ConfirmDialog = {
            overlay: null,
            dialog: null,
            currentCallback: null,
            currentInputValidator: null,

            init() {
                this.overlay = document.getElementById('confirmDialogOverlay');
                this.dialog = document.getElementById('confirmDialog');

                // 綁定按鈕事件
                document.getElementById('confirmDialogCancel').addEventListener('click', () => this.close(false));
                document.getElementById('confirmDialogConfirm').addEventListener('click', () => this.handleConfirm());

                // 點擊遮罩關閉
                this.overlay.addEventListener('click', (e) => {
                    if (e.target === this.overlay) this.close(false);
                });

                // ESC 鍵關閉
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.overlay.classList.contains('active')) {
                        this.close(false);
                    }
                });
            },

            /**
             * 顯示確認對話框
             * @param {Object} options 配置選項
             * @param {string} options.title - 標題
             * @param {string} options.message - 訊息內容
             * @param {string} options.type - 類型: 'danger' | 'warning' | 'info'
             * @param {string} options.confirmText - 確認按鈕文字
             * @param {string} options.cancelText - 取消按鈕文字
             * @param {Object} options.input - 輸入框配置 { placeholder, hint, validator }
             * @param {Function} options.onConfirm - 確認回調
             * @param {Function} options.onCancel - 取消回調
             */
            show(options = {}) {
                const {
                    title = '確認操作',
                    message = '您確定要執行此操作嗎？',
                    type = 'warning',
                    confirmText = '確認',
                    cancelText = '取消',
                    input = null,
                    onConfirm = null,
                    onCancel = null
                } = options;

                // 設置類型
                this.dialog.className = `confirm-dialog ${type}`;

                // 設置圖示
                const iconContainer = document.getElementById('confirmDialogIcon');
                iconContainer.innerHTML = this.getIcon(type);

                // 設置內容
                document.getElementById('confirmDialogTitle').textContent = title;
                document.getElementById('confirmDialogMessage').textContent = message;
                document.getElementById('confirmDialogConfirm').textContent = confirmText;
                document.getElementById('confirmDialogCancel').textContent = cancelText;

                // 處理輸入框
                const bodyEl = document.getElementById('confirmDialogBody');
                if (input) {
                    bodyEl.style.display = 'block';
                    bodyEl.innerHTML = `
                        <input type="text"
                               class="confirm-dialog-input"
                               id="confirmDialogInput"
                               placeholder="${input.placeholder || ''}"
                               autocomplete="off">
                        ${input.hint ? `<p class="confirm-dialog-hint">${input.hint}</p>` : ''}
                    `;
                    this.currentInputValidator = input.validator || null;

                    // 監聽輸入
                    const inputEl = document.getElementById('confirmDialogInput');
                    inputEl.addEventListener('input', () => {
                        inputEl.classList.remove('error');
                    });
                } else {
                    bodyEl.style.display = 'none';
                    bodyEl.innerHTML = '';
                    this.currentInputValidator = null;
                }

                // 保存回調
                this.currentCallback = onConfirm;
                this.currentCancelCallback = onCancel;

                // 顯示對話框
                this.overlay.classList.add('active');

                // 聚焦到輸入框或確認按鈕
                setTimeout(() => {
                    if (input) {
                        document.getElementById('confirmDialogInput')?.focus();
                    } else {
                        document.getElementById('confirmDialogConfirm').focus();
                    }
                }, 100);
            },

            handleConfirm() {
                // 如果有輸入框，驗證輸入
                const inputEl = document.getElementById('confirmDialogInput');
                if (inputEl && this.currentInputValidator) {
                    const value = inputEl.value.trim();
                    if (!this.currentInputValidator(value)) {
                        inputEl.classList.add('error');
                        inputEl.focus();
                        return;
                    }
                }

                this.close(true);
            },

            close(confirmed) {
                this.overlay.classList.remove('active');

                // 取得輸入值
                const inputEl = document.getElementById('confirmDialogInput');
                const inputValue = inputEl ? inputEl.value.trim() : null;

                if (confirmed && this.currentCallback) {
                    this.currentCallback(inputValue);
                } else if (!confirmed && this.currentCancelCallback) {
                    this.currentCancelCallback();
                }

                this.currentCallback = null;
                this.currentCancelCallback = null;
                this.currentInputValidator = null;
            },

            getIcon(type) {
                const icons = {
                    danger: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>`,
                    warning: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>`,
                    info: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>`
                };
                return icons[type] || icons.warning;
            }
        };

        /**
         * 快捷函數：顯示確認對話框
         * @returns {Promise} 返回 Promise，confirmed 時 resolve，取消時 reject
         */
        function showConfirmDialog(options) {
            return new Promise((resolve, reject) => {
                ConfirmDialog.show({
                    ...options,
                    onConfirm: (inputValue) => resolve(inputValue),
                    onCancel: () => reject(new Error('cancelled'))
                });
            });
        }

        // ========== 迷你圖生成器 ==========
        const Sparkline = {
            /**
             * 生成 SVG 迷你圖
             * @param {Array} data - 數據陣列
             * @param {Object} options - 選項
             */
            generate(data, options = {}) {
                const { width = 100, height = 40, showArea = true } = options;

                if (!data || data.length < 2) {
                    // 生成模擬數據
                    data = [0, 2, 1, 4, 3, 6, 5, 8, 7, 10];
                }

                const max = Math.max(...data);
                const min = Math.min(...data);
                const range = max - min || 1;

                const points = data.map((value, index) => {
                    const x = (index / (data.length - 1)) * width;
                    const y = height - ((value - min) / range) * height;
                    return `${x},${y}`;
                });

                const linePath = `M${points.join(' L')}`;
                const areaPath = `M0,${height} L${points.join(' L')} L${width},${height} Z`;

                return `
                    <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
                        ${showArea ? `<path class="sparkline-area" d="${areaPath}"/>` : ''}
                        <path d="${linePath}"/>
                    </svg>
                `;
            },

            /**
             * 更新迷你圖
             */
            update(containerId, data, options) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = this.generate(data, options);
                }
            }
        };

        // ========== 實時表單驗證組件 ==========
        const FormValidator = {
            forms: {},

            // 預設驗證規則
            rules: {
                required: {
                    validate: (value) => value.trim().length > 0,
                    message: '此欄位為必填'
                },
                email: {
                    validate: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
                    message: '請輸入有效的電子郵件地址'
                },
                minLength: (min) => ({
                    validate: (value) => value.length >= min,
                    message: `至少需要 ${min} 個字元`
                }),
                maxLength: (max) => ({
                    validate: (value) => value.length <= max,
                    message: `最多只能 ${max} 個字元`
                }),
                pattern: (regex, msg) => ({
                    validate: (value) => regex.test(value),
                    message: msg || '格式不正確'
                }),
                password: {
                    validate: (value) => value.length >= 6,
                    message: '密碼至少需要 6 個字元'
                },
                confirmPassword: (passwordField) => ({
                    validate: (value, form) => {
                        const password = form.querySelector(`[name="${passwordField}"]`)?.value;
                        return value === password;
                    },
                    message: '密碼不一致'
                }),
                phone: {
                    validate: (value) => !value || /^[0-9\-\+\s()]{8,20}$/.test(value),
                    message: '請輸入有效的電話號碼'
                },
                url: {
                    validate: (value) => !value || /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/.test(value),
                    message: '請輸入有效的網址'
                }
            },

            /**
             * 初始化表單驗證
             * @param {string} formId - 表單 ID
             * @param {Object} fieldRules - 欄位規則 { fieldName: ['required', 'email', ...] }
             * @param {Object} options - 選項 { validateOnInput, validateOnBlur, showSuccessState }
             */
            init(formId, fieldRules, options = {}) {
                const form = document.getElementById(formId);
                if (!form) return;

                const config = {
                    validateOnInput: true,
                    validateOnBlur: true,
                    showSuccessState: true,
                    ...options
                };

                this.forms[formId] = { form, fieldRules, config, errors: {} };

                // 綁定事件
                Object.keys(fieldRules).forEach(fieldName => {
                    const input = form.querySelector(`[name="${fieldName}"]`);
                    if (!input) return;

                    // 為輸入框添加包裝器（如果還沒有）
                    this.wrapInput(input);

                    if (config.validateOnInput) {
                        let debounceTimer;
                        input.addEventListener('input', () => {
                            clearTimeout(debounceTimer);
                            debounceTimer = setTimeout(() => {
                                this.validateField(formId, fieldName);
                            }, 300);
                        });
                    }

                    if (config.validateOnBlur) {
                        input.addEventListener('blur', () => {
                            this.validateField(formId, fieldName);
                        });
                    }

                    // 密碼強度檢測
                    if (fieldRules[fieldName].includes('password')) {
                        input.addEventListener('input', () => {
                            this.updatePasswordStrength(input);
                        });
                    }
                });

                // 攔截表單提交
                form.addEventListener('submit', (e) => {
                    if (!this.validateForm(formId)) {
                        e.preventDefault();
                    }
                });
            },

            /**
             * 包裝輸入框
             */
            wrapInput(input) {
                if (input.parentElement.classList.contains('form-input-wrapper')) return;

                const wrapper = document.createElement('div');
                wrapper.className = 'form-input-wrapper';
                input.parentNode.insertBefore(wrapper, input);
                wrapper.appendChild(input);

                // 添加驗證圖示
                wrapper.insertAdjacentHTML('beforeend', `
                    <svg class="validation-icon success" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    <svg class="validation-icon error" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                `);

                // 添加錯誤訊息容器
                const messageEl = document.createElement('div');
                messageEl.className = 'validation-message';
                messageEl.id = `${input.name}-error`;
                wrapper.parentNode.insertBefore(messageEl, wrapper.nextSibling);
            },

            /**
             * 驗證單一欄位
             */
            validateField(formId, fieldName) {
                const formData = this.forms[formId];
                if (!formData) return true;

                const { form, fieldRules, config, errors } = formData;
                const input = form.querySelector(`[name="${fieldName}"]`);
                if (!input) return true;

                const rules = fieldRules[fieldName] || [];
                const value = input.value;

                // 執行所有規則
                for (const rule of rules) {
                    let ruleObj;
                    if (typeof rule === 'string') {
                        ruleObj = this.rules[rule];
                    } else if (typeof rule === 'object') {
                        ruleObj = rule;
                    }

                    if (ruleObj && !ruleObj.validate(value, form)) {
                        errors[fieldName] = ruleObj.message;
                        this.showError(input, ruleObj.message);
                        return false;
                    }
                }

                // 驗證通過
                delete errors[fieldName];
                if (config.showSuccessState && value.trim()) {
                    this.showSuccess(input);
                } else {
                    this.clearValidation(input);
                }
                return true;
            },

            /**
             * 驗證整個表單
             */
            validateForm(formId) {
                const formData = this.forms[formId];
                if (!formData) return true;

                const { fieldRules } = formData;
                let isValid = true;

                Object.keys(fieldRules).forEach(fieldName => {
                    if (!this.validateField(formId, fieldName)) {
                        isValid = false;
                    }
                });

                return isValid;
            },

            /**
             * 顯示錯誤狀態
             */
            showError(input, message) {
                input.classList.remove('valid');
                input.classList.add('invalid', 'validating');

                const messageEl = document.getElementById(`${input.name}-error`);
                if (messageEl) {
                    messageEl.textContent = message;
                    messageEl.className = 'validation-message error';
                }
            },

            /**
             * 顯示成功狀態
             */
            showSuccess(input) {
                input.classList.remove('invalid');
                input.classList.add('valid', 'validating');

                const messageEl = document.getElementById(`${input.name}-error`);
                if (messageEl) {
                    messageEl.textContent = '';
                    messageEl.className = 'validation-message';
                }
            },

            /**
             * 清除驗證狀態
             */
            clearValidation(input) {
                input.classList.remove('valid', 'invalid', 'validating');

                const messageEl = document.getElementById(`${input.name}-error`);
                if (messageEl) {
                    messageEl.textContent = '';
                    messageEl.className = 'validation-message';
                }
            },

            /**
             * 更新密碼強度指示器
             */
            updatePasswordStrength(input) {
                let strengthEl = input.parentElement.parentElement.querySelector('.password-strength-container');
                if (!strengthEl) {
                    strengthEl = document.createElement('div');
                    strengthEl.className = 'password-strength-container';
                    strengthEl.innerHTML = `
                        <div class="password-strength">
                            <div class="password-strength-bar"></div>
                            <div class="password-strength-bar"></div>
                            <div class="password-strength-bar"></div>
                        </div>
                        <div class="password-strength-text"></div>
                    `;
                    const messageEl = document.getElementById(`${input.name}-error`);
                    if (messageEl) {
                        messageEl.parentNode.insertBefore(strengthEl, messageEl.nextSibling);
                    }
                }

                const password = input.value;
                const strength = this.calculatePasswordStrength(password);
                const strengthWrapper = strengthEl.querySelector('.password-strength');
                const strengthText = strengthEl.querySelector('.password-strength-text');

                strengthWrapper.className = `password-strength ${strength.level}`;
                strengthText.textContent = strength.text;
            },

            /**
             * 計算密碼強度
             */
            calculatePasswordStrength(password) {
                if (!password) return { level: '', text: '' };

                let score = 0;
                if (password.length >= 6) score++;
                if (password.length >= 10) score++;
                if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
                if (/\d/.test(password)) score++;
                if (/[^a-zA-Z0-9]/.test(password)) score++;

                if (score <= 2) return { level: 'weak', text: '密碼強度：弱' };
                if (score <= 3) return { level: 'medium', text: '密碼強度：中等' };
                return { level: 'strong', text: '密碼強度：強' };
            },

            /**
             * 取得表單錯誤
             */
            getErrors(formId) {
                return this.forms[formId]?.errors || {};
            },

            /**
             * 重設表單驗證狀態
             */
            reset(formId) {
                const formData = this.forms[formId];
                if (!formData) return;

                formData.errors = {};
                const { form, fieldRules } = formData;

                Object.keys(fieldRules).forEach(fieldName => {
                    const input = form.querySelector(`[name="${fieldName}"]`);
                    if (input) {
                        this.clearValidation(input);
                    }
                });
            }
        };

        // ========== 表格排序組件 ==========
        const TableSorter = {
            currentSort: { column: null, direction: 'asc' },
            tableId: null,
            sortCallbacks: {},

            /**
             * 初始化表格排序
             * @param {string} tableId - 表格 ID
             * @param {Function} onSort - 排序回調
             */
            init(tableId, onSort) {
                this.tableId = tableId;
                this.sortCallbacks[tableId] = onSort;
                this.currentSort = { column: null, direction: 'asc' };
            },

            /**
             * 執行排序
             * @param {string} column - 欄位名稱
             */
            sort(column) {
                // 切換排序方向
                if (this.currentSort.column === column) {
                    this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.currentSort.column = column;
                    this.currentSort.direction = 'asc';
                }

                // 更新表頭樣式
                this.updateHeaderStyles();

                // 執行排序回調
                if (this.sortCallbacks[this.tableId]) {
                    this.sortCallbacks[this.tableId](column, this.currentSort.direction);
                }
            },

            /**
             * 更新表頭樣式
             */
            updateHeaderStyles() {
                const table = document.getElementById(this.tableId);
                if (!table) return;

                const headers = table.querySelectorAll('.sortable-header');
                headers.forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                    if (th.dataset.column === this.currentSort.column) {
                        th.classList.add(`sort-${this.currentSort.direction}`);
                    }
                });
            },

            /**
             * 生成排序圖示
             */
            getSortIcon() {
                return `<svg class="sort-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12l7-7 7 7"/>
                </svg>`;
            },

            /**
             * 對資料進行排序
             * @param {Array} data - 資料陣列
             * @param {string} column - 排序欄位
             * @param {string} direction - 排序方向
             * @param {Object} columnTypes - 欄位類型定義
             */
            sortData(data, column, direction, columnTypes = {}) {
                if (!column) return data;

                return [...data].sort((a, b) => {
                    let valA = a[column];
                    let valB = b[column];

                    // 處理 null/undefined
                    if (valA == null) valA = '';
                    if (valB == null) valB = '';

                    const type = columnTypes[column] || 'string';

                    let comparison = 0;
                    switch (type) {
                        case 'number':
                            comparison = Number(valA) - Number(valB);
                            break;
                        case 'date':
                            comparison = new Date(valA) - new Date(valB);
                            break;
                        default:
                            comparison = String(valA).localeCompare(String(valB), 'zh-TW');
                    }

                    return direction === 'desc' ? -comparison : comparison;
                });
            }
        };

        // ========== 進階篩選組件 ==========
        const AdvancedFilter = {
            filters: {},
            panelId: null,
            onFilterChange: null,

            /**
             * 初始化篩選器
             * @param {string} panelId - 面板 ID
             * @param {Function} onFilterChange - 篩選變更回調
             */
            init(panelId, onFilterChange) {
                this.panelId = panelId;
                this.onFilterChange = onFilterChange;
                this.filters = {};
            },

            /**
             * 設定篩選值
             * @param {string} key - 篩選鍵
             * @param {any} value - 篩選值
             */
            setFilter(key, value) {
                if (value === '' || value === null || value === 'all') {
                    delete this.filters[key];
                } else {
                    this.filters[key] = value;
                }
                this.updateFilterTags();
                if (this.onFilterChange) {
                    this.onFilterChange(this.filters);
                }
            },

            /**
             * 清除所有篩選
             */
            clearAll() {
                this.filters = {};
                this.resetFormInputs();
                this.updateFilterTags();
                if (this.onFilterChange) {
                    this.onFilterChange(this.filters);
                }
            },

            /**
             * 重設表單輸入
             */
            resetFormInputs() {
                const panel = document.getElementById(this.panelId);
                if (!panel) return;

                panel.querySelectorAll('select').forEach(select => {
                    select.value = select.options[0]?.value || '';
                });
                panel.querySelectorAll('input').forEach(input => {
                    input.value = '';
                });
            },

            /**
             * 更新篩選標籤顯示
             */
            updateFilterTags() {
                const tagsContainer = document.getElementById(`${this.panelId}Tags`);
                if (!tagsContainer) return;

                const filterCount = Object.keys(this.filters).length;
                if (filterCount === 0) {
                    tagsContainer.innerHTML = '';
                    tagsContainer.style.display = 'none';
                    return;
                }

                tagsContainer.style.display = 'flex';
                tagsContainer.innerHTML = Object.entries(this.filters).map(([key, value]) => {
                    const label = this.getFilterLabel(key, value);
                    return `
                        <span class="filter-tag">
                            ${label}
                            <span class="filter-tag-remove" onclick="AdvancedFilter.setFilter('${key}', '')">&times;</span>
                        </span>
                    `;
                }).join('');

                // 更新篩選按鈕計數
                this.updateToggleButton(filterCount);
            },

            /**
             * 取得篩選標籤文字
             */
            getFilterLabel(key, value) {
                const labels = {
                    role: { educator: '建橋者', trainer: '橋樑工匠', creator: '知識建築師', student: '探橋者' },
                    status: { active: '啟用中', suspended: '已停用', pending: '待審核' },
                    subscriptionTier: { free: '免費', basic: '基礎', premium: '進階', enterprise: '企業' }
                };
                const keyLabels = { role: '角色', status: '狀態', subscriptionTier: '訂閱', dateFrom: '開始日期', dateTo: '結束日期', search: '搜尋' };

                const keyLabel = keyLabels[key] || key;
                const valueLabel = labels[key]?.[value] || value;
                return `${keyLabel}: ${valueLabel}`;
            },

            /**
             * 更新切換按鈕
             */
            updateToggleButton(count) {
                const toggleBtn = document.querySelector(`[data-filter-toggle="${this.panelId}"]`);
                if (!toggleBtn) return;

                const countBadge = toggleBtn.querySelector('.active-filter-count');
                if (count > 0) {
                    if (countBadge) {
                        countBadge.textContent = count;
                    } else {
                        toggleBtn.insertAdjacentHTML('beforeend', `<span class="active-filter-count">${count}</span>`);
                    }
                    toggleBtn.classList.add('active');
                } else {
                    if (countBadge) countBadge.remove();
                    toggleBtn.classList.remove('active');
                }
            },

            /**
             * 切換面板顯示
             */
            togglePanel() {
                const panel = document.getElementById(this.panelId);
                if (panel) {
                    panel.classList.toggle('active');
                }
            },

            /**
             * 篩選資料
             * @param {Array} data - 資料陣列
             * @param {Object} filterDefs - 篩選定義 { key: { type: 'exact'|'contains'|'dateRange', field: 'fieldName' } }
             */
            filterData(data, filterDefs = {}) {
                if (Object.keys(this.filters).length === 0) return data;

                return data.filter(item => {
                    return Object.entries(this.filters).every(([key, value]) => {
                        const def = filterDefs[key] || { type: 'exact', field: key };
                        const itemValue = item[def.field];

                        switch (def.type) {
                            case 'contains':
                                return String(itemValue || '').toLowerCase().includes(String(value).toLowerCase());
                            case 'dateRange':
                                // 處理日期範圍篩選
                                const itemDate = new Date(itemValue);
                                if (key.endsWith('From')) {
                                    return itemDate >= new Date(value);
                                } else if (key.endsWith('To')) {
                                    return itemDate <= new Date(value);
                                }
                                return true;
                            default:
                                return itemValue === value;
                        }
                    });
                });
            },

            /**
             * 生成篩選面板 HTML
             */
            renderPanel(config) {
                const { title = '進階篩選', fields = [] } = config;

                const fieldsHtml = fields.map(field => {
                    if (field.type === 'select') {
                        const optionsHtml = field.options.map(opt =>
                            `<option value="${opt.value}">${opt.label}</option>`
                        ).join('');
                        return `
                            <div class="filter-group">
                                <label>${field.label}</label>
                                <select onchange="AdvancedFilter.setFilter('${field.key}', this.value)">
                                    <option value="">全部</option>
                                    ${optionsHtml}
                                </select>
                            </div>
                        `;
                    } else if (field.type === 'date') {
                        return `
                            <div class="filter-group">
                                <label>${field.label}</label>
                                <input type="date" onchange="AdvancedFilter.setFilter('${field.key}', this.value)">
                            </div>
                        `;
                    } else {
                        return `
                            <div class="filter-group">
                                <label>${field.label}</label>
                                <input type="text" placeholder="${field.placeholder || ''}" oninput="AdvancedFilter.setFilter('${field.key}', this.value)">
                            </div>
                        `;
                    }
                }).join('');

                return `
                    <div class="filter-panel" id="${this.panelId}">
                        <div class="filter-panel-header">
                            <span class="filter-panel-title">${title}</span>
                            <div class="filter-panel-actions">
                                <button class="batch-btn batch-btn-secondary" onclick="AdvancedFilter.clearAll()">清除全部</button>
                            </div>
                        </div>
                        <div class="filter-grid">
                            ${fieldsHtml}
                        </div>
                        <div class="filter-tags" id="${this.panelId}Tags" style="display: none;"></div>
                    </div>
                `;
            }
        };

        // ========== 批量操作組件 ==========
        const BatchOperations = {
            selectedItems: new Set(),
            tableId: null,
            idField: null,
            callbacks: {},

            /**
             * 初始化批量操作
             * @param {Object} config - 配置選項
             * @param {string} config.tableId - 表格 ID
             * @param {string} config.toolbarId - 工具列 ID
             * @param {string} config.idField - ID 欄位名稱
             * @param {Object} config.callbacks - 回調函數 { onExport, onDelete, onStatusChange }
             */
            init(config) {
                this.tableId = config.tableId;
                this.toolbarId = config.toolbarId;
                this.idField = config.idField || 'id';
                this.callbacks = config.callbacks || {};
                this.selectedItems.clear();
                this.updateToolbar();
            },

            /**
             * 切換選擇狀態
             * @param {string} itemId - 項目 ID
             * @param {boolean} selected - 是否選中
             */
            toggleItem(itemId, selected) {
                if (selected) {
                    this.selectedItems.add(itemId);
                } else {
                    this.selectedItems.delete(itemId);
                }
                this.updateToolbar();
                this.updateRowStyle(itemId, selected);
                this.updateSelectAllCheckbox();
            },

            /**
             * 全選/取消全選
             * @param {Array} allIds - 所有項目 ID
             * @param {boolean} selected - 是否選中
             */
            toggleAll(allIds, selected) {
                if (selected) {
                    allIds.forEach(id => this.selectedItems.add(id));
                } else {
                    this.selectedItems.clear();
                }
                this.updateToolbar();
                this.updateAllRowStyles(selected);

                // 更新所有 checkbox
                const checkboxes = document.querySelectorAll(`#${this.tableId} .row-checkbox`);
                checkboxes.forEach(cb => cb.checked = selected);
            },

            /**
             * 清除所有選擇
             */
            clearSelection() {
                this.selectedItems.clear();
                this.updateToolbar();
                this.updateAllRowStyles(false);

                // 取消所有 checkbox
                const checkboxes = document.querySelectorAll(`#${this.tableId} .row-checkbox`);
                checkboxes.forEach(cb => cb.checked = false);

                const selectAllCb = document.querySelector(`#${this.tableId} .select-all-checkbox`);
                if (selectAllCb) selectAllCb.checked = false;
            },

            /**
             * 更新工具列狀態
             */
            updateToolbar() {
                const toolbar = document.getElementById(this.toolbarId);
                if (!toolbar) return;

                const count = this.selectedItems.size;
                if (count > 0) {
                    toolbar.classList.add('active');
                    const countEl = toolbar.querySelector('.selected-count');
                    if (countEl) countEl.textContent = count;
                } else {
                    toolbar.classList.remove('active');
                }
            },

            /**
             * 更新行樣式
             */
            updateRowStyle(itemId, selected) {
                const row = document.querySelector(`#${this.tableId} tr[data-id="${itemId}"]`);
                if (row) {
                    if (selected) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                }
            },

            /**
             * 更新所有行樣式
             */
            updateAllRowStyles(selected) {
                const rows = document.querySelectorAll(`#${this.tableId} tbody tr`);
                rows.forEach(row => {
                    if (selected) {
                        row.classList.add('selected');
                    } else {
                        row.classList.remove('selected');
                    }
                });
            },

            /**
             * 更新全選 checkbox 狀態
             */
            updateSelectAllCheckbox() {
                const selectAllCb = document.querySelector(`#${this.tableId} .select-all-checkbox`);
                const allCheckboxes = document.querySelectorAll(`#${this.tableId} .row-checkbox`);

                if (selectAllCb && allCheckboxes.length > 0) {
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);

                    selectAllCb.checked = allChecked;
                    selectAllCb.indeterminate = someChecked && !allChecked;
                }
            },

            /**
             * 取得選中的項目 ID 陣列
             */
            getSelectedIds() {
                return Array.from(this.selectedItems);
            },

            /**
             * 執行批量匯出
             */
            async exportSelected(format = 'csv') {
                const ids = this.getSelectedIds();
                if (ids.length === 0) return;

                if (this.callbacks.onExport) {
                    await this.callbacks.onExport(ids, format);
                }
            },

            /**
             * 執行批量刪除
             */
            async deleteSelected() {
                const ids = this.getSelectedIds();
                if (ids.length === 0) return;

                try {
                    await showConfirmDialog({
                        title: '批量刪除',
                        message: `確定要刪除選中的 ${ids.length} 個項目嗎？此操作無法復原。`,
                        type: 'danger',
                        confirmText: '確認刪除',
                        cancelText: '取消'
                    });

                    if (this.callbacks.onDelete) {
                        await this.callbacks.onDelete(ids);
                        this.clearSelection();
                    }
                } catch (e) {
                    // 用戶取消
                }
            },

            /**
             * 批量變更狀態
             */
            async changeStatus(newStatus) {
                const ids = this.getSelectedIds();
                if (ids.length === 0) return;

                if (this.callbacks.onStatusChange) {
                    await this.callbacks.onStatusChange(ids, newStatus);
                    this.clearSelection();
                }
            },

            /**
             * 生成批量操作工具列 HTML
             */
            renderToolbar(options = {}) {
                const {
                    showExport = true,
                    showDelete = true,
                    customActions = []
                } = options;

                const exportIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`;
                const deleteIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
                const clearIcon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;

                let actionsHtml = '';

                if (showExport) {
                    actionsHtml += `<button class="batch-btn batch-btn-primary" onclick="BatchOperations.exportSelected('csv')">${exportIcon} 匯出 CSV</button>`;
                }

                customActions.forEach(action => {
                    actionsHtml += `<button class="batch-btn ${action.className || 'batch-btn-secondary'}" onclick="${action.onClick}">${action.icon || ''} ${action.label}</button>`;
                });

                if (showDelete) {
                    actionsHtml += `<button class="batch-btn batch-btn-danger" onclick="BatchOperations.deleteSelected()">${deleteIcon} 刪除</button>`;
                }

                return `
                    <div class="batch-toolbar" id="${this.toolbarId}">
                        <div class="batch-toolbar-info">
                            <span>已選擇</span>
                            <span class="count selected-count">0</span>
                            <span>個項目</span>
                        </div>
                        <div class="batch-toolbar-actions">
                            ${actionsHtml}
                            <button class="batch-btn batch-btn-clear" onclick="BatchOperations.clearSelection()" title="清除選擇">${clearIcon}</button>
                        </div>
                    </div>
                `;
            }
        };

        // ========== 麵包屑導航組件 ==========
        const Breadcrumb = {
            // 視圖名稱對照
            viewNames: {
                'dashboard': '儀表板',
                'users': '用戶管理',
                'resources': '教材管理',
                'licenses': '授權管理',
                'announcements': '公告管理',
                'analytics': '數據分析',
                'support': '客服中心',
                'courses': '課程管理',
                'courseCategories': '課程類別',
                'questionbank': '題庫管理',
                'badges': '徽章系統',
                'learningPaths': '學習路徑',
                'scorm': 'SCORM',
                'lti': 'LTI 工具',
                'h5p': 'H5P 內容',
                'roles': '角色權限',
                'rubrics': '評分標準',
                'auditLogs': '審計日誌',
                'systemMonitor': '系統監控',
                'dataExport': '數據匯出',
                'automation': '自動化規則',
                'userActivity': '用戶活動'
            },

            // 視圖分類 (用於顯示父級)
            viewCategories: {
                'users': '主要功能',
                'resources': '主要功能',
                'licenses': '主要功能',
                'announcements': '主要功能',
                'analytics': '主要功能',
                'support': '主要功能',
                'courses': '教學管理',
                'courseCategories': '教學管理',
                'questionbank': '教學管理',
                'badges': '教學管理',
                'learningPaths': '教學管理',
                'scorm': '進階功能',
                'lti': '進階功能',
                'h5p': '進階功能',
                'roles': '進階功能',
                'rubrics': '進階功能',
                'auditLogs': '系統管理',
                'systemMonitor': '系統管理',
                'dataExport': '系統管理',
                'automation': '系統管理',
                'userActivity': '系統管理'
            },

            /**
             * 生成麵包屑 HTML
             * @param {string} currentView - 當前視圖名稱
             * @param {Array} additionalItems - 額外的麵包屑項目 [{name, onClick}]
             */
            render(currentView, additionalItems = []) {
                const viewName = this.viewNames[currentView] || currentView;
                const homeIcon = `<svg class="breadcrumb-home-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>`;

                let html = `
                    <nav class="breadcrumb" id="pageBreadcrumb">
                        <a class="breadcrumb-item" href="#" onclick="showView('dashboard'); return false;">
                            ${homeIcon}
                            <span>首頁</span>
                        </a>
                `;

                // 如果不是首頁，添加當前頁面
                if (currentView !== 'dashboard') {
                    html += `
                        <span class="breadcrumb-separator">›</span>
                        <span class="breadcrumb-item active">${viewName}</span>
                    `;
                }

                // 添加額外項目
                additionalItems.forEach(item => {
                    html += `
                        <span class="breadcrumb-separator">›</span>
                        ${item.onClick
                            ? `<a class="breadcrumb-item" href="#" onclick="${item.onClick}; return false;">${item.name}</a>`
                            : `<span class="breadcrumb-item active">${item.name}</span>`
                        }
                    `;
                });

                html += '</nav>';
                return html;
            },

            /**
             * 更新指定容器的麵包屑
             * @param {string} containerId - 容器 ID
             * @param {string} currentView - 當前視圖
             * @param {Array} additionalItems - 額外項目
             */
            update(containerId, currentView, additionalItems = []) {
                const container = document.getElementById(containerId);
                if (container) {
                    const existingBreadcrumb = container.querySelector('.breadcrumb');
                    if (existingBreadcrumb) {
                        existingBreadcrumb.outerHTML = this.render(currentView, additionalItems);
                    } else {
                        container.insertAdjacentHTML('afterbegin', this.render(currentView, additionalItems));
                    }
                }
            }
        };

        // ========== 客服中心全域變數 ==========
        let adminSocket = null;
        let adminChatRooms = [];
        let currentAdminChatId = null;
        let adminTypingTimeout = null;
        let currentSupportFilter = 'waiting';

        // 用戶管理全域變數
        let allUsers = [];
        let currentRoleFilter = 'all';

        // 角色名稱對照
        const roleNames = {
            'educator': '建橋者',
            'trainer': '橋樑工匠',
            'creator': '知識建築師',
            'student': '探橋者'
        };

        // 當前視圖狀態
        let currentViewName = 'dashboard';

        // View Management
        function showView(viewName) {
            document.querySelectorAll('.admin-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(`${viewName}View`).classList.add('active');
            document.querySelector(`.nav-item[data-view="${viewName}"]`)?.classList.add('active');

            // 更新當前視圖狀態
            currentViewName = viewName;

            // 更新麵包屑導航
            updateBreadcrumb(viewName);

            // Load data for the view
            switch(viewName) {
                case 'dashboard': loadDashboard(); break;
                case 'users': loadUsers(); break;
                case 'resources': loadResources(); break;
                case 'licenses': loadLicenses(); break;
                case 'announcements': loadAnnouncements(); break;
                case 'analytics': loadAnalytics(); break;
                case 'support': loadAdminChatRooms(); break;
                // New views
                case 'courses': loadCourses(); break;
                case 'courseCategories': loadCourseCategories(); break;
                case 'questionbank': loadQuestionBank(); break;
                case 'badges': loadBadges(); break;
                case 'learningPaths': loadLearningPaths(); break;
                case 'scorm': loadScorm(); break;
                case 'lti': loadLti(); break;
                case 'h5p': loadH5p(); break;
                case 'roles': loadRoles(); break;
                case 'rubrics': loadRubrics(); break;
                case 'auditLogs': loadAuditLogs(); break;
                // Phase 3 新增視圖
                case 'systemMonitor': loadSystemHealth(); break;
                case 'dataExport': loadDataExport(); break;
                case 'automation': loadAutomationRules(); break;
                case 'userActivity': loadUserActivity(); break;
            }
        }

        // 更新麵包屑導航
        function updateBreadcrumb(viewName, additionalItems = []) {
            const viewContainer = document.getElementById(`${viewName}View`);
            if (viewContainer) {
                // 檢查是否已有麵包屑容器
                let breadcrumbContainer = viewContainer.querySelector('.breadcrumb-container');
                if (!breadcrumbContainer) {
                    // 在視圖的第一個子元素前插入麵包屑容器
                    breadcrumbContainer = document.createElement('div');
                    breadcrumbContainer.className = 'breadcrumb-container';
                    viewContainer.insertBefore(breadcrumbContainer, viewContainer.firstChild);
                }
                breadcrumbContainer.innerHTML = Breadcrumb.render(viewName, additionalItems);
            }
        }

        // 初始化確認對話框組件
        ConfirmDialog.init();

        // Auth
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const result = await API.auth.login(email, password);
                if (result.success && result.data.user.isAdmin) {
                    document.getElementById('loginView').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'flex';
                    document.getElementById('adminName').textContent = result.data.user.displayName;
                    loadDashboard();
                } else if (result.success && !result.data.user.isAdmin) {
                    errorDiv.textContent = '此帳號不是管理員';
                    errorDiv.style.display = 'block';
                    API.clearTokens();
                } else {
                    errorDiv.textContent = result.message || '登入失敗';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '登入失敗，請檢查網路連線';
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await API.auth.logout();
            // 跳轉回主平台登入頁面
            window.location.href = '/platform/';
        });

        // Load Dashboard
        async function loadDashboard() {
            try {
                const result = await API.admin.getDashboard();
                if (result.success) {
                    const { stats, recentUsers } = result.data;

                    // 更新主要統計卡片
                    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                    document.getElementById('totalResources').textContent = stats.publishedResources || 0;

                    // 更新課程數（如果有）
                    const totalCoursesEl = document.getElementById('totalCourses');
                    if (totalCoursesEl) {
                        totalCoursesEl.textContent = stats.totalCourses || 0;
                    }

                    // 更新今日活躍用戶
                    const activeUsersTodayEl = document.getElementById('activeUsersToday');
                    if (activeUsersTodayEl) {
                        activeUsersTodayEl.textContent = stats.activeUsersToday || 0;
                    }

                    // 更新系統概覽區塊
                    const activeLicensesEl = document.getElementById('activeLicenses');
                    if (activeLicensesEl) {
                        activeLicensesEl.textContent = stats.activeLicenses || 0;
                    }

                    const pendingRequestsEl = document.getElementById('pendingRequests');
                    if (pendingRequestsEl) {
                        pendingRequestsEl.textContent = stats.pendingLicenses || 0;
                    }

                    const weeklyNewUsersEl = document.getElementById('weeklyNewUsers');
                    if (weeklyNewUsersEl) {
                        weeklyNewUsersEl.textContent = stats.weeklyNewUsers || 0;
                    }

                    const weeklyNewCoursesEl = document.getElementById('weeklyNewCourses');
                    if (weeklyNewCoursesEl) {
                        weeklyNewCoursesEl.textContent = stats.weeklyNewCourses || 0;
                    }

                    // 更新待處理事項提示
                    const pendingLicensesCountEl = document.getElementById('pendingLicensesCount');
                    if (pendingLicensesCountEl) {
                        pendingLicensesCountEl.textContent = stats.pendingLicenses || 0;
                    }

                    const pendingChatsCountEl = document.getElementById('pendingChatsCount');
                    if (pendingChatsCountEl) {
                        pendingChatsCountEl.textContent = stats.pendingChats || 0;
                    }

                    const pendingReportsCountEl = document.getElementById('pendingReportsCount');
                    if (pendingReportsCountEl) {
                        pendingReportsCountEl.textContent = stats.pendingReports || 0;
                    }

                    // 更新側邊欄的待處理標籤
                    const pendingLicensesBadge = document.getElementById('pendingLicensesBadge');
                    if (pendingLicensesBadge) {
                        pendingLicensesBadge.textContent = stats.pendingLicenses || 0;
                    }

                    // Recent users table
                    const tbody = document.getElementById('recentUsersTable');
                    if (tbody) {
                        if (recentUsers && recentUsers.length > 0) {
                            const roleMap = {
                                'educator': '建橋者',
                                'trainer': '橋樑工匠',
                                'creator': '知識建築師',
                                'admin': '管理員',
                                'student': '探橋者'
                            };

                            tbody.innerHTML = recentUsers.map(u => `
                                <tr>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-avatar">${(u.displayName || 'U')[0]}</div>
                                            <div>
                                                <div class="user-name">${u.displayName || 'Unknown'}</div>
                                                <div class="user-email">${u.email}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="role-badge role-${u.role || 'educator'}">${roleMap[u.role] || u.role || '建橋者'}</span></td>
                                    <td>${formatDate(u.createdAt)}</td>
                                </tr>
                            `).join('');
                        } else {
                            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 2rem; color: var(--text-secondary);">尚無用戶</td></tr>';
                        }
                    }

                    // 載入系統警示（如果有異常登入等）
                    loadSystemAlerts();
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
            }
        }

        // 載入系統警示
        async function loadSystemAlerts() {
            try {
                // 這裡可以從 API 獲取系統警示，目前先使用空列表
                const alerts = [];

                const alertsList = document.getElementById('systemAlertsList');
                const alertCount = document.getElementById('alertCount');

                if (alertCount) {
                    alertCount.textContent = alerts.length;
                    alertCount.style.display = alerts.length > 0 ? 'inline-block' : 'none';
                }

                if (alertsList) {
                    if (alerts.length === 0) {
                        alertsList.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity: 0.5; margin-bottom: 0.5rem;">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                <p>系統運作正常，暫無警示</p>
                            </div>
                        `;
                    } else {
                        alertsList.innerHTML = alerts.map(alert => `
                            <div style="display: flex; align-items: center; padding: 0.75rem; background: var(--surface-light); border-radius: 8px; margin-bottom: 0.5rem;">
                                <div style="width: 32px; height: 32px; border-radius: 8px; background: ${alert.severity === 'high' ? 'var(--terracotta-light)' : 'var(--sand-light)'}; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="${alert.severity === 'high' ? 'var(--terracotta)' : 'var(--sand)'}" stroke-width="2">
                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                    </svg>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; margin-bottom: 2px;">${alert.title}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${alert.message}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Load system alerts error:', error);
            }
        }

        // Load Users
        async function loadUsers() {
            try {
                const result = await API.admin.getUsers();
                if (result.success) {
                    allUsers = result.data || [];
                    updateRoleCounts();
                    renderUsers(getFilteredUsers());
                }
            } catch (error) {
                console.error('Load users error:', error);
            }
        }

        // 更新角色統計數量
        function updateRoleCounts() {
            const counts = {
                all: allUsers.length,
                educator: 0,
                trainer: 0,
                creator: 0,
                student: 0
            };

            allUsers.forEach(u => {
                const role = u.role || 'educator';
                if (counts[role] !== undefined) {
                    counts[role]++;
                }
            });

            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countEducator').textContent = counts.educator;
            document.getElementById('countTrainer').textContent = counts.trainer;
            document.getElementById('countCreator').textContent = counts.creator;
            document.getElementById('countStudent').textContent = counts.student;
        }

        // 根據角色篩選用戶
        function filterUsersByRole(role) {
            currentRoleFilter = role;

            // 更新卡片選中狀態
            document.querySelectorAll('.role-stats .stat-card').forEach(card => {
                card.style.borderColor = 'transparent';
            });
            const selectedCard = document.getElementById(`roleCard${role.charAt(0).toUpperCase() + role.slice(1)}`);
            if (selectedCard) {
                selectedCard.style.borderColor = 'var(--olive)';
            }

            renderUsers(getFilteredUsers());
        }

        // 搜尋篩選用戶
        function filterUsers() {
            renderUsers(getFilteredUsers());
        }

        // 取得篩選後的用戶列表
        function getFilteredUsers() {
            const searchQuery = (document.getElementById('userSearchInput')?.value || '').toLowerCase();

            return allUsers.filter(u => {
                // 角色篩選
                if (currentRoleFilter !== 'all' && (u.role || 'educator') !== currentRoleFilter) {
                    return false;
                }

                // 搜尋篩選
                if (searchQuery) {
                    const name = (u.displayName || '').toLowerCase();
                    const email = (u.email || '').toLowerCase();
                    if (!name.includes(searchQuery) && !email.includes(searchQuery)) {
                        return false;
                    }
                }

                return true;
            });
        }

        // 渲染用戶列表
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            const thead = document.getElementById('usersTableHead');

            // 確保有表頭的全選 checkbox
            if (thead && !thead.querySelector('.select-all-checkbox')) {
                const firstTh = thead.querySelector('tr th');
                if (firstTh) {
                    const selectAllTh = document.createElement('th');
                    selectAllTh.className = 'table-checkbox-cell';
                    selectAllTh.innerHTML = `<input type="checkbox" class="table-checkbox select-all-checkbox" onchange="handleUserSelectAll(this.checked)">`;
                    firstTh.parentElement.insertBefore(selectAllTh, firstTh);
                }
            }

            // 確保有批量操作工具列
            let batchToolbar = document.getElementById('usersBatchToolbar');
            if (!batchToolbar) {
                const tableContainer = document.querySelector('#usersView .table-container') ||
                                       document.querySelector('#usersView table')?.parentElement;
                if (tableContainer) {
                    tableContainer.insertAdjacentHTML('beforebegin', BatchOperations.renderToolbar({
                        showExport: true,
                        showDelete: false,
                        customActions: [
                            {
                                label: '批量停用',
                                className: 'batch-btn-secondary',
                                onClick: "batchChangeUserStatus('suspended')"
                            },
                            {
                                label: '批量啟用',
                                className: 'batch-btn-secondary',
                                onClick: "batchChangeUserStatus('active')"
                            }
                        ]
                    }).replace('id="undefined"', 'id="usersBatchToolbar"'));

                    // 初始化批量操作
                    BatchOperations.init({
                        tableId: 'usersTable',
                        toolbarId: 'usersBatchToolbar',
                        idField: 'userId',
                        callbacks: {
                            onExport: exportUsers,
                            onStatusChange: batchUpdateUserStatus
                        }
                    });
                }
            }

            if (users.length > 0) {
                tbody.innerHTML = users.map(u => {
                    const role = u.role || 'educator';
                    const roleName = roleNames[role] || role;
                    const roleColor = getRoleColor(role);
                    const isSelected = BatchOperations.selectedItems.has(u.userId);

                    return `
                        <tr data-role="${role}" data-id="${u.userId}" class="${isSelected ? 'selected' : ''}">
                            <td class="table-checkbox-cell">
                                <input type="checkbox" class="table-checkbox row-checkbox" ${isSelected ? 'checked' : ''} onchange="BatchOperations.toggleItem('${u.userId}', this.checked)">
                            </td>
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">${(u.displayName || 'U')[0]}</div>
                                    <div>
                                        <div class="user-name">${u.displayName || 'Unknown'}</div>
                                        <div class="user-email">${u.email}</div>
                                    </div>
                                </div>
                            </td>
                            <td><span style="color: ${roleColor}; font-weight: 500;">${roleName}</span></td>
                            <td>${u.subscriptionTier || 'free'}</td>
                            <td><span class="status-badge ${u.status}">${u.status}</span></td>
                            <td>${formatDate(u.createdAt)}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="toggleUserStatus('${u.userId}', '${u.status}')">
                                    ${u.status === 'active' ? '停用' : '啟用'}
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7">無符合條件的用戶</td></tr>';
            }
        }

        // 用戶全選處理
        function handleUserSelectAll(checked) {
            const allIds = getFilteredUsers().map(u => u.userId);
            BatchOperations.toggleAll(allIds, checked);
        }

        // 批量變更用戶狀態
        async function batchChangeUserStatus(newStatus) {
            const ids = BatchOperations.getSelectedIds();
            if (ids.length === 0) return;

            const actionText = newStatus === 'suspended' ? '停用' : '啟用';

            try {
                await showConfirmDialog({
                    title: `批量${actionText}用戶`,
                    message: `確定要${actionText}選中的 ${ids.length} 個用戶帳號嗎？`,
                    type: newStatus === 'suspended' ? 'warning' : 'info',
                    confirmText: `確認${actionText}`,
                    cancelText: '取消'
                });

                await batchUpdateUserStatus(ids, newStatus);
            } catch (e) {
                // 用戶取消
            }
        }

        // 批量更新用戶狀態 API
        async function batchUpdateUserStatus(userIds, newStatus) {
            let successCount = 0;
            for (const userId of userIds) {
                const result = await API.admin.updateUserStatus(userId, newStatus);
                if (result.success) {
                    successCount++;
                    const userIndex = allUsers.findIndex(u => u.userId === userId);
                    if (userIndex !== -1) {
                        allUsers[userIndex].status = newStatus;
                    }
                }
            }

            if (successCount > 0) {
                showToast(`成功更新 ${successCount} 個用戶`, 'success');
                BatchOperations.clearSelection();
                renderUsers(getFilteredUsers());
            }
        }

        // 匯出用戶
        async function exportUsers(userIds, format = 'csv') {
            const users = allUsers.filter(u => userIds.includes(u.userId));
            if (users.length === 0) return;

            if (format === 'csv') {
                const headers = ['姓名', '電子郵件', '角色', '訂閱方案', '狀態', '註冊日期'];
                const rows = users.map(u => [
                    u.displayName || '',
                    u.email || '',
                    roleNames[u.role] || u.role || '',
                    u.subscriptionTier || 'free',
                    u.status || '',
                    formatDate(u.createdAt) || ''
                ]);

                const csvContent = [headers, ...rows]
                    .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                    .join('\n');

                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `users_export_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast(`已匯出 ${users.length} 個用戶`, 'success');
            }
        }

        // 取得角色對應顏色
        function getRoleColor(role) {
            const colors = {
                'educator': '#3b82f6',
                'trainer': '#f59e0b',
                'creator': '#8b5cf6',
                'student': '#10b981'
            };
            return colors[role] || '#6b7280';
        }

        // Load Resources
        // 教材類型標籤
        const typeLabels = {
            video: '影音教材',
            interactive: '互動教材',
            document: '文件講義',
            quiz: '測驗題庫'
        };

        // 教材分類標籤
        const categoryLabels = {
            math: '數學',
            chinese: '國文',
            english: '英文',
            science: '自然科學',
            social: '社會科學',
            business: '商業管理',
            technology: '資訊科技',
            arts: '藝術人文'
        };

        // 狀態標籤
        const statusLabels = {
            draft: '草稿',
            published: '已發布',
            archived: '已下架'
        };

        // 儲存教材資料供編輯使用
        let allResources = [];

        async function loadResources() {
            try {
                const result = await API.resources.list({ limit: 100 });
                const tbody = document.getElementById('resourcesTableBody');
                if (result.success && result.data.length > 0) {
                    allResources = result.data;
                    tbody.innerHTML = result.data.map(r => `
                        <tr>
                            <td>${r.title}</td>
                            <td>${typeLabels[r.type] || r.type}</td>
                            <td>${categoryLabels[r.category] || r.category}</td>
                            <td><span class="status-badge ${r.status}">${statusLabels[r.status] || r.status}</span></td>
                            <td>${r.viewCount || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="editResource('${r.resourceId}')">編輯</button>
                                ${r.status === 'draft' ? `<button class="btn btn-sm btn-primary" onclick="publishResource('${r.resourceId}')">發布</button>` : ''}
                                ${r.status === 'published' ? `<button class="btn btn-sm btn-secondary" onclick="archiveResource('${r.resourceId}')">下架</button>` : ''}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">尚無教材</td></tr>';
                }
            } catch (error) {
                console.error('Load resources error:', error);
            }
        }

        function editResource(resourceId) {
            const resource = allResources.find(r => r.resourceId === resourceId);
            if (resource) {
                openEditResourceModal(resource);
            }
        }

        async function archiveResource(resourceId) {
            try {
                await showConfirmDialog({
                    title: '下架教材',
                    message: '下架後，此教材將不會顯示在平台上。確定要下架嗎？',
                    type: 'warning',
                    confirmText: '確認下架',
                    cancelText: '取消'
                });

                const result = await API.admin.updateResource(resourceId, { status: 'archived' });
                if (result.success) {
                    loadResources();
                } else {
                    alert(result.message || '操作失敗');
                }
            } catch (e) {
                // 用戶取消操作
            }
        }

        // Load Licenses
        async function loadLicenses() {
            try {
                const result = await API.admin.getLicenses();
                const tbody = document.getElementById('licensesTableBody');
                if (result.success && result.data.length > 0) {
                    tbody.innerHTML = result.data.map(l => `
                        <tr>
                            <td>${l.resourceTitle}</td>
                            <td>${l.userId}</td>
                            <td>${l.licenseType}</td>
                            <td><span class="status-badge ${l.status}">${l.status}</span></td>
                            <td>${l.expiryDate ? formatDate(l.expiryDate) : '-'}</td>
                            <td>
                                ${l.status === 'pending' ? `
                                    <button class="btn btn-sm btn-primary" onclick="approveLicense('${l.licenseId}', true)">核准</button>
                                    <button class="btn btn-sm btn-secondary" onclick="approveLicense('${l.licenseId}', false)">拒絕</button>
                                ` : '-'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">尚無授權記錄</td></tr>';
                }
            } catch (error) {
                console.error('Load licenses error:', error);
            }
        }

        // Load Announcements
        async function loadAnnouncements() {
            try {
                const result = await API.admin.getAllAnnouncements();
                const tbody = document.getElementById('announcementsTableBody');
                if (result.success && result.data.length > 0) {
                    tbody.innerHTML = result.data.map(a => `
                        <tr>
                            <td>${a.title}</td>
                            <td>${a.priority}</td>
                            <td><span class="status-badge ${a.status}">${a.status}</span></td>
                            <td>${formatDate(a.publishAt)}</td>
                            <td>${a.viewCount || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="deleteAnnouncement('${a.announcementId}')">刪除</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">尚無公告</td></tr>';
                }
            } catch (error) {
                console.error('Load announcements error:', error);
            }
        }

        // Analytics Charts instances
        let userGrowthChart = null;
        let userRolesChart = null;
        let resourceCategoriesChart = null;
        let licenseStatusChart = null;

        // Load Analytics
        async function loadAnalytics() {
            try {
                const result = await API.admin.getAnalytics();
                if (!result.success || !result.data) return;

                const data = result.data;
                const metrics = data.metrics || {};

                // ========== Update Key Metrics ==========
                updateMetricCard('metricTotalUsers', 'metricUsersTrend', metrics.totalUsers || 0, metrics.newUsersThisMonth || 0, '本月');
                updateMetricCard('metricNewUsers', 'metricNewUsersTrend', metrics.newUsersThisMonth || 0, metrics.newUsersLastMonth || 0);
                updateMetricCard('metricResources', 'metricResourcesTrend', metrics.totalResources || 0, metrics.resourcesLastMonth || 0);
                updateMetricCard('metricLicenses', 'metricLicensesTrend', metrics.activeLicenses || 0, metrics.licensesLastMonth || 0);

                const ratingEl = document.getElementById('metricRating');
                if (ratingEl) ratingEl.textContent = metrics.avgCustomerRating && metrics.avgCustomerRating > 0 ? metrics.avgCustomerRating.toFixed(1) : '-';

                // ========== User Growth Chart ==========
                if (data.userGrowthTrend) renderUserGrowthChart(data.userGrowthTrend);

                // ========== User Roles Chart ==========
                if (data.userRoles) renderUserRolesChart(data.userRoles);

                // ========== Resource Categories Chart ==========
                if (data.resourceCategories) renderResourceCategoriesChart(data.resourceCategories);

                // ========== License Status Chart ==========
                if (data.licenseStatus) renderLicenseStatusChart(data.licenseStatus);

                // ========== Top Resources Table ==========
                if (data.topResources) renderTopResources(data.topResources);

                // ========== Support Stats ==========
                const stats = data.supportStats || {};
                const totalChatsEl = document.getElementById('supportTotalChats');
                const closedChatsEl = document.getElementById('supportClosedChats');
                const avgRatingEl = document.getElementById('supportAvgRating');
                const satisfactionEl = document.getElementById('supportSatisfaction');

                if (totalChatsEl) totalChatsEl.textContent = stats.totalChats || 0;
                if (closedChatsEl) closedChatsEl.textContent = stats.closedChats || 0;
                if (avgRatingEl) avgRatingEl.textContent = stats.avgRating && stats.avgRating > 0 ? stats.avgRating : '-';
                if (satisfactionEl) satisfactionEl.textContent = (stats.satisfactionRate || 0) + '%';

            } catch (error) {
                console.error('Load analytics error:', error);
            }
        }

        function updateMetricCard(valueId, trendId, current, previous, suffix = '') {
            const valueEl = document.getElementById(valueId);
            const trendEl = document.getElementById(trendId);
            if (valueEl) valueEl.textContent = current;
            if (trendEl && previous > 0) {
                const change = Math.round(((current - previous) / previous) * 100);
                const isUp = change >= 0;
                trendEl.className = `metric-trend ${isUp ? 'up' : 'down'}`;
                trendEl.textContent = `${isUp ? '↑' : '↓'} ${Math.abs(change)}%${suffix ? ' ' + suffix : ''}`;
            }
        }

        function renderUserGrowthChart(trendData) {
            const ctx = document.getElementById('userGrowthChart');
            if (!ctx) return;

            if (userGrowthChart) userGrowthChart.destroy();

            userGrowthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(d => d.label),
                    datasets: [
                        {
                            label: '累計用戶',
                            data: trendData.map(d => d.total),
                            borderColor: '#4A5D23',
                            backgroundColor: 'rgba(74, 93, 35, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '新增用戶',
                            data: trendData.map(d => d.newUsers),
                            borderColor: '#C17A5E',
                            backgroundColor: 'rgba(193, 122, 94, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderUserRolesChart(roles) {
            const ctx = document.getElementById('userRolesChart');
            if (!ctx) return;

            if (userRolesChart) userRolesChart.destroy();

            const roleLabels = { educator: '教師', student: '學生', trainer: '培訓師', admin: '管理員' };
            const labels = Object.keys(roles).map(r => roleLabels[r] || r);
            const values = Object.values(roles);

            userRolesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#4A5D23', '#6B7F3A', '#C17A5E', '#A8B89A'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderResourceCategoriesChart(categories) {
            const ctx = document.getElementById('resourceCategoriesChart');
            if (!ctx) return;

            if (resourceCategoriesChart) resourceCategoriesChart.destroy();

            const categoryLabels = {
                math: '數學', chinese: '國文', english: '英文', science: '自然科學',
                social: '社會科學', business: '商業管理', technology: '資訊科技',
                arts: '藝術人文', art: '藝術', pe: '體育', other: '其他'
            };
            const labels = Object.keys(categories).map(c => categoryLabels[c] || c);
            const values = Object.values(categories);

            resourceCategoriesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '教材數量',
                        data: values,
                        backgroundColor: '#4A5D23',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function renderLicenseStatusChart(status) {
            const ctx = document.getElementById('licenseStatusChart');
            if (!ctx) return;

            if (licenseStatusChart) licenseStatusChart.destroy();

            const statusLabels = { pending: '待審核', active: '使用中', expired: '已過期', rejected: '已拒絕' };
            const statusColors = { pending: '#ffc107', active: '#28a745', expired: '#6c757d', rejected: '#dc3545' };
            const labels = Object.keys(status).map(s => statusLabels[s] || s);
            const values = Object.values(status);
            const colors = Object.keys(status).map(s => statusColors[s] || '#ccc');

            licenseStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderTopResources(resources) {
            const tbody = document.getElementById('topResourcesBody');
            if (!tbody) return;

            if (!resources || resources.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--gray-400);">暫無資料</td></tr>';
                return;
            }

            const categoryLabels = {
                math: '數學', chinese: '國文', english: '英文', science: '自然科學',
                social: '社會科學', business: '商業管理', technology: '資訊科技',
                arts: '藝術人文', art: '藝術', pe: '體育', other: '其他'
            };

            tbody.innerHTML = resources.map((r, i) => `
                <tr>
                    <td style="font-weight: 600; color: var(--olive);">${i + 1}</td>
                    <td>
                        <div style="font-weight: 500;">${escapeHtml(r.title || '')}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">${categoryLabels[r.category] || r.category || '-'}</div>
                    </td>
                    <td>${(r.viewCount || 0).toLocaleString()}</td>
                    <td>${r.rating && r.rating > 0 ? r.rating.toFixed(1) : '-'}</td>
                    <td>${r.licensedCount || 0}</td>
                </tr>
            `).join('');
        }

        // Actions
        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
            const user = allUsers.find(u => u.userId === userId);
            const userName = user ? user.displayName : '此用戶';

            const actionText = newStatus === 'suspended' ? '停用' : '啟用';
            const messageText = newStatus === 'suspended'
                ? `停用後，${userName} 將無法登入系統。`
                : `啟用後，${userName} 將可以正常使用系統。`;

            try {
                await showConfirmDialog({
                    title: `${actionText}用戶帳號`,
                    message: messageText,
                    type: newStatus === 'suspended' ? 'warning' : 'info',
                    confirmText: actionText,
                    cancelText: '取消'
                });

                const result = await API.admin.updateUserStatus(userId, newStatus);
                if (result.success) {
                    // 更新本地資料
                    const userIndex = allUsers.findIndex(u => u.userId === userId);
                    if (userIndex !== -1) {
                        allUsers[userIndex].status = newStatus;
                    }
                    renderUsers(getFilteredUsers());
                }
            } catch (e) {
                // 用戶取消操作
            }
        }

        async function publishResource(resourceId) {
            const result = await API.admin.publishResource(resourceId);
            if (result.success) loadResources();
        }

        async function deleteResource(resourceId) {
            try {
                await showConfirmDialog({
                    title: '下架教材',
                    message: '下架後，此教材將不會顯示在平台上。確定要下架嗎？',
                    type: 'warning',
                    confirmText: '確認下架',
                    cancelText: '取消'
                });

                const result = await API.admin.deleteResource(resourceId);
                if (result.success) loadResources();
            } catch (e) {
                // 用戶取消操作
            }
        }

        async function approveLicense(licenseId, approved) {
            const result = await API.admin.approveLicense(licenseId, approved);
            if (result.success) {
                loadLicenses();
                loadDashboard();
            }
        }

        async function deleteAnnouncement(announcementId) {
            try {
                await showConfirmDialog({
                    title: '刪除公告',
                    message: '刪除後將無法復原。確定要刪除此公告嗎？',
                    type: 'danger',
                    confirmText: '確認刪除',
                    cancelText: '取消'
                });

                const result = await API.admin.deleteAnnouncement(announcementId);
                if (result.success) loadAnnouncements();
            } catch (e) {
                // 用戶取消操作
            }
        }

        // Modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openCreateAnnouncementModal() {
            document.getElementById('createAnnouncementForm').reset();
            openModal('createAnnouncementModal');
        }

        // 切換價格欄位顯示
        function togglePriceField(pricingModel) {
            const priceGroup = document.getElementById('priceFieldGroup');
            if (pricingModel === 'free') {
                priceGroup.style.display = 'none';
            } else {
                priceGroup.style.display = 'block';
            }
        }

        // 開啟新增教材 Modal
        function openCreateResourceModal() {
            document.getElementById('createResourceForm').reset();
            document.getElementById('resourceModalTitle').textContent = '新增教材';
            document.querySelector('#createResourceForm [name="resourceId"]').value = '';
            document.getElementById('priceFieldGroup').style.display = 'block';
            openModal('createResourceModal');
        }

        // 開啟編輯教材 Modal
        function openEditResourceModal(resource) {
            const form = document.getElementById('createResourceForm');
            form.reset();
            document.getElementById('resourceModalTitle').textContent = '編輯教材';

            // 填入現有資料
            form.querySelector('[name="resourceId"]').value = resource.resourceId;
            form.querySelector('[name="title"]').value = resource.title || '';
            form.querySelector('[name="description"]').value = resource.description || '';
            form.querySelector('[name="type"]').value = resource.type || 'video';
            form.querySelector('[name="category"]').value = resource.category || 'math';
            form.querySelector('[name="gradeLevel"]').value = resource.gradeLevel || 'junior';
            form.querySelector('[name="duration"]').value = resource.duration || '';
            form.querySelector('[name="unitCount"]').value = resource.unitCount || '';
            form.querySelector('[name="tags"]').value = (resource.tags || []).join(', ');
            form.querySelector('[name="pricingModel"]').value = resource.pricingModel || 'license';
            form.querySelector('[name="price"]').value = resource.price || '';
            form.querySelector('[name="status"]').value = resource.status || 'draft';

            // 目標受眾
            const audiences = resource.targetAudience || ['educator', 'student'];
            form.querySelectorAll('[name="targetAudience"]').forEach(cb => {
                cb.checked = audiences.includes(cb.value);
            });

            togglePriceField(resource.pricingModel || 'license');
            openModal('createResourceModal');
        }

        async function submitResourceForm() {
            const form = document.getElementById('createResourceForm');
            const formData = new FormData(form);

            // 收集目標受眾（多選）
            const targetAudience = [];
            form.querySelectorAll('[name="targetAudience"]:checked').forEach(cb => {
                targetAudience.push(cb.value);
            });

            // 處理標籤
            const tagsStr = formData.get('tags') || '';
            const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t);

            const data = {
                title: formData.get('title'),
                description: formData.get('description'),
                type: formData.get('type'),
                category: formData.get('category'),
                gradeLevel: formData.get('gradeLevel'),
                duration: formData.get('duration') ? parseInt(formData.get('duration')) : null,
                unitCount: formData.get('unitCount') ? parseInt(formData.get('unitCount')) : null,
                tags: tags,
                pricingModel: formData.get('pricingModel'),
                price: formData.get('price') ? parseInt(formData.get('price')) : null,
                targetAudience: targetAudience,
                status: formData.get('status')
            };

            const resourceId = formData.get('resourceId');
            let result;

            if (resourceId) {
                // 編輯模式
                result = await API.admin.updateResource(resourceId, data);
            } else {
                // 新增模式
                result = await API.admin.createResource(data);
            }

            if (result.success) {
                closeModal('createResourceModal');
                loadResources();
            } else {
                alert(result.message || '操作失敗');
            }
        }

        async function submitCreateAnnouncement() {
            const form = document.getElementById('createAnnouncementForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const result = await API.admin.createAnnouncement(data);
            if (result.success) {
                closeModal('createAnnouncementModal');
                loadAnnouncements();
            } else {
                alert(result.message || '發布失敗');
            }
        }

        function openCreateUserModal() {
            document.getElementById('createUserForm').reset();
            openModal('createUserModal');
        }

        async function submitCreateUser() {
            const form = document.getElementById('createUserForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Validate
            if (!data.displayName || !data.email || !data.password) {
                alert('請填寫所有必填欄位');
                return;
            }

            if (data.password.length < 6) {
                alert('密碼至少需要 6 個字元');
                return;
            }

            try {
                const result = await API.admin.createUser(data);
                if (result.success) {
                    closeModal('createUserModal');
                    loadUsers();
                    alert('用戶已成功建立！');
                } else {
                    alert(result.message || '建立用戶失敗');
                }
            } catch (error) {
                console.error('Create user error:', error);
                alert('建立用戶失敗，請稍後再試');
            }
        }

        // Helpers
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-TW');
        }

        // Navigation
        document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', () => showView(item.dataset.view));
        });

        // ========== 客服中心功能 ==========

        // HTML 轉義函數
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 格式化時間
        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();

            if (isToday) {
                return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }) + ' ' +
                       date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // 顯示提示訊息
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem;
                background: ${type === 'error' ? '#dc3545' : '#28a745'}; color: white;
                border-radius: 8px; z-index: 10000; animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // 初始化管理員 WebSocket
        function initAdminSocket() {
            const token = localStorage.getItem('accessToken');
            if (!token) return;

            try {
                adminSocket = io({
                    auth: { token },
                    transports: ['websocket', 'polling']
                });

                adminSocket.on('connected', (data) => {
                    console.log('[Admin Chat] WebSocket 連線成功:', data);
                });

                adminSocket.on('chat:joined', (data) => {
                    console.log('[Admin Chat] 已加入聊天室:', data);
                    renderAdminMessages(data.messages);
                    updateAdminChatHeader(data.chatRoom);
                });

                adminSocket.on('message:new', (message) => {
                    console.log('[Admin Chat] 收到新訊息:', message);
                    if (message.chatId === currentAdminChatId) {
                        appendAdminMessage(message);
                        scrollAdminChatToBottom();
                        adminSocket.emit('message:read', { chatId: currentAdminChatId });
                    }
                    loadAdminChatRooms();

                    // 瀏覽器通知
                    if (message.senderRole === 'user' && document.hidden) {
                        showAdminNotification('用戶訊息', `${message.senderName}: ${message.content}`);
                    }
                });

                adminSocket.on('typing:indicator', (data) => {
                    if (data.chatId === currentAdminChatId) {
                        showAdminTypingIndicator(data.isTyping, data.userName);
                    }
                });

                adminSocket.on('queue:update', () => {
                    loadAdminChatRooms();
                });

                adminSocket.on('queue:message', (data) => {
                    loadAdminChatRooms();
                    showAdminNotification('新客服請求', `${data.userName}: ${data.message}`);
                });

                adminSocket.on('chat:closed', (data) => {
                    if (data.chatId === currentAdminChatId) {
                        appendAdminSystemMessage('對話已結束');
                        document.getElementById('adminChatInput').style.display = 'none';
                    }
                    loadAdminChatRooms();
                });

                adminSocket.on('disconnect', () => {
                    console.log('[Admin Chat] WebSocket 斷線');
                });

            } catch (error) {
                console.error('[Admin Chat] WebSocket 初始化失敗:', error);
            }
        }

        // 載入客服聊天室列表
        async function loadAdminChatRooms() {
            try {
                const response = await API.request('/chat/admin/rooms');
                if (response.success) {
                    adminChatRooms = response.data;
                    renderAdminChatQueue();
                    updateSupportStats(response.counts);
                }
            } catch (error) {
                console.error('[Admin Chat] 載入聊天室失敗:', error);
            }
        }

        // 更新客服統計
        function updateSupportStats(counts) {
            const waitingCountEl = document.getElementById('waitingChatsCount');
            const activeCountEl = document.getElementById('activeChatsCount');
            const closedCountEl = document.getElementById('closedChatsCount');
            const avgRatingEl = document.getElementById('avgChatRating');
            const waitingTabEl = document.getElementById('waitingTabCount');
            const activeTabEl = document.getElementById('activeTabCount');
            const badgeEl = document.getElementById('waitingChatsBadge');

            // 需處理的對話數（等待中 + 有未讀的進行中）
            const needsAttention = counts?.needsAttention || counts?.waiting || 0;

            // 更新卡片統計
            if (waitingCountEl) waitingCountEl.textContent = needsAttention;  // 需處理數量
            if (activeCountEl) activeCountEl.textContent = counts?.active || 0;
            if (closedCountEl) closedCountEl.textContent = counts?.closed || 0;
            if (avgRatingEl) avgRatingEl.textContent = counts?.avgRating || '-';

            // 更新標籤和徽章
            if (waitingTabEl) waitingTabEl.textContent = `(${needsAttention})`;
            if (activeTabEl) activeTabEl.textContent = `(${counts?.active || 0})`;
            if (badgeEl) badgeEl.textContent = needsAttention;
        }

        // 切換客服標籤
        function switchSupportTab(btn, filter) {
            currentSupportFilter = filter;
            document.querySelectorAll('.support-tab').forEach(t => {
                t.classList.remove('active');
                t.style.background = 'var(--gray-100)';
                t.style.color = 'var(--gray-600)';
            });
            btn.classList.add('active');
            btn.style.background = 'var(--terracotta)';
            btn.style.color = 'white';
            renderAdminChatQueue();
        }

        // 渲染客服隊列
        function renderAdminChatQueue() {
            const container = document.getElementById('adminChatQueue');
            if (!container) return;

            const filteredRooms = adminChatRooms.filter(r => {
                if (currentSupportFilter === 'waiting') {
                    // 「需處理」分類：等待中 + 有未讀訊息的進行中對話
                    return r.status === 'waiting' || (r.status === 'active' && (r.unreadCount || 0) > 0);
                }
                if (currentSupportFilter === 'active') {
                    // 「進行中」分類：只顯示已讀的進行中對話（排除有未讀訊息的）
                    return r.status === 'active' && (r.unreadCount || 0) === 0;
                }
                if (currentSupportFilter === 'closed') return r.status === 'closed';
                return true;
            });

            if (filteredRooms.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem 1rem; color: var(--gray-400);">
                        <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 0.5rem; opacity: 0.5;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <p style="font-size: 0.85rem;">沒有${currentSupportFilter === 'waiting' ? '需處理' : currentSupportFilter === 'active' ? '進行中' : '已結束'}的對話</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredRooms.map(room => {
                const isActive = room.chatId === currentAdminChatId;
                const waitTime = getWaitTime(room.createdAt);
                const avatar = room.userName ? room.userName.charAt(0).toUpperCase() : 'U';

                return `
                    <div class="queue-item ${isActive ? 'active' : ''}" onclick="openAdminChat('${room.chatId}')">
                        <div class="queue-user">
                            <span class="status-dot ${room.status}"></span>
                            <span>${escapeHtml(room.userName || '用戶')}</span>
                        </div>
                        <div class="queue-preview">${escapeHtml(room.lastMessage || room.topic || '尚無訊息')}</div>
                        <div class="queue-time">${room.status === 'waiting' ? '等候 ' + waitTime : formatTime(room.lastMessageAt)}</div>
                    </div>
                `;
            }).join('');
        }

        // 計算等候時間
        function getWaitTime(createdAt) {
            const created = new Date(createdAt);
            const now = new Date();
            const diff = Math.floor((now - created) / 1000 / 60);
            if (diff < 1) return '剛剛';
            if (diff < 60) return diff + ' 分鐘';
            return Math.floor(diff / 60) + ' 小時';
        }

        // 開啟管理員聊天
        function openAdminChat(chatId) {
            if (currentAdminChatId && adminSocket) {
                adminSocket.emit('chat:leave', { chatId: currentAdminChatId });
            }

            currentAdminChatId = chatId;

            // 更新 UI（添加空值檢查）
            const welcomeEl = document.getElementById('adminChatWelcome');
            const headerEl = document.getElementById('adminChatHeader');
            const messagesEl = document.getElementById('adminChatMessages');

            if (welcomeEl) welcomeEl.style.display = 'none';
            if (headerEl) headerEl.style.display = 'block';
            if (messagesEl) messagesEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-400);">載入訊息中...</div>';

            const room = adminChatRooms.find(r => r.chatId === chatId);
            if (room) {
                updateAdminChatHeader(room);
            }

            if (adminSocket) {
                adminSocket.emit('chat:join', { chatId });
            }

            renderAdminChatQueue();
        }

        // 更新聊天視窗標題
        function updateAdminChatHeader(room) {
            const avatar = room.userName ? room.userName.charAt(0).toUpperCase() : 'U';
            const avatarEl = document.getElementById('adminChatUserAvatar');
            const nameEl = document.getElementById('adminChatUserName');
            const emailEl = document.getElementById('adminChatUserEmail');
            const claimBtn = document.getElementById('claimChatBtn');
            const inputEl = document.getElementById('adminChatInput');

            if (avatarEl) avatarEl.textContent = avatar;
            if (nameEl) nameEl.textContent = room.userName || '用戶';
            if (emailEl) emailEl.textContent = room.userEmail || '';

            if (room.status === 'waiting') {
                if (claimBtn) claimBtn.style.display = 'block';
                if (inputEl) inputEl.style.display = 'none';
            } else if (room.status === 'active') {
                if (claimBtn) claimBtn.style.display = 'none';
                if (inputEl) inputEl.style.display = 'block';
            } else {
                if (claimBtn) claimBtn.style.display = 'none';
                if (inputEl) inputEl.style.display = 'none';
            }
        }

        // 渲染管理員聊天訊息
        function renderAdminMessages(messages) {
            const container = document.getElementById('adminChatMessages');
            if (!container) return;

            if (!messages || messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-400);">尚無訊息</div>';
                return;
            }

            container.innerHTML = messages.map(msg => createAdminMessageHTML(msg)).join('');
            scrollAdminChatToBottom();
        }

        // 創建管理員視角訊息 HTML
        function createAdminMessageHTML(msg) {
            const isAdmin = msg.senderRole === 'admin';
            const isSystem = msg.senderRole === 'system' || msg.messageType === 'system';
            const time = formatTime(msg.createdAt);

            if (isSystem) {
                return `<div class="chat-message system"><div class="chat-bubble">${escapeHtml(msg.content)}</div></div>`;
            }

            return `
                <div class="chat-message ${isAdmin ? 'admin' : 'user'}">
                    <div>
                        ${!isAdmin ? `<div class="chat-sender">${escapeHtml(msg.senderName)}</div>` : ''}
                        <div class="chat-bubble">${escapeHtml(msg.content)}</div>
                        <div class="chat-time">${time}</div>
                    </div>
                </div>
            `;
        }

        // 附加管理員訊息
        function appendAdminMessage(msg) {
            const container = document.getElementById('adminChatMessages');
            if (!container) return;
            const emptyHint = container.querySelector('div[style*="text-align: center"]');
            if (emptyHint) emptyHint.remove();
            container.insertAdjacentHTML('beforeend', createAdminMessageHTML(msg));
        }

        // 附加系統訊息
        function appendAdminSystemMessage(content) {
            const container = document.getElementById('adminChatMessages');
            if (!container) return;
            container.insertAdjacentHTML('beforeend', `<div class="chat-message system"><div class="chat-bubble">${escapeHtml(content)}</div></div>`);
            scrollAdminChatToBottom();
        }

        // 接手對話
        async function adminClaimChat() {
            if (!currentAdminChatId) return;

            // 請求通知權限（用戶點擊觸發）
            requestAdminNotificationPermission();

            try {
                const response = await API.request(`/chat/admin/rooms/${currentAdminChatId}/claim`, {
                    method: 'PUT'
                });

                if (response.success) {
                    showToast('已接手對話');
                    document.getElementById('claimChatBtn').style.display = 'none';
                    document.getElementById('adminChatInput').style.display = 'block';
                    loadAdminChatRooms();
                }
            } catch (error) {
                console.error('[Admin Chat] 接手對話失敗:', error);
                showToast('接手對話失敗', 'error');
            }
        }

        // 結束對話
        async function adminCloseChat() {
            if (!currentAdminChatId) return;

            try {
                await showConfirmDialog({
                    title: '結束對話',
                    message: '結束後此對話將被關閉，用戶需要重新發起諮詢。確定要結束嗎？',
                    type: 'warning',
                    confirmText: '結束對話',
                    cancelText: '取消'
                });

                if (adminSocket) {
                    adminSocket.emit('chat:close', { chatId: currentAdminChatId });
                }
            } catch (e) {
                // 用戶取消操作
            }
        }

        // 發送管理員訊息
        function sendAdminMessage() {
            const input = document.getElementById('adminMessageInput');
            const content = input.value.trim();

            if (!content || !currentAdminChatId) return;

            if (adminSocket) {
                adminSocket.emit('message:send', {
                    chatId: currentAdminChatId,
                    content: content,
                    messageType: 'text'
                });
                adminSocket.emit('typing:stop', { chatId: currentAdminChatId });
            }

            input.value = '';
            input.style.height = 'auto';
        }

        // 處理管理員輸入框按鍵
        function handleAdminChatKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminMessage();
            }
        }

        // 處理管理員輸入事件
        function handleAdminChatInput(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

            if (adminSocket && currentAdminChatId) {
                adminSocket.emit('typing:start', { chatId: currentAdminChatId });
                clearTimeout(adminTypingTimeout);
                adminTypingTimeout = setTimeout(() => {
                    adminSocket.emit('typing:stop', { chatId: currentAdminChatId });
                }, 2000);
            }
        }

        // 顯示打字提示
        function showAdminTypingIndicator(isTyping, userName) {
            const indicator = document.getElementById('adminTypingIndicator');
            const userSpan = document.getElementById('adminTypingUser');
            if (indicator && userSpan) {
                indicator.style.display = isTyping ? 'block' : 'none';
                userSpan.textContent = `${userName} 正在輸入...`;
            }
        }

        // 捲動到底部
        function scrollAdminChatToBottom() {
            const container = document.getElementById('adminChatMessages');
            if (container) container.scrollTop = container.scrollHeight;
        }

        // 瀏覽器通知
        function showAdminNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body, icon: '/platform/img/logo.png' });
            }
        }

        // ========== New View Load Functions ==========

        // Load Courses
        async function loadCourses() {
            try {
                const result = await API.request('/api/courses');
                const courses = result.success ? result.data : [];
                const tbody = document.getElementById('coursesTableBody');
                if (!tbody) return;

                if (courses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-400);">目前沒有課程</td></tr>';
                    return;
                }

                tbody.innerHTML = courses.map(course => `
                    <tr>
                        <td><strong>${course.title || course.name}</strong></td>
                        <td>${course.categoryName || '未分類'}</td>
                        <td>${course.instructorName || '-'}</td>
                        <td>${course.enrolledCount || 0}</td>
                        <td><span class="badge ${course.status === 'published' ? 'badge-success' : 'badge-warning'}">${course.status === 'published' ? '已發布' : '草稿'}</span></td>
                        <td>
                            <button class="btn-icon" onclick="editCourse('${course.id}')" title="編輯"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="btn-icon" onclick="deleteCourse('${course.id}')" title="刪除"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load courses error:', error);
            }
        }

        // Load Course Categories
        async function loadCourseCategories() {
            try {
                const result = await API.request('/api/course-categories');
                const categories = result.success ? (result.data || []) : [];
                const container = document.getElementById('categoriesTreeContainer');
                if (!container) return;

                if (categories.length === 0) {
                    // 顯示預設類別
                    container.innerHTML = `
                        <div class="category-item" style="padding: 0.5rem; border-bottom: 1px solid var(--gray-200);">
                            <span>📁 全部課程</span>
                            <span style="float: right; color: var(--gray-400);">0 課程</span>
                        </div>
                        <p style="text-align: center; color: var(--gray-400); padding: 1rem; font-size: 0.875rem;">點擊「新增類別」來建立課程分類</p>
                    `;
                    return;
                }

                container.innerHTML = renderCategoryTree(categories);
            } catch (error) {
                console.error('Load categories error:', error);
                const container = document.getElementById('categoriesTreeContainer');
                if (container) container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 1rem;">課程類別功能載入中...</p>';
            }
        }

        function renderCategoryTree(categories, parentId = null, level = 0) {
            const items = categories.filter(c => c.parentId === parentId);
            if (items.length === 0) return '';

            return items.map(cat => `
                <div class="category-item" style="padding-left: ${level * 20}px; padding: 0.5rem; border-bottom: 1px solid var(--gray-200);">
                    <span style="margin-left: ${level * 20}px;">${'└ '.repeat(level > 0 ? 1 : 0)}${cat.name}</span>
                    <span style="float: right; color: var(--gray-400);">${cat.courseCount || 0} 課程</span>
                </div>
                ${renderCategoryTree(categories, cat.id, level + 1)}
            `).join('');
        }

        // Load Question Bank
        async function loadQuestionBank() {
            try {
                // Load categories
                const catResult = await API.request('/api/questionbank/categories');
                const categories = catResult.success ? catResult.data : [];
                const catContainer = document.getElementById('questionCategoriesTree');
                if (catContainer) {
                    if (categories.length === 0) {
                        catContainer.innerHTML = `
                            <div class="category-item active" style="padding: 0.5rem; cursor: pointer;">
                                <span>📁 全部題目</span>
                            </div>
                            <p style="text-align: center; color: var(--gray-400); padding: 1rem; font-size: 0.875rem;">尚無分類</p>
                        `;
                    } else {
                        catContainer.innerHTML = `
                            <div class="category-item active" style="padding: 0.5rem; cursor: pointer; background: var(--olive-100); border-radius: 4px;">
                                <span>📁 全部題目</span>
                            </div>
                            ${categories.map(cat => `
                                <div class="category-item" style="padding: 0.5rem; cursor: pointer;" onclick="filterQuestionsByCategory('${cat.id}')">
                                    <span>📂 ${cat.name}</span>
                                    <span style="color: var(--gray-400); font-size: 0.75rem;">(${cat.questionCount || 0})</span>
                                </div>
                            `).join('')}
                        `;
                    }
                }

                // Load questions
                const result = await API.request('/api/questionbank');
                const questions = result.success ? result.data : [];
                const tbody = document.getElementById('questionsTableBody');
                if (!tbody) return;

                if (questions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-400);">題庫中目前沒有題目</td></tr>';
                    return;
                }

                const typeLabels = {
                    'multiple_choice': '單選題',
                    'multiple_select': '多選題',
                    'true_false': '是非題',
                    'short_answer': '簡答題',
                    'essay': '申論題'
                };

                const difficultyLabels = {
                    'easy': { text: '簡單', class: 'badge-success' },
                    'medium': { text: '中等', class: 'badge-warning' },
                    'hard': { text: '困難', class: 'badge-danger' }
                };

                tbody.innerHTML = questions.map(q => `
                    <tr>
                        <td><input type="checkbox" value="${q.id}"></td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${q.text || q.content}</td>
                        <td>${typeLabels[q.type] || q.type}</td>
                        <td><span class="badge ${(difficultyLabels[q.difficulty] || {}).class || 'badge-info'}">${(difficultyLabels[q.difficulty] || {}).text || q.difficulty || '-'}</span></td>
                        <td>${q.usageCount || 0}</td>
                        <td>
                            <button class="btn-icon" onclick="editQuestion('${q.id}')" title="編輯"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="btn-icon" onclick="deleteQuestion('${q.id}')" title="刪除"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load question bank error:', error);
                const tbody = document.getElementById('questionsTableBody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-400);">題庫功能載入中...</td></tr>';
            }
        }

        // Load Badges
        async function loadBadges() {
            try {
                const result = await API.request('/api/badges');
                const badges = result.success ? (result.data || []) : [];

                // Update stats (with null checks)
                const totalBadgesEl = document.getElementById('totalBadgesCount');
                const activeBadgesEl = document.getElementById('activeBadgesCount');
                const awardedBadgesEl = document.getElementById('awardedBadgesCount');
                if (totalBadgesEl) totalBadgesEl.textContent = badges.length;
                if (activeBadgesEl) activeBadgesEl.textContent = badges.filter(b => b.isActive).length;
                if (awardedBadgesEl) awardedBadgesEl.textContent = badges.reduce((sum, b) => sum + (b.awardedCount || 0), 0);

                const grid = document.getElementById('badgesGrid');
                if (!grid) return;

                if (badges.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; color: var(--gray-400); grid-column: 1/-1; padding: 2rem;">目前沒有徽章，請新增徽章</p>';
                    return;
                }

                grid.innerHTML = badges.map(badge => `
                    <div class="badge-card" style="background: white; border-radius: 8px; padding: 1rem; box-shadow: var(--shadow-sm);">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <div style="width: 50px; height: 50px; background: var(--olive-100); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                ${badge.icon || '🏆'}
                            </div>
                            <div>
                                <h4 style="margin: 0;">${badge.name}</h4>
                                <span class="badge ${badge.isActive ? 'badge-success' : 'badge-warning'}">${badge.isActive ? '啟用中' : '停用'}</span>
                            </div>
                        </div>
                        <p style="color: var(--gray-500); font-size: 0.875rem; margin: 0.5rem 0;">${badge.description || '無說明'}</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                            <span style="color: var(--gray-400); font-size: 0.75rem;">已頒發 ${badge.awardedCount || 0} 次</span>
                            <div>
                                <button class="btn-icon" onclick="editBadge('${badge.id}')" title="編輯"><svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load badges error:', error);
            }
        }

        // Load Learning Paths
        async function loadLearningPaths() {
            try {
                const result = await API.request('/api/learning-paths');
                const paths = result.success ? (result.data || []) : [];
                const container = document.getElementById('learningPathsContainer');
                if (!container) return;

                if (paths.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 2rem;">目前沒有學習路徑，點擊「新增路徑」來建立第一個學習路徑</p>';
                    return;
                }

                container.innerHTML = paths.map(path => `
                    <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">${path.name}</h4>
                                <p style="color: var(--gray-500); font-size: 0.875rem; margin: 0;">${path.description || '無說明'}</p>
                            </div>
                            <span class="badge ${path.isActive ? 'badge-success' : 'badge-warning'}">${path.isActive ? '啟用中' : '停用'}</span>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem; color: var(--gray-400); font-size: 0.875rem;">
                            <span>📚 ${path.courseCount || 0} 課程</span>
                            <span>👥 ${path.enrolledCount || 0} 學員</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load learning paths error:', error);
                const container = document.getElementById('learningPathsContainer');
                if (container) container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 2rem;">學習路徑功能載入中...</p>';
            }
        }

        // Load SCORM
        async function loadScorm() {
            try {
                const result = await API.request('/api/scorm');
                const packages = result.success ? (result.data || []) : [];

                // Update stats (with null checks)
                const totalScormEl = document.getElementById('totalScormCount');
                const scorm12El = document.getElementById('scorm12Count');
                const scorm2004El = document.getElementById('scorm2004Count');
                if (totalScormEl) totalScormEl.textContent = packages.length;
                if (scorm12El) scorm12El.textContent = packages.filter(p => p.version === '1.2').length;
                if (scorm2004El) scorm2004El.textContent = packages.filter(p => p.version === '2004').length;

                const tbody = document.getElementById('scormTableBody');
                if (!tbody) return;

                if (packages.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-400);">目前沒有 SCORM 學習包</td></tr>';
                    return;
                }

                tbody.innerHTML = packages.map(pkg => `
                    <tr>
                        <td>${pkg.title || pkg.name || '-'}</td>
                        <td><span class="badge badge-info">SCORM ${pkg.version || '1.2'}</span></td>
                        <td>${pkg.courseName || '-'}</td>
                        <td>${pkg.completionCount || 0}</td>
                        <td>${pkg.uploadedAt ? new Date(pkg.uploadedAt).toLocaleDateString('zh-TW') : '-'}</td>
                        <td>
                            <button class="btn-icon" onclick="previewScorm('${pkg.id}')" title="預覽"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                            <button class="btn-icon" onclick="deleteScorm('${pkg.id}')" title="刪除"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load SCORM error:', error);
                const tbody = document.getElementById('scormTableBody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-400);">SCORM 功能載入中...</td></tr>';
            }
        }

        // Load LTI
        async function loadLti() {
            try {
                const result = await API.request('/api/lti/tools');
                const tools = result.success ? (result.data || []) : [];

                // Update stats (with null checks)
                const totalLtiEl = document.getElementById('totalLtiCount');
                const activeLtiEl = document.getElementById('activeLtiCount');
                if (totalLtiEl) totalLtiEl.textContent = tools.length;
                if (activeLtiEl) activeLtiEl.textContent = tools.filter(t => t.isActive).length;

                const tbody = document.getElementById('ltiTableBody');
                if (!tbody) return;

                if (tools.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-400);">目前沒有 LTI 外部工具</td></tr>';
                    return;
                }

                tbody.innerHTML = tools.map(tool => `
                    <tr>
                        <td>${tool.name}</td>
                        <td><span class="badge badge-info">LTI ${tool.version || '1.3'}</span></td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${tool.url}</td>
                        <td><span class="badge ${tool.isActive ? 'badge-success' : 'badge-warning'}">${tool.isActive ? '啟用' : '停用'}</span></td>
                        <td>
                            <button class="btn-icon" onclick="editLti('${tool.id}')" title="編輯"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="btn-icon" onclick="deleteLti('${tool.id}')" title="刪除"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load LTI error:', error);
            }
        }

        // Load H5P
        async function loadH5p() {
            try {
                const result = await API.request('/api/h5p/content');
                const contents = result.success ? (result.data || []) : [];

                // Update stats (with null checks)
                const totalH5pEl = document.getElementById('totalH5pCount');
                const h5pTypesEl = document.getElementById('h5pTypesCount');
                const h5pInteractionsEl = document.getElementById('h5pInteractionsCount');
                if (totalH5pEl) totalH5pEl.textContent = contents.length;
                const types = [...new Set(contents.filter(c => c.libraryName).map(c => c.libraryName))];
                if (h5pTypesEl) h5pTypesEl.textContent = types.length;
                if (h5pInteractionsEl) h5pInteractionsEl.textContent = contents.reduce((sum, c) => sum + (c.interactionCount || 0), 0);

                const tbody = document.getElementById('h5pTableBody');
                if (!tbody) return;

                if (contents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-400);">目前沒有 H5P 互動內容</td></tr>';
                    return;
                }

                tbody.innerHTML = contents.map(content => `
                    <tr>
                        <td>${content.title || '-'}</td>
                        <td><span class="badge badge-info">${content.libraryName || 'Unknown'}</span></td>
                        <td>${content.courseName || '-'}</td>
                        <td>${content.createdAt ? new Date(content.createdAt).toLocaleDateString('zh-TW') : '-'}</td>
                        <td>
                            <button class="btn-icon" onclick="previewH5p('${content.id}')" title="預覽"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                            <button class="btn-icon" onclick="editH5p('${content.id}')" title="編輯"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            <button class="btn-icon" onclick="deleteH5p('${content.id}')" title="刪除"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load H5P error:', error);
                const tbody = document.getElementById('h5pTableBody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-400);">H5P 功能載入中...</td></tr>';
            }
        }

        // Load Roles
        async function loadRoles() {
            try {
                const result = await API.request('/api/roles');
                const roles = result.success ? (result.data || []) : [];
                const container = document.getElementById('rolesListContainer');
                if (!container) return;

                if (roles.length === 0) {
                    // 顯示預設角色
                    const defaultRoles = [
                        { id: 'admin', name: '管理員', description: '系統管理員，擁有所有權限', isSystem: true, userCount: 1 },
                        { id: 'educator', name: '教育者', description: '可以建立和管理課程', isSystem: true, userCount: 0 },
                        { id: 'trainer', name: '培訓師', description: '可以建立和管理培訓內容', isSystem: true, userCount: 0 },
                        { id: 'creator', name: '創作者', description: '可以建立和分享教材', isSystem: true, userCount: 0 },
                        { id: 'student', name: '學生', description: '可以參與課程學習', isSystem: true, userCount: 0 }
                    ];
                    container.innerHTML = defaultRoles.map(role => `
                        <div class="role-item" style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); cursor: pointer;" onclick="selectRole('${role.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${role.name}</strong>
                                    <span class="badge badge-info" style="margin-left: 0.5rem; font-size: 0.7rem;">系統</span>
                                </div>
                                <span style="color: var(--gray-400); font-size: 0.75rem;">${role.userCount || 0} 用戶</span>
                            </div>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: var(--gray-500);">${role.description}</p>
                        </div>
                    `).join('');
                    return;
                }

                container.innerHTML = roles.map(role => `
                    <div class="role-item" style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); cursor: pointer;" onclick="selectRole('${role.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${role.name}</strong>
                                <span class="badge ${role.isSystem ? 'badge-info' : 'badge-success'}" style="margin-left: 0.5rem; font-size: 0.7rem;">${role.isSystem ? '系統' : '自訂'}</span>
                            </div>
                            <span style="color: var(--gray-400); font-size: 0.75rem;">${role.userCount || 0} 用戶</span>
                        </div>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: var(--gray-500);">${role.description || '無說明'}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load roles error:', error);
                const container = document.getElementById('rolesListContainer');
                if (container) container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 1rem;">角色功能載入中...</p>';
            }
        }

        function selectRole(roleId) {
            console.log('Select role:', roleId);
            // TODO: Load role permissions
            document.getElementById('permissionsContainer').innerHTML = '<p style="text-align: center; color: var(--gray-400);">權限設定功能開發中</p>';
        }

        // Load Rubrics
        async function loadRubrics() {
            try {
                const result = await API.request('/api/rubrics');
                const rubrics = result.success ? (result.data || []) : [];
                const container = document.getElementById('rubricsContainer');
                if (!container) return;

                if (rubrics.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 2rem;">目前沒有評分標準，點擊「新增評分標準」來建立</p>';
                    return;
                }

                container.innerHTML = rubrics.map(rubric => `
                    <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: var(--shadow-sm);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">${rubric.name || '未命名評分標準'}</h4>
                                <p style="color: var(--gray-500); font-size: 0.875rem; margin: 0;">${rubric.description || '無說明'}</p>
                            </div>
                            <div>
                                <button class="btn-icon" onclick="editRubric('${rubric.id}')" title="編輯"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; color: var(--gray-400); font-size: 0.875rem;">
                            <span>📋 ${rubric.criteriaCount || 0} 評分項目</span>
                            <span style="margin-left: 1rem;">📊 使用 ${rubric.usageCount || 0} 次</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load rubrics error:', error);
                const container = document.getElementById('rubricsContainer');
                if (container) container.innerHTML = '<p style="text-align: center; color: var(--gray-400); padding: 2rem;">評分標準功能載入中...</p>';
            }
        }

        // Load Audit Logs
        async function loadAuditLogs() {
            try {
                const result = await API.request('/api/audit-logs');
                const logs = result.success ? result.data : [];
                const tbody = document.getElementById('auditLogsTableBody');
                if (!tbody) return;

                if (logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray-400);">目前沒有審計日誌</td></tr>';
                    return;
                }

                const actionLabels = {
                    'create': '建立',
                    'update': '更新',
                    'delete': '刪除',
                    'login': '登入',
                    'logout': '登出'
                };

                tbody.innerHTML = logs.slice(0, 100).map(log => `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleString('zh-TW')}</td>
                        <td>${log.userName || log.userId}</td>
                        <td><span class="badge badge-info">${actionLabels[log.action] || log.action}</span></td>
                        <td>${log.resourceType || '-'}</td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${log.details || '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Load audit logs error:', error);
            }
        }

        // ========================================
        // Phase 3: 系統監控功能
        // ========================================
        let systemHealthInterval = null;

        async function loadSystemHealth() {
            try {
                const result = await API.admin.systemHealth.get();
                if (result.success) {
                    const { status, services, system } = result.data;

                    // 更新服務狀態卡片
                    updateStatusCard('API', services.api);
                    updateStatusCard('DB', services.database);
                    updateStatusCard('Storage', services.storage);

                    // 更新記憶體狀態
                    const memoryUsed = system.memory.heapUsed;
                    const memoryTotal = system.memory.heapTotal;
                    const memoryPercent = Math.round((memoryUsed / memoryTotal) * 100);

                    document.getElementById('memoryStatus').textContent = `${memoryPercent}%`;
                    document.getElementById('memoryPercent').textContent = `${memoryPercent}%`;
                    document.getElementById('memoryBar').style.width = `${memoryPercent}%`;
                    document.getElementById('memoryDetail').textContent =
                        `已使用 ${(memoryUsed / 1024 / 1024).toFixed(1)} MB / 總共 ${(memoryTotal / 1024 / 1024).toFixed(1)} MB`;

                    // 根據使用率設定顏色
                    const memoryBar = document.getElementById('memoryBar');
                    memoryBar.classList.remove('warning', 'danger');
                    if (memoryPercent > 80) {
                        memoryBar.classList.add('danger');
                        document.getElementById('memoryStatus').classList.add('warning');
                    } else if (memoryPercent > 60) {
                        memoryBar.classList.add('warning');
                    }

                    // 更新運行時間
                    document.getElementById('uptimeValue').textContent = formatUptime(system.uptime);
                    document.getElementById('nodeVersion').textContent = system.nodeVersion;
                }

                // 載入錯誤日誌
                await loadErrorLogs();
            } catch (error) {
                console.error('Load system health error:', error);
            }
        }

        function updateStatusCard(type, status) {
            const cardId = `statusCard${type}`;
            const statusId = type.toLowerCase() + 'Status';
            const card = document.getElementById(cardId);
            const statusEl = document.getElementById(statusId);

            if (!card || !statusEl) return;

            const icon = card.querySelector('.status-icon');

            // 移除所有狀態類別
            icon.classList.remove('healthy', 'warning', 'error');
            statusEl.classList.remove('healthy', 'warning', 'error');

            if (status === 'healthy') {
                icon.classList.add('healthy');
                statusEl.classList.add('healthy');
                statusEl.textContent = '正常運行';
            } else if (status === 'warning') {
                icon.classList.add('warning');
                statusEl.classList.add('warning');
                statusEl.textContent = '需要注意';
            } else {
                icon.classList.add('error');
                statusEl.classList.add('error');
                statusEl.textContent = '異常';
            }
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);

            if (days > 0) {
                return `${days} 天 ${hours} 小時`;
            } else if (hours > 0) {
                return `${hours} 小時 ${minutes} 分鐘`;
            } else {
                return `${minutes} 分鐘`;
            }
        }

        async function loadErrorLogs() {
            try {
                const filter = document.getElementById('errorSeverityFilter')?.value || '';
                const result = await API.admin.systemHealth.getErrors({ severity: filter });
                const errorList = document.getElementById('errorLogList');

                if (!errorList) return;

                const errors = result.success ? result.data.errors : [];

                if (errors.length === 0) {
                    errorList.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            <p>系統運行正常，無錯誤記錄</p>
                        </div>
                    `;
                    return;
                }

                errorList.innerHTML = errors.map(err => `
                    <div class="error-log-item ${err.severity}">
                        <svg class="error-log-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            ${err.severity === 'error'
                                ? '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'
                                : err.severity === 'warning'
                                ? '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>'
                                : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>'}
                        </svg>
                        <div class="error-log-content">
                            <div class="error-log-message">${err.message}</div>
                            <div class="error-log-meta">${err.category} · ${new Date(err.timestamp).toLocaleString('zh-TW')}</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Load error logs error:', error);
            }
        }

        function filterErrors() {
            loadErrorLogs();
        }

        function toggleAutoRefresh(enabled) {
            if (enabled) {
                systemHealthInterval = setInterval(loadSystemHealth, 30000);
            } else {
                if (systemHealthInterval) {
                    clearInterval(systemHealthInterval);
                    systemHealthInterval = null;
                }
            }
        }

        // ========================================
        // Phase 3: 數據匯出功能
        // ========================================
        function loadDataExport() {
            // 數據匯出視圖只需要初始化，不需要載入資料
            // 可以載入最近匯出記錄（如果有實現）
        }

        function showExportModal(type) {
            const typeNames = {
                'users': '用戶數據',
                'courses': '課程數據',
                'licenses': '授權數據',
                'analytics': '分析報表'
            };

            // 使用確認對話框詢問匯出格式
            showConfirmDialog({
                title: `匯出${typeNames[type]}`,
                message: `請選擇匯出格式：<br><br>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-secondary" onclick="executeExport('${type}', 'csv'); ConfirmDialog.close(false);">CSV</button>
                        <button class="btn btn-sm btn-secondary" onclick="executeExport('${type}', 'json'); ConfirmDialog.close(false);">JSON</button>
                        ${type !== 'analytics' ? '<button class="btn btn-sm btn-secondary" onclick="executeExport(\'' + type + '\', \'pdf\'); ConfirmDialog.close(false);">PDF</button>' : ''}
                    </div>`,
                type: 'info',
                confirmText: '取消',
                onConfirm: () => {}
            });
        }

        async function executeExport(type, format) {
            try {
                let result;

                switch (type) {
                    case 'users':
                        result = await API.admin.export.users({ format });
                        break;
                    case 'courses':
                        result = await API.admin.export.courses({ format });
                        break;
                    case 'licenses':
                        result = await API.admin.export.licenses({ format });
                        break;
                    default:
                        alert('功能開發中');
                        return;
                }

                if (result.success && result.data.records) {
                    if (format === 'csv') {
                        downloadCSV(result.data.records, `${type}_export`);
                    } else if (format === 'json') {
                        downloadJSON(result.data.records, `${type}_export`);
                    } else {
                        alert('PDF 匯出功能開發中');
                    }
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('匯出失敗：' + error.message);
            }
        }

        function downloadCSV(data, filename) {
            if (!data || data.length === 0) {
                alert('沒有數據可匯出');
                return;
            }

            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(h => {
                    let val = row[h] || '';
                    if (typeof val === 'string' && (val.includes(',') || val.includes('"') || val.includes('\n'))) {
                        val = '"' + val.replace(/"/g, '""') + '"';
                    }
                    return val;
                }).join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${filename}_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
        }

        // ========================================
        // Phase 3: 自動化規則功能
        // ========================================
        let automationRulesData = [];

        async function loadAutomationRules() {
            try {
                const result = await API.admin.automation.getRules();

                if (result.success) {
                    automationRulesData = result.data.rules || [];

                    // 更新統計
                    document.getElementById('totalRulesCount').textContent = automationRulesData.length;
                    document.getElementById('activeRulesCount').textContent =
                        automationRulesData.filter(r => r.isActive).length;
                    document.getElementById('todayTriggersCount').textContent =
                        result.data.todayTriggers || 0;
                    document.getElementById('totalTriggersCount').textContent =
                        result.data.totalTriggers || 0;

                    renderAutomationRules();
                } else {
                    renderEmptyAutomationRules();
                }
            } catch (error) {
                console.error('Load automation rules error:', error);
                renderEmptyAutomationRules();
            }
        }

        function renderAutomationRules() {
            const tbody = document.getElementById('automationRulesTable');
            if (!tbody) return;

            const typeFilter = document.getElementById('ruleTypeFilter')?.value || '';
            const statusFilter = document.getElementById('ruleStatusFilter')?.value || '';

            let filtered = automationRulesData;
            if (typeFilter) {
                filtered = filtered.filter(r => r.type === typeFilter);
            }
            if (statusFilter === 'active') {
                filtered = filtered.filter(r => r.isActive);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(r => !r.isActive);
            }

            if (filtered.length === 0) {
                renderEmptyAutomationRules();
                return;
            }

            const typeLabels = {
                'AUTO_APPROVE_LICENSE': '自動核准授權',
                'AUTO_SEND_NOTIFICATION': '自動發送通知',
                'AUTO_SUSPEND_USER': '自動停用用戶',
                'AUTO_ARCHIVE_COURSE': '自動封存課程',
                'SCHEDULED_REPORT': '定期報表'
            };

            const typeClasses = {
                'AUTO_APPROVE_LICENSE': 'auto-approve',
                'AUTO_SEND_NOTIFICATION': 'auto-notify',
                'AUTO_SUSPEND_USER': 'auto-suspend',
                'AUTO_ARCHIVE_COURSE': 'auto-archive',
                'SCHEDULED_REPORT': 'scheduled'
            };

            tbody.innerHTML = filtered.map(rule => `
                <tr>
                    <td>
                        <label class="rule-status-toggle">
                            <input type="checkbox" ${rule.isActive ? 'checked' : ''}
                                   onchange="toggleAutomationRule('${rule.id}')">
                            <span class="rule-toggle-slider"></span>
                        </label>
                    </td>
                    <td><strong>${rule.name}</strong></td>
                    <td><span class="rule-type-badge ${typeClasses[rule.type] || ''}">${typeLabels[rule.type] || rule.type}</span></td>
                    <td style="font-size: 0.85rem;">${rule.conditionSummary || '-'}</td>
                    <td style="font-size: 0.85rem;">${rule.actionSummary || '-'}</td>
                    <td>${rule.lastTriggered ? formatDate(rule.lastTriggered) : '從未'}</td>
                    <td>${rule.triggerCount || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editAutomationRule('${rule.id}')">編輯</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAutomationRule('${rule.id}')">刪除</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderEmptyAutomationRules() {
            const tbody = document.getElementById('automationRulesTable');
            if (!tbody) return;

            tbody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        尚無自動化規則，點擊「新增規則」開始設定
                    </td>
                </tr>
            `;
        }

        function filterRules() {
            renderAutomationRules();
        }

        async function toggleAutomationRule(ruleId) {
            try {
                await API.admin.automation.toggleRule(ruleId);
                loadAutomationRules();
            } catch (error) {
                console.error('Toggle rule error:', error);
                alert('操作失敗：' + error.message);
            }
        }

        async function deleteAutomationRule(ruleId) {
            const confirmed = await showConfirmDialog({
                title: '刪除規則',
                message: '確定要刪除此自動化規則嗎？此操作無法復原。',
                type: 'danger',
                confirmText: '確認刪除'
            });

            if (confirmed) {
                try {
                    await API.admin.automation.deleteRule(ruleId);
                    loadAutomationRules();
                } catch (error) {
                    console.error('Delete rule error:', error);
                    alert('刪除失敗：' + error.message);
                }
            }
        }

        function openAutomationModal() {
            alert('自動化規則編輯器開發中');
        }

        function editAutomationRule(ruleId) {
            alert('自動化規則編輯器開發中');
        }

        // ========================================
        // Phase 3: 用戶活動分析功能
        // ========================================
        let activityTrendChart = null;
        let behaviorDistributionChart = null;

        async function loadUserActivity() {
            const dateRange = document.getElementById('activityDateRange')?.value || '30d';

            try {
                const result = await API.admin.analytics.getUserActivity(dateRange);

                if (result.success) {
                    const { summary, dailyActiveUsers, roleDistribution, registrationTrend } = result.data;

                    // 更新關鍵指標
                    document.getElementById('dauValue').textContent = summary.dau || 0;
                    document.getElementById('wauValue').textContent = summary.wau || 0;
                    document.getElementById('mauValue').textContent = summary.mau || 0;
                    document.getElementById('retentionValue').textContent = (summary.retention || 0) + '%';

                    // 更新趨勢指示
                    updateActivityTrend('dau', summary.dauTrend || 0);
                    updateActivityTrend('wau', summary.wauTrend || 0);
                    updateActivityTrend('mau', summary.mauTrend || 0);

                    // 更新圖表
                    renderActivityTrendChart(dailyActiveUsers || []);
                    renderBehaviorDistributionChart(roleDistribution || {});

                    // 更新熱力圖
                    renderActivityHeatmap();

                    // 載入高活躍用戶列表
                    loadTopActiveUsers();
                }
            } catch (error) {
                console.error('Load user activity error:', error);
            }
        }

        function updateActivityTrend(metric, trend) {
            const trendEl = document.getElementById(`${metric}Trend`);
            if (!trendEl) return;

            trendEl.classList.remove('positive', 'negative', 'neutral');

            if (trend > 0) {
                trendEl.classList.add('positive');
                trendEl.textContent = `+${trend}%`;
            } else if (trend < 0) {
                trendEl.classList.add('negative');
                trendEl.textContent = `${trend}%`;
            } else {
                trendEl.classList.add('neutral');
                trendEl.textContent = '0%';
            }
        }

        function renderActivityTrendChart(data) {
            const ctx = document.getElementById('activityTrendChart');
            if (!ctx) return;

            if (activityTrendChart) {
                activityTrendChart.destroy();
            }

            // 模擬數據如果沒有真實數據
            if (!data || data.length === 0) {
                data = Array.from({ length: 30 }, (_, i) => ({
                    date: new Date(Date.now() - (29 - i) * 86400000).toISOString().slice(0, 10),
                    count: Math.floor(Math.random() * 50) + 10
                }));
            }

            activityTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: '活躍用戶',
                        data: data.map(d => d.count),
                        borderColor: '#5a6b4d',
                        backgroundColor: 'rgba(90, 107, 77, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { maxTicksLimit: 7 }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f3f4f6' }
                        }
                    }
                }
            });
        }

        function renderBehaviorDistributionChart(data) {
            const ctx = document.getElementById('behaviorDistributionChart');
            if (!ctx) return;

            if (behaviorDistributionChart) {
                behaviorDistributionChart.destroy();
            }

            // 模擬數據
            const labels = ['登入', '瀏覽課程', '提交作業', '參與討論', '下載資源'];
            const values = [35, 28, 18, 12, 7];

            behaviorDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#5a6b4d',
                            '#c17a5e',
                            '#3b82f6',
                            '#8b5cf6',
                            '#f59e0b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderActivityHeatmap() {
            const container = document.getElementById('activityHeatmap');
            if (!container) return;

            const days = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
            const hours = Array.from({ length: 24 }, (_, i) => i);

            // 生成模擬數據
            let html = '';

            // 時段標題行
            html += '<div class="heatmap-row-label"></div>';
            hours.forEach(h => {
                html += `<div style="text-align: center; font-size: 0.65rem; color: var(--text-secondary);">${h}</div>`;
            });

            // 每日數據行
            days.forEach(day => {
                html += `<div class="heatmap-row-label">${day}</div>`;
                hours.forEach(h => {
                    const level = Math.floor(Math.random() * 5);
                    html += `<div class="heatmap-cell level-${level}" title="${day} ${h}:00"></div>`;
                });
            });

            container.innerHTML = html;
        }

        async function loadTopActiveUsers() {
            const tbody = document.getElementById('topActiveUsersTable');
            if (!tbody) return;

            // 模擬數據
            const users = [
                { rank: 1, name: '王小明', role: 'educator', count: 156, lastActive: new Date() },
                { rank: 2, name: '李老師', role: 'trainer', count: 143, lastActive: new Date() },
                { rank: 3, name: '張同學', role: 'student', count: 128, lastActive: new Date() },
                { rank: 4, name: '陳教授', role: 'creator', count: 115, lastActive: new Date() },
                { rank: 5, name: '林助教', role: 'educator', count: 102, lastActive: new Date() }
            ];

            const roleMap = {
                'educator': '建橋者',
                'trainer': '橋樑工匠',
                'creator': '知識建築師',
                'admin': '管理員',
                'student': '探橋者'
            };

            tbody.innerHTML = users.map(u => `
                <tr>
                    <td><strong>${u.rank}</strong></td>
                    <td>${u.name}</td>
                    <td><span class="role-badge role-${u.role}">${roleMap[u.role] || u.role}</span></td>
                    <td>${u.count}</td>
                    <td>${formatDate(u.lastActive)}</td>
                </tr>
            `).join('');
        }

        function exportActivityReport() {
            alert('活動報表匯出功能開發中');
        }

        // Placeholder functions for modal dialogs
        function openCreateCourseModal() { alert('課程建立功能開發中'); }
        function openCreateCategoryModal() { alert('類別建立功能開發中'); }
        function openCreateQuestionModal() { alert('題目建立功能開發中'); }
        function openCreateBadgeModal() { alert('徽章建立功能開發中'); }
        function openCreatePathModal() { alert('學習路徑建立功能開發中'); }
        function openUploadScormModal() { alert('SCORM 上傳功能開發中'); }
        function openCreateLtiModal() { alert('LTI 工具建立功能開發中'); }
        function openCreateH5pModal() { alert('H5P 內容建立功能開發中'); }
        function openCreateRoleModal() { alert('角色建立功能開發中'); }
        function openCreateRubricModal() { alert('評分標準建立功能開發中'); }
        function importQuestions() { alert('題目匯入功能開發中'); }
        function filterQuestionsByCategory(categoryId) { console.log('Filter by category:', categoryId); }

        // 請求通知權限（由用戶互動觸發）
        function requestAdminNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Check auth on load - 如果未登入或非管理員，跳轉到主平台
        if (API.isLoggedIn() && API.isAdmin()) {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'flex';
            const user = API.getCurrentUser();
            if (user) document.getElementById('adminName').textContent = user.displayName;
            loadDashboard();
            initAdminSocket();
            // 載入客服聊天室以更新側邊欄徽章
            loadAdminChatRooms();
        } else {
            // 未登入或非管理員，跳轉到主平台登入頁面
            window.location.href = '/platform/';
        }
    </script>
</body>
</html>
