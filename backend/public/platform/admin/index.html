<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeyondBridge Admin | 管理後台</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Noto+Serif+TC:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 品牌主色 - 橄欖綠系列 */
            --olive-deep: #3D4A2D;
            --olive: #4A5D23;
            --olive-light: #6B7F3A;
            --olive-muted: rgba(74, 93, 35, 0.1);

            /* 輔助色 - 赤土系列 */
            --terracotta: #C17A5E;
            --terracotta-light: #D4967D;
            --terracotta-muted: rgba(193, 122, 94, 0.1);

            /* 中性色 - 奶油/沙色系列 */
            --cream: #F7F3EB;
            --cream-dark: #EDE6D6;
            --sand: #D4C5A9;
            --sage: #A8B89A;

            /* 文字色 */
            --charcoal: #2C2C2C;
            --gray-50: #fafafa;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #6c757d;
            --gray-600: #4A5568;
            --gray-800: #343a40;

            /* 語義色 */
            --success: #48BB78;
            --warning: #ECC94B;
            --danger: #F56565;
            --info: #4299E1;

            /* 圓角規範 */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;

            /* 陰影規範 */
            --shadow-sm: 0 2px 8px rgba(61, 74, 45, 0.06);
            --shadow-md: 0 8px 25px rgba(61, 74, 45, 0.08);
            --shadow-lg: 0 16px 40px rgba(61, 74, 45, 0.12);
            --shadow-hover: 0 12px 30px rgba(74, 93, 35, 0.15);
            --shadow-card: 0 4px 20px rgba(61, 74, 45, 0.08);

            /* 動畫規範 */
            --transition-fast: 0.15s ease;
            --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);

            /* 字體規範 */
            --font-display: 'Cormorant Garamond', 'Noto Serif TC', serif;
            --font-heading: 'Noto Serif TC', serif;
            --font-body: 'Noto Sans TC', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, var(--cream) 0%, var(--cream-dark) 100%);
            color: var(--charcoal);
            min-height: 100vh;
        }

        /* Layout */
        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - 精緻漸層設計 */
        .admin-sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--olive-deep) 0%, #2D3A1F 50%, #1F2815 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        .admin-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .admin-logo {
            padding: 1.75rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            position: relative;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, transparent 100%);
        }

        .admin-logo h1 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            background: linear-gradient(135deg, #fff 0%, var(--sage) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-logo span {
            font-size: 0.75rem;
            opacity: 0.6;
            display: block;
            margin-top: 0.35rem;
            letter-spacing: 0.05em;
        }

        .admin-nav {
            padding: 1.25rem 0;
            position: relative;
        }

        .nav-section {
            padding: 0.75rem 1.5rem 0.5rem;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            opacity: 0.4;
            margin-top: 1.25rem;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0.875rem 1.5rem;
            color: rgba(255,255,255,0.75);
            text-decoration: none;
            transition: var(--transition-base);
            cursor: pointer;
            position: relative;
            margin: 0.125rem 0.75rem;
            border-radius: var(--radius-md);
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%) scaleY(0);
            width: 3px;
            height: 60%;
            background: linear-gradient(180deg, var(--terracotta) 0%, var(--terracotta-light) 100%);
            border-radius: 0 2px 2px 0;
            transition: var(--transition-base);
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.08);
            color: white;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(193, 122, 94, 0.2) 0%, rgba(193, 122, 94, 0.1) 100%);
            color: white;
        }

        .nav-item.active::before {
            transform: translateY(-50%) scaleY(1);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            opacity: 0.85;
            transition: var(--transition-fast);
        }

        .nav-item:hover svg {
            opacity: 1;
            transform: scale(1.1);
        }

        .nav-badge {
            margin-left: auto;
            background: linear-gradient(135deg, var(--terracotta) 0%, var(--terracotta-light) 100%);
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(193, 122, 94, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* 側邊欄底部裝飾 */
        .admin-sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            background: linear-gradient(0deg, rgba(0,0,0,0.3) 0%, transparent 100%);
        }

        .admin-sidebar-footer svg {
            width: 100%;
            height: 40px;
            opacity: 0.1;
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 280px;
            padding: 2rem 2.5rem;
            min-height: 100vh;
        }

        /* Header */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            animation: fadeSlideDown 0.5s ease;
        }

        @keyframes fadeSlideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .admin-header h2 {
            font-family: var(--font-heading);
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--olive-deep);
            position: relative;
        }

        .admin-header h2::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: linear-gradient(90deg, var(--terracotta) 0%, var(--terracotta-light) 100%);
            border-radius: 2px;
        }

        .admin-header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Stats Cards - 統計卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(212, 197, 169, 0.3);
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
            animation: cardReveal 0.6s ease backwards;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }

        @keyframes cardReveal {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--olive) 0%, var(--olive-light) 100%);
            opacity: 0;
            transition: var(--transition-base);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
            border-color: var(--sand);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.25rem;
        }

        .stat-icon {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-base);
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .stat-icon.users {
            background: linear-gradient(135deg, var(--olive-muted) 0%, rgba(107, 127, 58, 0.15) 100%);
            color: var(--olive);
        }
        .stat-icon.resources {
            background: linear-gradient(135deg, var(--terracotta-muted) 0%, rgba(212, 150, 125, 0.15) 100%);
            color: var(--terracotta);
        }
        .stat-icon.licenses {
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.1) 0%, rgba(66, 153, 225, 0.15) 100%);
            color: var(--info);
        }
        .stat-icon.pending {
            background: linear-gradient(135deg, rgba(236, 201, 75, 0.1) 0%, rgba(236, 201, 75, 0.15) 100%);
            color: var(--warning);
        }

        .stat-value {
            font-family: var(--font-display);
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--charcoal);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-500);
            margin-top: 0.35rem;
        }

        .stat-trend {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
            border-radius: var(--radius-sm);
            font-weight: 500;
        }

        .stat-trend.up {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success);
        }
        .stat-trend.down {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(212, 197, 169, 0.2);
            transition: var(--transition-base);
            overflow: hidden;
            animation: cardReveal 0.6s ease backwards;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--sand);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--cream-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--cream) 0%, rgba(247, 243, 235, 0.5) 100%);
        }

        .card-header h3 {
            font-family: var(--font-heading);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--olive-deep);
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Table - 表格優化 */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th, .data-table td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid var(--cream-dark);
        }

        .data-table th {
            font-weight: 600;
            color: var(--olive-deep);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--cream) 0%, var(--cream-dark) 100%);
        }

        .data-table th:first-child {
            border-radius: var(--radius-md) 0 0 0;
        }

        .data-table th:last-child {
            border-radius: 0 var(--radius-md) 0 0;
        }

        .data-table tbody tr {
            transition: var(--transition-fast);
        }

        .data-table tbody tr:hover {
            background: linear-gradient(90deg, var(--olive-muted) 0%, transparent 100%);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Buttons - 按鈕優化 */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--olive) 0%, var(--olive-deep) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 93, 35, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 93, 35, 0.35);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--cream-dark) 0%, var(--sand) 100%);
            color: var(--olive-deep);
            border: 1px solid var(--sand);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--sand) 0%, var(--cream-dark) 100%);
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.4rem 0.875rem;
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
        }

        /* Status Badge - 狀態標籤優化 */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.875rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .status-badge.active, .status-badge.published {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.15) 0%, rgba(72, 187, 120, 0.1) 100%);
            color: var(--success);
        }
        .status-badge.pending, .status-badge.draft {
            background: linear-gradient(135deg, rgba(236, 201, 75, 0.15) 0%, rgba(236, 201, 75, 0.1) 100%);
            color: #B7791F;
        }
        .status-badge.expired, .status-badge.rejected, .status-badge.archived {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.15) 0%, rgba(245, 101, 101, 0.1) 100%);
            color: var(--danger);
        }

        /* User Avatar */
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--sage);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--olive-deep);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-name { font-weight: 500; }
        .user-email { font-size: 0.8rem; color: var(--gray-500); }

        /* Activity List */
        .activity-list { list-style: none; }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .activity-item:last-child { border-bottom: none; }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.new-user { background: rgba(40,167,69,0.1); color: var(--success); }
        .activity-icon.license { background: rgba(23,162,184,0.1); color: var(--info); }
        .activity-icon.resource { background: rgba(193,122,94,0.1); color: var(--terracotta); }

        .activity-content { flex: 1; }
        .activity-text { font-size: 0.9rem; }
        .activity-time { font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem; }

        /* Views */
        .admin-view { display: none; }
        .admin-view.active { display: block; }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        /* Login - 登入頁面優化 */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--cream) 0%, var(--cream-dark) 50%, var(--sage) 100%);
            position: relative;
            overflow: hidden;
        }

        .login-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%234A5D23' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            animation: float 60s linear infinite;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-50px, -50px) rotate(360deg); }
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            position: relative;
            animation: loginSlideUp 0.6s ease;
            border: 1px solid rgba(212, 197, 169, 0.3);
        }

        @keyframes loginSlideUp {
            from { opacity: 0; transform: translateY(40px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--olive) 0%, var(--terracotta) 50%, var(--olive-light) 100%);
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
        }

        .login-box h2 {
            font-family: var(--font-display);
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--olive-deep);
            font-size: 1.75rem;
        }

        .login-box p {
            text-align: center;
            color: var(--gray-500);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--olive-deep);
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--sand);
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: var(--font-body);
            transition: var(--transition-fast);
            background: var(--cream);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--olive);
            background: white;
            box-shadow: 0 0 0 4px var(--olive-muted);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--olive) 0%, var(--olive-deep) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-base);
            box-shadow: 0 4px 15px rgba(74, 93, 35, 0.3);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-slow);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 93, 35, 0.4);
        }

        .login-btn:hover::before {
            left: 100%;
        }

        .error-message {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(245, 101, 101, 0.05) 100%);
            color: var(--danger);
            padding: 0.875rem 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            display: none;
            border-left: 3px solid var(--danger);
            font-size: 0.9rem;
        }

        /* Quick Actions - 快捷操作優化 */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .quick-action-btn {
            padding: 1.25rem 1rem;
            background: linear-gradient(135deg, var(--cream) 0%, white 100%);
            border: 2px solid var(--sand);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--olive) 0%, var(--olive-light) 100%);
            transform: scaleX(0);
            transition: var(--transition-base);
        }

        .quick-action-btn:hover {
            background: white;
            border-color: var(--olive);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .quick-action-btn:hover::before {
            transform: scaleX(1);
        }

        .quick-action-btn svg {
            width: 28px;
            height: 28px;
            margin-bottom: 0.75rem;
            color: var(--olive);
            transition: var(--transition-base);
        }

        .quick-action-btn:hover svg {
            transform: scale(1.15);
            color: var(--terracotta);
        }

        .quick-action-btn span {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--olive-deep);
        }

        /* Modal - Modal 優化 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(61, 74, 45, 0.4);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: white;
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(212, 197, 169, 0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 1.5rem 1.75rem;
            border-bottom: 1px solid var(--cream-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--cream) 0%, rgba(247, 243, 235, 0.5) 100%);
            position: relative;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--olive) 0%, var(--terracotta) 50%, var(--olive-light) 100%);
        }

        .modal-header h3 {
            font-family: var(--font-heading);
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--olive-deep);
        }

        .modal-close {
            background: var(--cream-dark);
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            font-size: 1.25rem;
            color: var(--gray-500);
        }

        .modal-close:hover {
            background: var(--sand);
            color: var(--olive-deep);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 1.75rem;
        }

        .modal-footer {
            padding: 1.25rem 1.75rem;
            border-top: 1px solid var(--cream-dark);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background: linear-gradient(0deg, var(--cream) 0%, transparent 100%);
        }

        /* Chat Styles */
        @keyframes typing { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1); } }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Admin Panel Chat Styles - 管理員視角：管理員在右邊，用戶在左邊 */
        .chat-message { display: flex; margin-bottom: 1rem; animation: slideIn 0.2s ease; }
        .chat-message.admin { justify-content: flex-end; }
        .chat-message.user, .chat-message.system { justify-content: flex-start; }
        .chat-message > div { max-width: 70%; display: inline-block; }
        .chat-bubble { display: inline-block; padding: 0.75rem 1rem; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; word-break: break-word; white-space: pre-wrap; }
        .chat-message.admin .chat-bubble { background: var(--olive); color: white; border-bottom-right-radius: 4px; }
        .chat-message.user .chat-bubble { background: var(--gray-100); color: var(--gray-800); border-bottom-left-radius: 4px; }
        .chat-message.system .chat-bubble { background: var(--gray-100); color: var(--gray-500); font-size: 0.85rem; text-align: center; margin: 0 auto; }
        .chat-time { font-size: 0.75rem; color: var(--gray-400); margin-top: 0.25rem; }
        .chat-message.admin .chat-time { text-align: right; }
        .chat-sender { font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.25rem; font-weight: 500; }

        .queue-item { padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--gray-100); }
        .queue-item:hover { background: var(--gray-50); }
        .queue-item.active { background: var(--olive-light); border-left: 3px solid var(--olive); }
        .queue-item .queue-user { font-weight: 500; font-size: 0.9rem; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .queue-item .queue-preview { font-size: 0.8rem; color: var(--gray-500); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .queue-item .queue-time { font-size: 0.75rem; color: var(--gray-400); }
        .queue-item .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .queue-item .status-dot.waiting { background: var(--warning); }
        .queue-item .status-dot.active { background: var(--success); }
        .queue-item .status-dot.closed { background: var(--gray-400); }

        /* Analytics Dashboard Styles */
        .analytics-metrics {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        .metric-card .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--olive-deep);
            margin-bottom: 0.25rem;
        }
        .metric-card .metric-label {
            font-size: 0.85rem;
            color: var(--gray-500);
            margin-bottom: 0.5rem;
        }
        .metric-card .metric-trend {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            display: inline-block;
        }
        .metric-card .metric-trend.up {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }
        .metric-card .metric-trend.down {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        .metric-card .metric-trend.neutral {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }
        .analytics-charts {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .chart-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--charcoal);
        }
        .chart-container {
            position: relative;
            height: 250px;
        }
        .analytics-bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .top-resources-table {
            width: 100%;
            border-collapse: collapse;
        }
        .top-resources-table th,
        .top-resources-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        .top-resources-table th {
            font-weight: 500;
            color: var(--gray-500);
            font-size: 0.8rem;
        }
        .top-resources-table tr:hover {
            background: var(--gray-100);
        }
        .support-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .support-stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--gray-100);
            border-radius: 8px;
        }
        .support-stat-item .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--olive-deep);
        }
        .support-stat-item .stat-label {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }
        @media (max-width: 1200px) {
            .analytics-metrics { grid-template-columns: repeat(3, 1fr); }
            .analytics-charts { grid-template-columns: 1fr; }
            .analytics-bottom { grid-template-columns: 1fr; }
        }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Login View -->
    <div id="loginView" class="login-container">
        <div class="login-box">
            <h2>BeyondBridge</h2>
            <p>管理員後台登入</p>
            <div id="loginError" class="error-message"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>密碼</label>
                    <input type="password" id="loginPassword" class="form-input" required>
                </div>
                <button type="submit" class="login-btn">登入</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <h1>BeyondBridge</h1>
                <span>管理後台 Admin Panel</span>
            </div>
            <nav class="admin-nav">
                <div class="nav-section">主要功能</div>
                <a class="nav-item active" data-view="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
                    </svg>
                    儀表板
                </a>
                <a class="nav-item" data-view="users">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    用戶管理
                </a>
                <a class="nav-item" data-view="resources">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                    </svg>
                    教材管理
                </a>
                <a class="nav-item" data-view="licenses">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                    </svg>
                    授權管理
                    <span class="nav-badge" id="pendingLicensesBadge">0</span>
                </a>
                <a class="nav-item" data-view="announcements">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    公告管理
                </a>
                <a class="nav-item" data-view="support">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    客服中心
                    <span class="nav-badge" id="waitingChatsBadge" style="background: var(--terracotta);">0</span>
                </a>

                <div class="nav-section">分析</div>
                <a class="nav-item" data-view="analytics">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                    數據分析
                </a>

                <div class="nav-section">帳戶</div>
                <a class="nav-item" id="logoutBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    登出
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Dashboard View -->
            <div id="dashboardView" class="admin-view active">
                <div class="admin-header">
                    <h2>儀表板</h2>
                    <div class="admin-header-actions">
                        <span id="adminName">管理員</span>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon users">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                </svg>
                            </div>
                            <span class="stat-trend up" id="userTrend">+0%</span>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">總用戶數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon resources">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-value" id="totalResources">0</div>
                        <div class="stat-label">教材資源</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon licenses">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-value" id="activeLicenses">0</div>
                        <div class="stat-label">有效授權</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-icon pending">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stat-value" id="pendingRequests">0</div>
                        <div class="stat-label">待處理請求</div>
                    </div>
                </div>

                <div class="content-grid">
                    <div class="card">
                        <div class="card-header">
                            <h3>最近註冊用戶</h3>
                            <button class="btn btn-sm btn-secondary" onclick="showView('users')">查看全部</button>
                        </div>
                        <div class="card-body">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>用戶</th>
                                        <th>角色</th>
                                        <th>註冊時間</th>
                                    </tr>
                                </thead>
                                <tbody id="recentUsersTable">
                                    <tr><td colspan="3" class="loading">載入中...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>快速操作</h3>
                        </div>
                        <div class="card-body">
                            <div class="quick-actions">
                                <div class="quick-action-btn" onclick="showView('resources'); openCreateResourceModal()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    <span>新增教材</span>
                                </div>
                                <div class="quick-action-btn" onclick="showView('announcements'); openCreateAnnouncementModal()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                    </svg>
                                    <span>發布公告</span>
                                </div>
                                <div class="quick-action-btn" onclick="showView('licenses')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="9 11 12 14 22 4"/>
                                        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                                    </svg>
                                    <span>審核授權</span>
                                </div>
                                <div class="quick-action-btn" onclick="showView('analytics')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="20" x2="18" y2="10"/>
                                        <line x1="12" y1="20" x2="12" y2="4"/>
                                        <line x1="6" y1="20" x2="6" y2="14"/>
                                    </svg>
                                    <span>查看報表</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users View -->
            <div id="usersView" class="admin-view">
                <div class="admin-header">
                    <h2>用戶管理</h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="search-box" style="position: relative;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.5;">
                                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                            <input type="text" id="userSearchInput" placeholder="搜尋用戶..." style="padding: 0.5rem 1rem 0.5rem 2.5rem; border: 1px solid var(--gray-200); border-radius: 8px; width: 250px;" oninput="filterUsers()">
                        </div>
                        <button class="btn btn-primary" onclick="openCreateUserModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                            </svg>
                            新增用戶
                        </button>
                    </div>
                </div>

                <!-- 角色分類統計 -->
                <div class="role-stats" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div class="stat-card" onclick="filterUsersByRole('all')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid var(--olive); transition: all 0.2s;" id="roleCardAll">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">全部用戶</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: var(--olive);" id="countAll">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(74,93,35,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--olive)" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="filterUsersByRole('educator')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleCardEducator">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">建橋者</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #3b82f6;" id="countEducator">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(59,130,246,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                                    <path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="filterUsersByRole('trainer')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleCardTrainer">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">橋樑工匠</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #f59e0b;" id="countTrainer">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(245,158,11,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="filterUsersByRole('creator')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleCardCreator">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">知識建築師</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #8b5cf6;" id="countCreator">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(139,92,246,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="stat-card" onclick="filterUsersByRole('student')" style="background: white; border-radius: 12px; padding: 1.25rem; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;" id="roleCardStudent">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--gray-500);">探橋者</div>
                                <div style="font-size: 1.75rem; font-weight: 700; color: #10b981;" id="countStudent">0</div>
                            </div>
                            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(16,185,129,0.1); display: flex; align-items: center; justify-content: center;">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>用戶</th>
                                    <th>角色</th>
                                    <th>訂閱方案</th>
                                    <th>狀態</th>
                                    <th>註冊時間</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="6" class="loading">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Resources View -->
            <div id="resourcesView" class="admin-view">
                <div class="admin-header">
                    <h2>教材管理</h2>
                    <button class="btn btn-primary" onclick="openCreateResourceModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        新增教材
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>標題</th>
                                    <th>類型</th>
                                    <th>分類</th>
                                    <th>狀態</th>
                                    <th>瀏覽次數</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="resourcesTableBody">
                                <tr><td colspan="6" class="loading">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Licenses View -->
            <div id="licensesView" class="admin-view">
                <div class="admin-header">
                    <h2>授權管理</h2>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>資源</th>
                                    <th>用戶</th>
                                    <th>類型</th>
                                    <th>狀態</th>
                                    <th>到期日</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="licensesTableBody">
                                <tr><td colspan="6" class="loading">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Announcements View -->
            <div id="announcementsView" class="admin-view">
                <div class="admin-header">
                    <h2>公告管理</h2>
                    <button class="btn btn-primary" onclick="openCreateAnnouncementModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        新增公告
                    </button>
                </div>
                <div class="card">
                    <div class="card-body">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>標題</th>
                                    <th>優先級</th>
                                    <th>狀態</th>
                                    <th>發布時間</th>
                                    <th>瀏覽次數</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="announcementsTableBody">
                                <tr><td colspan="6" class="loading">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analyticsView" class="admin-view">
                <div class="admin-header">
                    <h2>數據分析</h2>
                </div>

                <!-- Key Metrics -->
                <div class="analytics-metrics">
                    <div class="metric-card">
                        <div class="metric-value" id="metricTotalUsers">0</div>
                        <div class="metric-label">總用戶數</div>
                        <span class="metric-trend neutral" id="metricUsersTrend">--</span>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metricNewUsers">0</div>
                        <div class="metric-label">本月新增</div>
                        <span class="metric-trend neutral" id="metricNewUsersTrend">--</span>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metricResources">0</div>
                        <div class="metric-label">已發布教材</div>
                        <span class="metric-trend neutral" id="metricResourcesTrend">--</span>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metricLicenses">0</div>
                        <div class="metric-label">活躍授權</div>
                        <span class="metric-trend neutral" id="metricLicensesTrend">--</span>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="metricRating">-</div>
                        <div class="metric-label">客服滿意度</div>
                        <span class="metric-trend neutral" id="metricRatingTrend">--</span>
                    </div>
                </div>

                <!-- Charts Row 1 -->
                <div class="analytics-charts">
                    <div class="chart-card">
                        <h3>用戶成長趨勢</h3>
                        <div class="chart-container">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>用戶角色分布</h3>
                        <div class="chart-container">
                            <canvas id="userRolesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Charts Row 2 -->
                <div class="analytics-charts">
                    <div class="chart-card">
                        <h3>教材分類分布</h3>
                        <div class="chart-container">
                            <canvas id="resourceCategoriesChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>授權狀態分布</h3>
                        <div class="chart-container">
                            <canvas id="licenseStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section -->
                <div class="analytics-bottom">
                    <div class="chart-card">
                        <h3>熱門教材 Top 5</h3>
                        <table class="top-resources-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>教材名稱</th>
                                    <th>瀏覽次數</th>
                                    <th>評分</th>
                                    <th>授權數</th>
                                </tr>
                            </thead>
                            <tbody id="topResourcesBody">
                                <tr><td colspan="5" style="text-align:center; color: var(--gray-400);">載入中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="chart-card">
                        <h3>客服統計</h3>
                        <div class="support-stat-grid">
                            <div class="support-stat-item">
                                <div class="stat-value" id="supportTotalChats">0</div>
                                <div class="stat-label">總對話數</div>
                            </div>
                            <div class="support-stat-item">
                                <div class="stat-value" id="supportClosedChats">0</div>
                                <div class="stat-label">已結束</div>
                            </div>
                            <div class="support-stat-item">
                                <div class="stat-value" id="supportAvgRating">-</div>
                                <div class="stat-label">平均評分</div>
                            </div>
                            <div class="support-stat-item">
                                <div class="stat-value" id="supportSatisfaction">0%</div>
                                <div class="stat-label">滿意度</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Support View - 客服中心 -->
            <div id="supportView" class="admin-view">
                <div class="admin-header">
                    <h2>客服中心</h2>
                    <div class="admin-header-actions">
                        <div id="adminOnlineStatus" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--success); color: white; border-radius: 20px; font-size: 0.85rem;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; background: white;"></span>
                            在線服務中
                        </div>
                    </div>
                </div>

                <!-- Support Stats -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-value" id="waitingChatsCount">0</div>
                        <div class="stat-label">需處理</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeChatsCount">0</div>
                        <div class="stat-label">進行中</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="closedChatsCount">0</div>
                        <div class="stat-label">已結束</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgChatRating">-</div>
                        <div class="stat-label">平均評分</div>
                    </div>
                </div>

                <!-- Support Tabs -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="support-tab active" onclick="switchSupportTab(this, 'waiting')" style="padding: 0.5rem 1.25rem; border: none; background: var(--terracotta); color: white; border-radius: 20px; cursor: pointer; font-weight: 500;">
                        需處理 <span id="waitingTabCount">(0)</span>
                    </button>
                    <button class="support-tab" onclick="switchSupportTab(this, 'active')" style="padding: 0.5rem 1.25rem; border: none; background: var(--gray-100); color: var(--gray-600); border-radius: 20px; cursor: pointer;">
                        進行中 <span id="activeTabCount">(0)</span>
                    </button>
                    <button class="support-tab" onclick="switchSupportTab(this, 'closed')" style="padding: 0.5rem 1.25rem; border: none; background: var(--gray-100); color: var(--gray-600); border-radius: 20px; cursor: pointer;">
                        已結束
                    </button>
                </div>

                <!-- Support Container -->
                <div style="display: grid; grid-template-columns: 350px 1fr; gap: 1rem; height: calc(100vh - 340px); min-height: 400px;">
                    <!-- Chat Queue -->
                    <div class="card" style="overflow: hidden; display: flex; flex-direction: column;">
                        <div class="card-header" style="padding: 1rem; border-bottom: 1px solid var(--gray-200);">
                            <h3 style="font-size: 0.95rem; font-weight: 600;">客服隊列</h3>
                        </div>
                        <div id="adminChatQueue" style="flex: 1; overflow-y: auto; padding: 0.5rem;">
                            <div style="text-align: center; padding: 2rem 1rem; color: var(--gray-400);">
                                <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 0.5rem; opacity: 0.5;">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                                </svg>
                                <p style="font-size: 0.85rem;">目前沒有等待中的對話</p>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Chat Window -->
                    <div class="card" style="overflow: hidden; display: flex; flex-direction: column;">
                        <!-- Chat Header -->
                        <div id="adminChatHeader" style="padding: 1rem; border-bottom: 1px solid var(--gray-200); display: none;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <div id="adminChatUserAvatar" style="width: 40px; height: 40px; border-radius: 50%; background: var(--terracotta); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">U</div>
                                    <div>
                                        <h4 id="adminChatUserName" style="font-size: 0.95rem; font-weight: 600;">用戶</h4>
                                        <p id="adminChatUserEmail" style="font-size: 0.8rem; color: var(--gray-500);">user@example.com</p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="adminClaimChat()" id="claimChatBtn" style="padding: 0.5rem 1rem; background: var(--olive); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">接手對話</button>
                                    <button onclick="adminCloseChat()" style="padding: 0.5rem 1rem; background: var(--gray-100); border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">結束對話</button>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div id="adminChatMessages" style="flex: 1; overflow-y: auto; padding: 1rem; background: var(--gray-50);">
                            <div id="adminChatWelcome" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: var(--gray-400);">
                                <svg viewBox="0 0 24 24" width="80" height="80" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 1rem; opacity: 0.3;">
                                    <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                                </svg>
                                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--gray-600);">客服工作台</h3>
                                <p style="font-size: 0.9rem; max-width: 300px;">選擇左側隊列中的對話開始服務用戶</p>
                            </div>
                        </div>

                        <!-- Admin Typing Indicator -->
                        <div id="adminTypingIndicator" style="display: none; padding: 0.5rem 1rem; background: var(--gray-50); border-top: 1px solid var(--gray-100);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--gray-500); font-size: 0.85rem;">
                                <div style="display: flex; gap: 3px;">
                                    <span style="width: 6px; height: 6px; background: var(--gray-400); border-radius: 50%; animation: typing 1s infinite;"></span>
                                    <span style="width: 6px; height: 6px; background: var(--gray-400); border-radius: 50%; animation: typing 1s infinite 0.2s;"></span>
                                    <span style="width: 6px; height: 6px; background: var(--gray-400); border-radius: 50%; animation: typing 1s infinite 0.4s;"></span>
                                </div>
                                <span id="adminTypingUser">用戶正在輸入...</span>
                            </div>
                        </div>

                        <!-- Admin Chat Input -->
                        <div id="adminChatInput" style="display: none; padding: 1rem; border-top: 1px solid var(--gray-200); background: white;">
                            <div style="display: flex; gap: 0.75rem; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <textarea id="adminMessageInput" placeholder="輸入回覆訊息..." rows="1" style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--gray-300); border-radius: 20px; font-size: 0.95rem; resize: none; max-height: 120px; line-height: 1.4;" onkeydown="handleAdminChatKeyDown(event)" oninput="handleAdminChatInput(this)"></textarea>
                                </div>
                                <button onclick="sendAdminMessage()" style="padding: 0.75rem 1.25rem; background: var(--olive); color: white; border: none; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-weight: 500;">
                                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                                    發送
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="createResourceModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="resourceModalTitle">新增教材</h3>
                <button class="modal-close" onclick="closeModal('createResourceModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="createResourceForm">
                    <input type="hidden" name="resourceId" value="">

                    <!-- 基本資訊 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">基本資訊</h4>
                        <div class="form-group">
                            <label>標題 *</label>
                            <input type="text" name="title" class="form-input" required placeholder="請輸入教材標題">
                        </div>
                        <div class="form-group">
                            <label>描述</label>
                            <textarea name="description" class="form-input" rows="3" placeholder="教材簡介說明"></textarea>
                        </div>
                    </div>

                    <!-- 分類設定 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">分類設定</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>類型 *</label>
                                <select name="type" class="form-input" required>
                                    <option value="video">影音教材</option>
                                    <option value="interactive">互動教材</option>
                                    <option value="document">文件講義</option>
                                    <option value="quiz">測驗題庫</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>分類 *</label>
                                <select name="category" class="form-input" required>
                                    <option value="math">數學</option>
                                    <option value="chinese">國文</option>
                                    <option value="english">英文</option>
                                    <option value="science">自然科學</option>
                                    <option value="social">社會科學</option>
                                    <option value="business">商業管理</option>
                                    <option value="technology">資訊科技</option>
                                    <option value="arts">藝術人文</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>適用年級 *</label>
                                <select name="gradeLevel" class="form-input" required>
                                    <option value="elementary">國小</option>
                                    <option value="junior">國中</option>
                                    <option value="senior">高中</option>
                                    <option value="university">大學</option>
                                    <option value="corporate">企業培訓</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 內容資訊 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">內容資訊</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>時長（分鐘）</label>
                                <input type="number" name="duration" class="form-input" min="0" placeholder="例：60">
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>單元數</label>
                                <input type="number" name="unitCount" class="form-input" min="0" placeholder="例：12">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
                            <label>標籤 <span style="color: #94a3b8; font-weight: normal;">（用逗號分隔）</span></label>
                            <input type="text" name="tags" class="form-input" placeholder="例：代數, 方程式, 基礎數學">
                        </div>
                    </div>

                    <!-- 定價設定 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">定價設定</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>定價模式</label>
                                <select name="pricingModel" class="form-input" onchange="togglePriceField(this.value)">
                                    <option value="license">授權制</option>
                                    <option value="free">免費</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;" id="priceFieldGroup">
                                <label>價格（NT$）</label>
                                <input type="number" name="price" class="form-input" min="0" placeholder="例：1200">
                            </div>
                        </div>
                    </div>

                    <!-- 目標受眾 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">目標受眾</h4>
                        <div style="display: flex; gap: 20px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" name="targetAudience" value="educator" checked>
                                <span>教師</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" name="targetAudience" value="student" checked>
                                <span>學生</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" name="targetAudience" value="trainer">
                                <span>培訓師</span>
                            </label>
                        </div>
                    </div>

                    <!-- 發布狀態 -->
                    <div style="background: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 14px; color: #64748b;">發布狀態</h4>
                        <div class="form-group" style="margin-bottom: 0;">
                            <select name="status" class="form-input">
                                <option value="draft">草稿</option>
                                <option value="published">已發布</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createResourceModal')">取消</button>
                <button class="btn btn-primary" onclick="submitResourceForm()">儲存</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createAnnouncementModal">
        <div class="modal">
            <div class="modal-header">
                <h3>新增公告</h3>
                <button class="modal-close" onclick="closeModal('createAnnouncementModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createAnnouncementForm">
                    <div class="form-group">
                        <label>標題 *</label>
                        <input type="text" name="title" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>內容 *</label>
                        <textarea name="content" class="form-input" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>優先級</label>
                        <select name="priority" class="form-input">
                            <option value="normal">一般</option>
                            <option value="high">重要</option>
                            <option value="urgent">緊急</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createAnnouncementModal')">取消</button>
                <button class="btn btn-primary" onclick="submitCreateAnnouncement()">發布</button>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal-overlay" id="createUserModal">
        <div class="modal">
            <div class="modal-header">
                <h3>新增用戶</h3>
                <button class="modal-close" onclick="closeModal('createUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createUserForm">
                    <div class="form-group">
                        <label>姓名 *</label>
                        <input type="text" name="displayName" class="form-input" required placeholder="用戶姓名">
                    </div>
                    <div class="form-group">
                        <label>電子郵件 *</label>
                        <input type="email" name="email" class="form-input" required placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label>密碼 *</label>
                        <input type="password" name="password" class="form-input" required placeholder="至少 6 個字元" minlength="6">
                    </div>
                    <div class="form-group">
                        <label>角色 *</label>
                        <select name="role" class="form-input" required>
                            <option value="educator">教育工作者</option>
                            <option value="trainer">企業培訓主管</option>
                            <option value="creator">內容創作者</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>學校/機構</label>
                        <input type="text" name="organization" class="form-input" placeholder="選填">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createUserModal')">取消</button>
                <button class="btn btn-primary" onclick="submitCreateUser()">建立用戶</button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ========== 客服中心全域變數 ==========
        let adminSocket = null;
        let adminChatRooms = [];
        let currentAdminChatId = null;
        let adminTypingTimeout = null;
        let currentSupportFilter = 'waiting';

        // 用戶管理全域變數
        let allUsers = [];
        let currentRoleFilter = 'all';

        // 角色名稱對照
        const roleNames = {
            'educator': '建橋者',
            'trainer': '橋樑工匠',
            'creator': '知識建築師',
            'student': '探橋者'
        };

        // View Management
        function showView(viewName) {
            document.querySelectorAll('.admin-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(`${viewName}View`).classList.add('active');
            document.querySelector(`.nav-item[data-view="${viewName}"]`)?.classList.add('active');

            // Load data for the view
            switch(viewName) {
                case 'dashboard': loadDashboard(); break;
                case 'users': loadUsers(); break;
                case 'resources': loadResources(); break;
                case 'licenses': loadLicenses(); break;
                case 'announcements': loadAnnouncements(); break;
                case 'analytics': loadAnalytics(); break;
                case 'support': loadAdminChatRooms(); break;
            }
        }

        // Auth
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            try {
                const result = await API.auth.login(email, password);
                if (result.success && result.data.user.isAdmin) {
                    document.getElementById('loginView').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'flex';
                    document.getElementById('adminName').textContent = result.data.user.displayName;
                    loadDashboard();
                } else if (result.success && !result.data.user.isAdmin) {
                    errorDiv.textContent = '此帳號不是管理員';
                    errorDiv.style.display = 'block';
                    API.clearTokens();
                } else {
                    errorDiv.textContent = result.message || '登入失敗';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = '登入失敗，請檢查網路連線';
                errorDiv.style.display = 'block';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await API.auth.logout();
            // 跳轉回主平台登入頁面
            window.location.href = '/platform/';
        });

        // Load Dashboard
        async function loadDashboard() {
            try {
                const result = await API.admin.getDashboard();
                if (result.success) {
                    const { stats, recentUsers } = result.data;
                    document.getElementById('totalUsers').textContent = stats.totalUsers;
                    document.getElementById('totalResources').textContent = stats.publishedResources;
                    document.getElementById('activeLicenses').textContent = stats.activeLicenses;
                    document.getElementById('pendingRequests').textContent = stats.pendingLicenses;
                    document.getElementById('pendingLicensesBadge').textContent = stats.pendingLicenses;

                    // Recent users table
                    const tbody = document.getElementById('recentUsersTable');
                    if (recentUsers.length > 0) {
                        tbody.innerHTML = recentUsers.map(u => `
                            <tr>
                                <td>
                                    <div class="user-info">
                                        <div class="user-avatar">${(u.displayName || 'U')[0]}</div>
                                        <div>
                                            <div class="user-name">${u.displayName || 'Unknown'}</div>
                                            <div class="user-email">${u.email}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>${u.role || 'educator'}</td>
                                <td>${formatDate(u.createdAt)}</td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="3">尚無用戶</td></tr>';
                    }
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
            }
        }

        // Load Users
        async function loadUsers() {
            try {
                const result = await API.admin.getUsers();
                if (result.success) {
                    allUsers = result.data || [];
                    updateRoleCounts();
                    renderUsers(getFilteredUsers());
                }
            } catch (error) {
                console.error('Load users error:', error);
            }
        }

        // 更新角色統計數量
        function updateRoleCounts() {
            const counts = {
                all: allUsers.length,
                educator: 0,
                trainer: 0,
                creator: 0,
                student: 0
            };

            allUsers.forEach(u => {
                const role = u.role || 'educator';
                if (counts[role] !== undefined) {
                    counts[role]++;
                }
            });

            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countEducator').textContent = counts.educator;
            document.getElementById('countTrainer').textContent = counts.trainer;
            document.getElementById('countCreator').textContent = counts.creator;
            document.getElementById('countStudent').textContent = counts.student;
        }

        // 根據角色篩選用戶
        function filterUsersByRole(role) {
            currentRoleFilter = role;

            // 更新卡片選中狀態
            document.querySelectorAll('.role-stats .stat-card').forEach(card => {
                card.style.borderColor = 'transparent';
            });
            const selectedCard = document.getElementById(`roleCard${role.charAt(0).toUpperCase() + role.slice(1)}`);
            if (selectedCard) {
                selectedCard.style.borderColor = 'var(--olive)';
            }

            renderUsers(getFilteredUsers());
        }

        // 搜尋篩選用戶
        function filterUsers() {
            renderUsers(getFilteredUsers());
        }

        // 取得篩選後的用戶列表
        function getFilteredUsers() {
            const searchQuery = (document.getElementById('userSearchInput')?.value || '').toLowerCase();

            return allUsers.filter(u => {
                // 角色篩選
                if (currentRoleFilter !== 'all' && (u.role || 'educator') !== currentRoleFilter) {
                    return false;
                }

                // 搜尋篩選
                if (searchQuery) {
                    const name = (u.displayName || '').toLowerCase();
                    const email = (u.email || '').toLowerCase();
                    if (!name.includes(searchQuery) && !email.includes(searchQuery)) {
                        return false;
                    }
                }

                return true;
            });
        }

        // 渲染用戶列表
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (users.length > 0) {
                tbody.innerHTML = users.map(u => {
                    const role = u.role || 'educator';
                    const roleName = roleNames[role] || role;
                    const roleColor = getRoleColor(role);

                    return `
                        <tr data-role="${role}">
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">${(u.displayName || 'U')[0]}</div>
                                    <div>
                                        <div class="user-name">${u.displayName || 'Unknown'}</div>
                                        <div class="user-email">${u.email}</div>
                                    </div>
                                </div>
                            </td>
                            <td><span style="color: ${roleColor}; font-weight: 500;">${roleName}</span></td>
                            <td>${u.subscriptionTier || 'free'}</td>
                            <td><span class="status-badge ${u.status}">${u.status}</span></td>
                            <td>${formatDate(u.createdAt)}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="toggleUserStatus('${u.userId}', '${u.status}')">
                                    ${u.status === 'active' ? '停用' : '啟用'}
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6">無符合條件的用戶</td></tr>';
            }
        }

        // 取得角色對應顏色
        function getRoleColor(role) {
            const colors = {
                'educator': '#3b82f6',
                'trainer': '#f59e0b',
                'creator': '#8b5cf6',
                'student': '#10b981'
            };
            return colors[role] || '#6b7280';
        }

        // Load Resources
        // 教材類型標籤
        const typeLabels = {
            video: '影音教材',
            interactive: '互動教材',
            document: '文件講義',
            quiz: '測驗題庫'
        };

        // 教材分類標籤
        const categoryLabels = {
            math: '數學',
            chinese: '國文',
            english: '英文',
            science: '自然科學',
            social: '社會科學',
            business: '商業管理',
            technology: '資訊科技',
            arts: '藝術人文'
        };

        // 狀態標籤
        const statusLabels = {
            draft: '草稿',
            published: '已發布',
            archived: '已下架'
        };

        // 儲存教材資料供編輯使用
        let allResources = [];

        async function loadResources() {
            try {
                const result = await API.resources.list({ limit: 100 });
                const tbody = document.getElementById('resourcesTableBody');
                if (result.success && result.data.length > 0) {
                    allResources = result.data;
                    tbody.innerHTML = result.data.map(r => `
                        <tr>
                            <td>${r.title}</td>
                            <td>${typeLabels[r.type] || r.type}</td>
                            <td>${categoryLabels[r.category] || r.category}</td>
                            <td><span class="status-badge ${r.status}">${statusLabels[r.status] || r.status}</span></td>
                            <td>${r.viewCount || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="editResource('${r.resourceId}')">編輯</button>
                                ${r.status === 'draft' ? `<button class="btn btn-sm btn-primary" onclick="publishResource('${r.resourceId}')">發布</button>` : ''}
                                ${r.status === 'published' ? `<button class="btn btn-sm btn-secondary" onclick="archiveResource('${r.resourceId}')">下架</button>` : ''}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">尚無教材</td></tr>';
                }
            } catch (error) {
                console.error('Load resources error:', error);
            }
        }

        function editResource(resourceId) {
            const resource = allResources.find(r => r.resourceId === resourceId);
            if (resource) {
                openEditResourceModal(resource);
            }
        }

        async function archiveResource(resourceId) {
            if (!confirm('確定要下架此教材嗎？')) return;
            const result = await API.admin.updateResource(resourceId, { status: 'archived' });
            if (result.success) {
                loadResources();
            } else {
                alert(result.message || '操作失敗');
            }
        }

        // Load Licenses
        async function loadLicenses() {
            try {
                const result = await API.admin.getLicenses();
                const tbody = document.getElementById('licensesTableBody');
                if (result.success && result.data.length > 0) {
                    tbody.innerHTML = result.data.map(l => `
                        <tr>
                            <td>${l.resourceTitle}</td>
                            <td>${l.userId}</td>
                            <td>${l.licenseType}</td>
                            <td><span class="status-badge ${l.status}">${l.status}</span></td>
                            <td>${l.expiryDate ? formatDate(l.expiryDate) : '-'}</td>
                            <td>
                                ${l.status === 'pending' ? `
                                    <button class="btn btn-sm btn-primary" onclick="approveLicense('${l.licenseId}', true)">核准</button>
                                    <button class="btn btn-sm btn-secondary" onclick="approveLicense('${l.licenseId}', false)">拒絕</button>
                                ` : '-'}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">尚無授權記錄</td></tr>';
                }
            } catch (error) {
                console.error('Load licenses error:', error);
            }
        }

        // Load Announcements
        async function loadAnnouncements() {
            try {
                const result = await API.admin.getAllAnnouncements();
                const tbody = document.getElementById('announcementsTableBody');
                if (result.success && result.data.length > 0) {
                    tbody.innerHTML = result.data.map(a => `
                        <tr>
                            <td>${a.title}</td>
                            <td>${a.priority}</td>
                            <td><span class="status-badge ${a.status}">${a.status}</span></td>
                            <td>${formatDate(a.publishAt)}</td>
                            <td>${a.viewCount || 0}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="deleteAnnouncement('${a.announcementId}')">刪除</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6">尚無公告</td></tr>';
                }
            } catch (error) {
                console.error('Load announcements error:', error);
            }
        }

        // Analytics Charts instances
        let userGrowthChart = null;
        let userRolesChart = null;
        let resourceCategoriesChart = null;
        let licenseStatusChart = null;

        // Load Analytics
        async function loadAnalytics() {
            try {
                const result = await API.admin.getAnalytics();
                if (!result.success) return;

                const data = result.data;

                // ========== Update Key Metrics ==========
                updateMetricCard('metricTotalUsers', 'metricUsersTrend', data.metrics.totalUsers, data.metrics.newUsersThisMonth, '本月');
                updateMetricCard('metricNewUsers', 'metricNewUsersTrend', data.metrics.newUsersThisMonth, data.metrics.newUsersLastMonth);
                updateMetricCard('metricResources', 'metricResourcesTrend', data.metrics.totalResources, data.metrics.resourcesLastMonth);
                updateMetricCard('metricLicenses', 'metricLicensesTrend', data.metrics.activeLicenses, data.metrics.licensesLastMonth);

                const ratingEl = document.getElementById('metricRating');
                if (ratingEl) ratingEl.textContent = data.metrics.avgCustomerRating > 0 ? data.metrics.avgCustomerRating.toFixed(1) : '-';

                // ========== User Growth Chart ==========
                renderUserGrowthChart(data.userGrowthTrend);

                // ========== User Roles Chart ==========
                renderUserRolesChart(data.userRoles);

                // ========== Resource Categories Chart ==========
                renderResourceCategoriesChart(data.resourceCategories);

                // ========== License Status Chart ==========
                renderLicenseStatusChart(data.licenseStatus);

                // ========== Top Resources Table ==========
                renderTopResources(data.topResources);

                // ========== Support Stats ==========
                const stats = data.supportStats;
                const totalChatsEl = document.getElementById('supportTotalChats');
                const closedChatsEl = document.getElementById('supportClosedChats');
                const avgRatingEl = document.getElementById('supportAvgRating');
                const satisfactionEl = document.getElementById('supportSatisfaction');

                if (totalChatsEl) totalChatsEl.textContent = stats.totalChats;
                if (closedChatsEl) closedChatsEl.textContent = stats.closedChats;
                if (avgRatingEl) avgRatingEl.textContent = stats.avgRating > 0 ? stats.avgRating : '-';
                if (satisfactionEl) satisfactionEl.textContent = stats.satisfactionRate + '%';

            } catch (error) {
                console.error('Load analytics error:', error);
            }
        }

        function updateMetricCard(valueId, trendId, current, previous, suffix = '') {
            const valueEl = document.getElementById(valueId);
            const trendEl = document.getElementById(trendId);
            if (valueEl) valueEl.textContent = current;
            if (trendEl && previous > 0) {
                const change = Math.round(((current - previous) / previous) * 100);
                const isUp = change >= 0;
                trendEl.className = `metric-trend ${isUp ? 'up' : 'down'}`;
                trendEl.textContent = `${isUp ? '↑' : '↓'} ${Math.abs(change)}%${suffix ? ' ' + suffix : ''}`;
            }
        }

        function renderUserGrowthChart(trendData) {
            const ctx = document.getElementById('userGrowthChart');
            if (!ctx) return;

            if (userGrowthChart) userGrowthChart.destroy();

            userGrowthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(d => d.label),
                    datasets: [
                        {
                            label: '累計用戶',
                            data: trendData.map(d => d.total),
                            borderColor: '#4A5D23',
                            backgroundColor: 'rgba(74, 93, 35, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: '新增用戶',
                            data: trendData.map(d => d.newUsers),
                            borderColor: '#C17A5E',
                            backgroundColor: 'rgba(193, 122, 94, 0.1)',
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function renderUserRolesChart(roles) {
            const ctx = document.getElementById('userRolesChart');
            if (!ctx) return;

            if (userRolesChart) userRolesChart.destroy();

            const roleLabels = { educator: '教師', student: '學生', trainer: '培訓師', admin: '管理員' };
            const labels = Object.keys(roles).map(r => roleLabels[r] || r);
            const values = Object.values(roles);

            userRolesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#4A5D23', '#6B7F3A', '#C17A5E', '#A8B89A'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderResourceCategoriesChart(categories) {
            const ctx = document.getElementById('resourceCategoriesChart');
            if (!ctx) return;

            if (resourceCategoriesChart) resourceCategoriesChart.destroy();

            const categoryLabels = {
                math: '數學', chinese: '國文', english: '英文', science: '自然科學',
                social: '社會科學', business: '商業管理', technology: '資訊科技',
                arts: '藝術人文', art: '藝術', pe: '體育', other: '其他'
            };
            const labels = Object.keys(categories).map(c => categoryLabels[c] || c);
            const values = Object.values(categories);

            resourceCategoriesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '教材數量',
                        data: values,
                        backgroundColor: '#4A5D23',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function renderLicenseStatusChart(status) {
            const ctx = document.getElementById('licenseStatusChart');
            if (!ctx) return;

            if (licenseStatusChart) licenseStatusChart.destroy();

            const statusLabels = { pending: '待審核', active: '使用中', expired: '已過期', rejected: '已拒絕' };
            const statusColors = { pending: '#ffc107', active: '#28a745', expired: '#6c757d', rejected: '#dc3545' };
            const labels = Object.keys(status).map(s => statusLabels[s] || s);
            const values = Object.values(status);
            const colors = Object.keys(status).map(s => statusColors[s] || '#ccc');

            licenseStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderTopResources(resources) {
            const tbody = document.getElementById('topResourcesBody');
            if (!tbody) return;

            if (!resources || resources.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--gray-400);">暫無資料</td></tr>';
                return;
            }

            const categoryLabels = {
                math: '數學', chinese: '國文', english: '英文', science: '自然科學',
                social: '社會科學', business: '商業管理', technology: '資訊科技',
                arts: '藝術人文', art: '藝術', pe: '體育', other: '其他'
            };

            tbody.innerHTML = resources.map((r, i) => `
                <tr>
                    <td style="font-weight: 600; color: var(--olive);">${i + 1}</td>
                    <td>
                        <div style="font-weight: 500;">${escapeHtml(r.title)}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-500);">${categoryLabels[r.category] || r.category}</div>
                    </td>
                    <td>${r.viewCount.toLocaleString()}</td>
                    <td>${r.rating > 0 ? r.rating.toFixed(1) : '-'}</td>
                    <td>${r.licensedCount}</td>
                </tr>
            `).join('');
        }

        // Actions
        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
            const result = await API.admin.updateUserStatus(userId, newStatus);
            if (result.success) {
                // 更新本地資料
                const userIndex = allUsers.findIndex(u => u.userId === userId);
                if (userIndex !== -1) {
                    allUsers[userIndex].status = newStatus;
                }
                renderUsers(getFilteredUsers());
            }
        }

        async function publishResource(resourceId) {
            const result = await API.admin.publishResource(resourceId);
            if (result.success) loadResources();
        }

        async function deleteResource(resourceId) {
            if (confirm('確定要下架此教材嗎？')) {
                const result = await API.admin.deleteResource(resourceId);
                if (result.success) loadResources();
            }
        }

        async function approveLicense(licenseId, approved) {
            const result = await API.admin.approveLicense(licenseId, approved);
            if (result.success) {
                loadLicenses();
                loadDashboard();
            }
        }

        async function deleteAnnouncement(announcementId) {
            if (confirm('確定要刪除此公告嗎？')) {
                const result = await API.admin.deleteAnnouncement(announcementId);
                if (result.success) loadAnnouncements();
            }
        }

        // Modals
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function openCreateAnnouncementModal() {
            document.getElementById('createAnnouncementForm').reset();
            openModal('createAnnouncementModal');
        }

        // 切換價格欄位顯示
        function togglePriceField(pricingModel) {
            const priceGroup = document.getElementById('priceFieldGroup');
            if (pricingModel === 'free') {
                priceGroup.style.display = 'none';
            } else {
                priceGroup.style.display = 'block';
            }
        }

        // 開啟新增教材 Modal
        function openCreateResourceModal() {
            document.getElementById('createResourceForm').reset();
            document.getElementById('resourceModalTitle').textContent = '新增教材';
            document.querySelector('#createResourceForm [name="resourceId"]').value = '';
            document.getElementById('priceFieldGroup').style.display = 'block';
            openModal('createResourceModal');
        }

        // 開啟編輯教材 Modal
        function openEditResourceModal(resource) {
            const form = document.getElementById('createResourceForm');
            form.reset();
            document.getElementById('resourceModalTitle').textContent = '編輯教材';

            // 填入現有資料
            form.querySelector('[name="resourceId"]').value = resource.resourceId;
            form.querySelector('[name="title"]').value = resource.title || '';
            form.querySelector('[name="description"]').value = resource.description || '';
            form.querySelector('[name="type"]').value = resource.type || 'video';
            form.querySelector('[name="category"]').value = resource.category || 'math';
            form.querySelector('[name="gradeLevel"]').value = resource.gradeLevel || 'junior';
            form.querySelector('[name="duration"]').value = resource.duration || '';
            form.querySelector('[name="unitCount"]').value = resource.unitCount || '';
            form.querySelector('[name="tags"]').value = (resource.tags || []).join(', ');
            form.querySelector('[name="pricingModel"]').value = resource.pricingModel || 'license';
            form.querySelector('[name="price"]').value = resource.price || '';
            form.querySelector('[name="status"]').value = resource.status || 'draft';

            // 目標受眾
            const audiences = resource.targetAudience || ['educator', 'student'];
            form.querySelectorAll('[name="targetAudience"]').forEach(cb => {
                cb.checked = audiences.includes(cb.value);
            });

            togglePriceField(resource.pricingModel || 'license');
            openModal('createResourceModal');
        }

        async function submitResourceForm() {
            const form = document.getElementById('createResourceForm');
            const formData = new FormData(form);

            // 收集目標受眾（多選）
            const targetAudience = [];
            form.querySelectorAll('[name="targetAudience"]:checked').forEach(cb => {
                targetAudience.push(cb.value);
            });

            // 處理標籤
            const tagsStr = formData.get('tags') || '';
            const tags = tagsStr.split(',').map(t => t.trim()).filter(t => t);

            const data = {
                title: formData.get('title'),
                description: formData.get('description'),
                type: formData.get('type'),
                category: formData.get('category'),
                gradeLevel: formData.get('gradeLevel'),
                duration: formData.get('duration') ? parseInt(formData.get('duration')) : null,
                unitCount: formData.get('unitCount') ? parseInt(formData.get('unitCount')) : null,
                tags: tags,
                pricingModel: formData.get('pricingModel'),
                price: formData.get('price') ? parseInt(formData.get('price')) : null,
                targetAudience: targetAudience,
                status: formData.get('status')
            };

            const resourceId = formData.get('resourceId');
            let result;

            if (resourceId) {
                // 編輯模式
                result = await API.admin.updateResource(resourceId, data);
            } else {
                // 新增模式
                result = await API.admin.createResource(data);
            }

            if (result.success) {
                closeModal('createResourceModal');
                loadResources();
            } else {
                alert(result.message || '操作失敗');
            }
        }

        async function submitCreateAnnouncement() {
            const form = document.getElementById('createAnnouncementForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const result = await API.admin.createAnnouncement(data);
            if (result.success) {
                closeModal('createAnnouncementModal');
                loadAnnouncements();
            } else {
                alert(result.message || '發布失敗');
            }
        }

        function openCreateUserModal() {
            document.getElementById('createUserForm').reset();
            openModal('createUserModal');
        }

        async function submitCreateUser() {
            const form = document.getElementById('createUserForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Validate
            if (!data.displayName || !data.email || !data.password) {
                alert('請填寫所有必填欄位');
                return;
            }

            if (data.password.length < 6) {
                alert('密碼至少需要 6 個字元');
                return;
            }

            try {
                const result = await API.admin.createUser(data);
                if (result.success) {
                    closeModal('createUserModal');
                    loadUsers();
                    alert('用戶已成功建立！');
                } else {
                    alert(result.message || '建立用戶失敗');
                }
            } catch (error) {
                console.error('Create user error:', error);
                alert('建立用戶失敗，請稍後再試');
            }
        }

        // Helpers
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-TW');
        }

        // Navigation
        document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', () => showView(item.dataset.view));
        });

        // ========== 客服中心功能 ==========

        // HTML 轉義函數
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 格式化時間
        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();

            if (isToday) {
                return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' }) + ' ' +
                       date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // 顯示提示訊息
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem;
                background: ${type === 'error' ? '#dc3545' : '#28a745'}; color: white;
                border-radius: 8px; z-index: 10000; animation: slideIn 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // 初始化管理員 WebSocket
        function initAdminSocket() {
            const token = localStorage.getItem('accessToken');
            if (!token) return;

            try {
                adminSocket = io({
                    auth: { token },
                    transports: ['websocket', 'polling']
                });

                adminSocket.on('connected', (data) => {
                    console.log('[Admin Chat] WebSocket 連線成功:', data);
                });

                adminSocket.on('chat:joined', (data) => {
                    console.log('[Admin Chat] 已加入聊天室:', data);
                    renderAdminMessages(data.messages);
                    updateAdminChatHeader(data.chatRoom);
                });

                adminSocket.on('message:new', (message) => {
                    console.log('[Admin Chat] 收到新訊息:', message);
                    if (message.chatId === currentAdminChatId) {
                        appendAdminMessage(message);
                        scrollAdminChatToBottom();
                        adminSocket.emit('message:read', { chatId: currentAdminChatId });
                    }
                    loadAdminChatRooms();

                    // 瀏覽器通知
                    if (message.senderRole === 'user' && document.hidden) {
                        showAdminNotification('用戶訊息', `${message.senderName}: ${message.content}`);
                    }
                });

                adminSocket.on('typing:indicator', (data) => {
                    if (data.chatId === currentAdminChatId) {
                        showAdminTypingIndicator(data.isTyping, data.userName);
                    }
                });

                adminSocket.on('queue:update', () => {
                    loadAdminChatRooms();
                });

                adminSocket.on('queue:message', (data) => {
                    loadAdminChatRooms();
                    showAdminNotification('新客服請求', `${data.userName}: ${data.message}`);
                });

                adminSocket.on('chat:closed', (data) => {
                    if (data.chatId === currentAdminChatId) {
                        appendAdminSystemMessage('對話已結束');
                        document.getElementById('adminChatInput').style.display = 'none';
                    }
                    loadAdminChatRooms();
                });

                adminSocket.on('disconnect', () => {
                    console.log('[Admin Chat] WebSocket 斷線');
                });

            } catch (error) {
                console.error('[Admin Chat] WebSocket 初始化失敗:', error);
            }
        }

        // 載入客服聊天室列表
        async function loadAdminChatRooms() {
            try {
                const response = await API.request('/chat/admin/rooms');
                if (response.success) {
                    adminChatRooms = response.data;
                    renderAdminChatQueue();
                    updateSupportStats(response.counts);
                }
            } catch (error) {
                console.error('[Admin Chat] 載入聊天室失敗:', error);
            }
        }

        // 更新客服統計
        function updateSupportStats(counts) {
            const waitingCountEl = document.getElementById('waitingChatsCount');
            const activeCountEl = document.getElementById('activeChatsCount');
            const closedCountEl = document.getElementById('closedChatsCount');
            const avgRatingEl = document.getElementById('avgChatRating');
            const waitingTabEl = document.getElementById('waitingTabCount');
            const activeTabEl = document.getElementById('activeTabCount');
            const badgeEl = document.getElementById('waitingChatsBadge');

            // 需處理的對話數（等待中 + 有未讀的進行中）
            const needsAttention = counts?.needsAttention || counts?.waiting || 0;

            // 更新卡片統計
            if (waitingCountEl) waitingCountEl.textContent = needsAttention;  // 需處理數量
            if (activeCountEl) activeCountEl.textContent = counts?.active || 0;
            if (closedCountEl) closedCountEl.textContent = counts?.closed || 0;
            if (avgRatingEl) avgRatingEl.textContent = counts?.avgRating || '-';

            // 更新標籤和徽章
            if (waitingTabEl) waitingTabEl.textContent = `(${needsAttention})`;
            if (activeTabEl) activeTabEl.textContent = `(${counts?.active || 0})`;
            if (badgeEl) badgeEl.textContent = needsAttention;
        }

        // 切換客服標籤
        function switchSupportTab(btn, filter) {
            currentSupportFilter = filter;
            document.querySelectorAll('.support-tab').forEach(t => {
                t.classList.remove('active');
                t.style.background = 'var(--gray-100)';
                t.style.color = 'var(--gray-600)';
            });
            btn.classList.add('active');
            btn.style.background = 'var(--terracotta)';
            btn.style.color = 'white';
            renderAdminChatQueue();
        }

        // 渲染客服隊列
        function renderAdminChatQueue() {
            const container = document.getElementById('adminChatQueue');
            if (!container) return;

            const filteredRooms = adminChatRooms.filter(r => {
                if (currentSupportFilter === 'waiting') {
                    // 「需處理」分類：等待中 + 有未讀訊息的進行中對話
                    return r.status === 'waiting' || (r.status === 'active' && (r.unreadCount || 0) > 0);
                }
                if (currentSupportFilter === 'active') {
                    // 「進行中」分類：只顯示已讀的進行中對話（排除有未讀訊息的）
                    return r.status === 'active' && (r.unreadCount || 0) === 0;
                }
                if (currentSupportFilter === 'closed') return r.status === 'closed';
                return true;
            });

            if (filteredRooms.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem 1rem; color: var(--gray-400);">
                        <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom: 0.5rem; opacity: 0.5;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        <p style="font-size: 0.85rem;">沒有${currentSupportFilter === 'waiting' ? '需處理' : currentSupportFilter === 'active' ? '進行中' : '已結束'}的對話</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredRooms.map(room => {
                const isActive = room.chatId === currentAdminChatId;
                const waitTime = getWaitTime(room.createdAt);
                const avatar = room.userName ? room.userName.charAt(0).toUpperCase() : 'U';

                return `
                    <div class="queue-item ${isActive ? 'active' : ''}" onclick="openAdminChat('${room.chatId}')">
                        <div class="queue-user">
                            <span class="status-dot ${room.status}"></span>
                            <span>${escapeHtml(room.userName || '用戶')}</span>
                        </div>
                        <div class="queue-preview">${escapeHtml(room.lastMessage || room.topic || '尚無訊息')}</div>
                        <div class="queue-time">${room.status === 'waiting' ? '等候 ' + waitTime : formatTime(room.lastMessageAt)}</div>
                    </div>
                `;
            }).join('');
        }

        // 計算等候時間
        function getWaitTime(createdAt) {
            const created = new Date(createdAt);
            const now = new Date();
            const diff = Math.floor((now - created) / 1000 / 60);
            if (diff < 1) return '剛剛';
            if (diff < 60) return diff + ' 分鐘';
            return Math.floor(diff / 60) + ' 小時';
        }

        // 開啟管理員聊天
        function openAdminChat(chatId) {
            if (currentAdminChatId && adminSocket) {
                adminSocket.emit('chat:leave', { chatId: currentAdminChatId });
            }

            currentAdminChatId = chatId;

            // 更新 UI（添加空值檢查）
            const welcomeEl = document.getElementById('adminChatWelcome');
            const headerEl = document.getElementById('adminChatHeader');
            const messagesEl = document.getElementById('adminChatMessages');

            if (welcomeEl) welcomeEl.style.display = 'none';
            if (headerEl) headerEl.style.display = 'block';
            if (messagesEl) messagesEl.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-400);">載入訊息中...</div>';

            const room = adminChatRooms.find(r => r.chatId === chatId);
            if (room) {
                updateAdminChatHeader(room);
            }

            if (adminSocket) {
                adminSocket.emit('chat:join', { chatId });
            }

            renderAdminChatQueue();
        }

        // 更新聊天視窗標題
        function updateAdminChatHeader(room) {
            const avatar = room.userName ? room.userName.charAt(0).toUpperCase() : 'U';
            const avatarEl = document.getElementById('adminChatUserAvatar');
            const nameEl = document.getElementById('adminChatUserName');
            const emailEl = document.getElementById('adminChatUserEmail');
            const claimBtn = document.getElementById('claimChatBtn');
            const inputEl = document.getElementById('adminChatInput');

            if (avatarEl) avatarEl.textContent = avatar;
            if (nameEl) nameEl.textContent = room.userName || '用戶';
            if (emailEl) emailEl.textContent = room.userEmail || '';

            if (room.status === 'waiting') {
                if (claimBtn) claimBtn.style.display = 'block';
                if (inputEl) inputEl.style.display = 'none';
            } else if (room.status === 'active') {
                if (claimBtn) claimBtn.style.display = 'none';
                if (inputEl) inputEl.style.display = 'block';
            } else {
                if (claimBtn) claimBtn.style.display = 'none';
                if (inputEl) inputEl.style.display = 'none';
            }
        }

        // 渲染管理員聊天訊息
        function renderAdminMessages(messages) {
            const container = document.getElementById('adminChatMessages');
            if (!container) return;

            if (!messages || messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-400);">尚無訊息</div>';
                return;
            }

            container.innerHTML = messages.map(msg => createAdminMessageHTML(msg)).join('');
            scrollAdminChatToBottom();
        }

        // 創建管理員視角訊息 HTML
        function createAdminMessageHTML(msg) {
            const isAdmin = msg.senderRole === 'admin';
            const isSystem = msg.senderRole === 'system' || msg.messageType === 'system';
            const time = formatTime(msg.createdAt);

            if (isSystem) {
                return `<div class="chat-message system"><div class="chat-bubble">${escapeHtml(msg.content)}</div></div>`;
            }

            return `
                <div class="chat-message ${isAdmin ? 'admin' : 'user'}">
                    <div>
                        ${!isAdmin ? `<div class="chat-sender">${escapeHtml(msg.senderName)}</div>` : ''}
                        <div class="chat-bubble">${escapeHtml(msg.content)}</div>
                        <div class="chat-time">${time}</div>
                    </div>
                </div>
            `;
        }

        // 附加管理員訊息
        function appendAdminMessage(msg) {
            const container = document.getElementById('adminChatMessages');
            if (!container) return;
            const emptyHint = container.querySelector('div[style*="text-align: center"]');
            if (emptyHint) emptyHint.remove();
            container.insertAdjacentHTML('beforeend', createAdminMessageHTML(msg));
        }

        // 附加系統訊息
        function appendAdminSystemMessage(content) {
            const container = document.getElementById('adminChatMessages');
            if (!container) return;
            container.insertAdjacentHTML('beforeend', `<div class="chat-message system"><div class="chat-bubble">${escapeHtml(content)}</div></div>`);
            scrollAdminChatToBottom();
        }

        // 接手對話
        async function adminClaimChat() {
            if (!currentAdminChatId) return;

            // 請求通知權限（用戶點擊觸發）
            requestAdminNotificationPermission();

            try {
                const response = await API.request(`/chat/admin/rooms/${currentAdminChatId}/claim`, {
                    method: 'PUT'
                });

                if (response.success) {
                    showToast('已接手對話');
                    document.getElementById('claimChatBtn').style.display = 'none';
                    document.getElementById('adminChatInput').style.display = 'block';
                    loadAdminChatRooms();
                }
            } catch (error) {
                console.error('[Admin Chat] 接手對話失敗:', error);
                showToast('接手對話失敗', 'error');
            }
        }

        // 結束對話
        function adminCloseChat() {
            if (!currentAdminChatId) return;

            if (confirm('確定要結束這個對話嗎？')) {
                if (adminSocket) {
                    adminSocket.emit('chat:close', { chatId: currentAdminChatId });
                }
            }
        }

        // 發送管理員訊息
        function sendAdminMessage() {
            const input = document.getElementById('adminMessageInput');
            const content = input.value.trim();

            if (!content || !currentAdminChatId) return;

            if (adminSocket) {
                adminSocket.emit('message:send', {
                    chatId: currentAdminChatId,
                    content: content,
                    messageType: 'text'
                });
                adminSocket.emit('typing:stop', { chatId: currentAdminChatId });
            }

            input.value = '';
            input.style.height = 'auto';
        }

        // 處理管理員輸入框按鍵
        function handleAdminChatKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminMessage();
            }
        }

        // 處理管理員輸入事件
        function handleAdminChatInput(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

            if (adminSocket && currentAdminChatId) {
                adminSocket.emit('typing:start', { chatId: currentAdminChatId });
                clearTimeout(adminTypingTimeout);
                adminTypingTimeout = setTimeout(() => {
                    adminSocket.emit('typing:stop', { chatId: currentAdminChatId });
                }, 2000);
            }
        }

        // 顯示打字提示
        function showAdminTypingIndicator(isTyping, userName) {
            const indicator = document.getElementById('adminTypingIndicator');
            const userSpan = document.getElementById('adminTypingUser');
            if (indicator && userSpan) {
                indicator.style.display = isTyping ? 'block' : 'none';
                userSpan.textContent = `${userName} 正在輸入...`;
            }
        }

        // 捲動到底部
        function scrollAdminChatToBottom() {
            const container = document.getElementById('adminChatMessages');
            if (container) container.scrollTop = container.scrollHeight;
        }

        // 瀏覽器通知
        function showAdminNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body, icon: '/platform/img/logo.png' });
            }
        }

        // 請求通知權限（由用戶互動觸發）
        function requestAdminNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Check auth on load - 如果未登入或非管理員，跳轉到主平台
        if (API.isLoggedIn() && API.isAdmin()) {
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'flex';
            const user = API.getCurrentUser();
            if (user) document.getElementById('adminName').textContent = user.displayName;
            loadDashboard();
            initAdminSocket();
            // 載入客服聊天室以更新側邊欄徽章
            loadAdminChatRooms();
        } else {
            // 未登入或非管理員，跳轉到主平台登入頁面
            window.location.href = '/platform/';
        }
    </script>
</body>
</html>
